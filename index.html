<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRB Pulse</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --drb-orange: #f04e23; --drb-navy: #1E2A3A; --drb-charcoal: #333333;
            --drb-blue: #3B82F6; --drb-green: #10B981; --drb-red: #EF4444; --drb-yellow: #F59E0B;
            --drb-purple: #8B5CF6; --drb-teal: #14B8A6;
            --gray-50: #F8FAFC; --gray-100: #F1F5F9; --gray-200: #E2E8F0; --gray-400: #94A3B8;
            --gray-500: #64748B; --gray-600: #475569; --gray-700: #334155; --gray-800: #1E293B;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--gray-50); color: var(--gray-800); line-height: 1.5; }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background-color: var(--drb-navy); padding: 1.5rem 1rem; position: fixed; height: 100vh; overflow-y: auto; }
        .logo { display: flex; align-items: center; gap: 0.75rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 1.5rem; }
        .logo-text { font-size: 1.5rem; font-weight: 700; color: var(--drb-orange); }
        .logo-subtitle { color: rgba(255,255,255,0.5); font-size: 0.75rem; }
        .nav-section-title { color: rgba(255,255,255,0.4); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem; }
        .nav-item { display: block; width: 100%; padding: 0.65rem 0.75rem; margin: 0.1rem 0; border: none; border-radius: 0.5rem; background: transparent; color: rgba(255,255,255,0.7); font-size: 0.875rem; font-weight: 500; text-align: left; cursor: pointer; transition: all 0.15s ease; }
        .nav-item:hover { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.95); }
        .nav-item.active { background: rgba(240,78,35,0.15); color: #f04e23; border-left: 3px solid #f04e23; }
        .sidebar-divider { border-top: 1px solid rgba(255,255,255,0.1); margin: 1rem 0; }
        .user-info { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--drb-orange); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem; }
        .user-name { color: white; font-size: 0.875rem; font-weight: 500; }
        .user-role { color: rgba(255,255,255,0.5); font-size: 0.75rem; }
        .main-content { flex: 1; margin-left: 260px; padding: 2rem; min-height: 100vh; }
        .page { display: none; } .page.active { display: block; }
        h1 { font-size: 1.75rem; font-weight: 700; color: var(--drb-navy); margin-bottom: 0.25rem; }
        h2 { font-size: 1.25rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1rem; }
        h3 { font-size: 1rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.75rem; }
        .page-subtitle { color: var(--gray-500); font-size: 0.875rem; margin-bottom: 1.5rem; }
        .card { background: white; border: 1px solid var(--gray-200); border-radius: 0.75rem; padding: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .card-grid-4 { grid-template-columns: repeat(4, 1fr); }
        .card-grid-3 { grid-template-columns: repeat(3, 1fr); }
        .card-grid-5 { grid-template-columns: repeat(5, 1fr); }
        .card-grid-6 { grid-template-columns: repeat(6, 1fr); }
        .status-card { border-radius: 1rem; padding: 1.25rem; border-left: 4px solid; }
        .status-card.green { background: linear-gradient(135deg, #ECFDF5, #D1FAE5); border-left-color: var(--drb-green); }
        .status-card.blue { background: linear-gradient(135deg, #EFF6FF, #DBEAFE); border-left-color: var(--drb-blue); }
        .status-card.yellow { background: linear-gradient(135deg, #FFFBEB, #FEF3C7); border-left-color: var(--drb-yellow); }
        .status-card.red { background: linear-gradient(135deg, #FEF2F2, #FEE2E2); border-left-color: var(--drb-red); }
        .status-card-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; margin-bottom: 0.25rem; }
        .status-card.green .status-card-label { color: #059669; } .status-card.blue .status-card-label { color: #2563EB; }
        .status-card.yellow .status-card-label { color: #D97706; } .status-card.red .status-card-label { color: #DC2626; }
        .status-card-value { font-size: 2.5rem; font-weight: 700; line-height: 1.1; }
        .status-card.green .status-card-value { color: #065F46; } .status-card.blue .status-card-value { color: #1E40AF; }
        .status-card.yellow .status-card-value { color: #92400E; } .status-card.red .status-card-value { color: #991B1B; }
        .status-card-footer { font-size: 0.8rem; margin-top: 0.25rem; }
        .status-card.green .status-card-footer { color: #047857; } .status-card.blue .status-card-footer { color: #1D4ED8; }
        .status-card.yellow .status-card-footer { color: #B45309; } .status-card.red .status-card-footer { color: #B91C1C; }
        .kpi-card { text-align: center; padding: 1rem; }
        .kpi-value { font-size: 1.75rem; font-weight: 700; color: var(--gray-800); }
        .kpi-value.green { color: var(--drb-green); } .kpi-value.red { color: var(--drb-red); } .kpi-value.yellow { color: var(--drb-yellow); } .kpi-value.blue { color: var(--drb-blue); } .kpi-value.purple { color: var(--drb-purple); } .kpi-value.teal { color: var(--drb-teal); }
        .kpi-label { font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem; }
        .kpi-sublabel { font-size: 0.7rem; color: var(--gray-400); margin-top: 0.15rem; }
        .metric-card { background: white; border: 1px solid var(--gray-200); border-radius: 0.5rem; padding: 1rem; border-left: 4px solid var(--gray-200); }
        .metric-card.critical { border-left-color: var(--drb-red); } .metric-card.warning { border-left-color: var(--drb-orange); }
        .metric-card.info { border-left-color: var(--drb-blue); } .metric-card.success { border-left-color: var(--drb-green); }
        .metric-label { font-size: 0.75rem; color: var(--gray-500); }
        .metric-value { font-size: 1.75rem; font-weight: 700; }
        .metric-card.critical .metric-value { color: #DC2626; } .metric-card.warning .metric-value { color: #EA580C; }
        .metric-card.info .metric-value { color: #2563EB; } .metric-card.success .metric-value { color: #059669; }
        .customer-header { background: linear-gradient(135deg, #FFFFFF, #F8FAFC); border: 1px solid var(--gray-200); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .customer-info h2 { margin-bottom: 0.25rem; } .customer-meta { color: var(--gray-500); font-size: 0.875rem; }
        .customer-stats { display: flex; gap: 2rem; } .customer-stat { text-align: center; }
        .customer-stat-label { font-size: 0.7rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em; }
        .customer-stat-value { font-size: 1.75rem; font-weight: 700; }
        .customer-stat-value.green { color: var(--drb-green); } .customer-stat-value.yellow { color: var(--drb-yellow); } .customer-stat-value.red { color: var(--drb-red); }
        .table-container { overflow-x: auto; margin-top: 1rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th { background: var(--gray-50); padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200); }
        td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--gray-100); }
        tr:hover { background: var(--gray-50); }
        .badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
        .badge.critical { background: #FEE2E2; color: #DC2626; } .badge.warning { background: #FFEDD5; color: #EA580C; }
        .badge.healthy, .badge.success { background: #D1FAE5; color: #059669; } .badge.info { background: #DBEAFE; color: #2563EB; }
        .form-row { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label { display: block; font-size: 0.75rem; font-weight: 500; color: var(--gray-600); margin-bottom: 0.25rem; }
        select, input[type="text"], input[type="number"] { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--gray-200); border-radius: 0.5rem; font-size: 0.875rem; background: white; }
        select:focus, input:focus { outline: none; border-color: var(--drb-orange); box-shadow: 0 0 0 3px rgba(242,101,34,0.1); }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.15s ease; }
        .btn-primary { background: var(--drb-orange); color: white; } .btn-primary:hover { background: #E55A1B; }
        .btn-secondary { background: var(--gray-100); color: var(--gray-700); } .btn-secondary:hover { background: var(--gray-200); }
        .chart-container { position: relative; height: 280px; width: 100%; margin-top: 1rem; }
        .chart-container.small { height: 200px; }
        .chart-container.tall { height: 340px; }
        .health-bar { width:100%;height:6px;border-radius:3px;background:var(--gray-200);margin-top:4px;overflow:hidden }
        .health-bar-fill { height:100%;border-radius:3px;transition:width 0.3s }
        #org-suggestions .org-item { padding:8px 12px;cursor:pointer;font-size:0.85rem;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center }
        #org-suggestions .org-item:hover { background:#f0f4ff }
        #org-suggestions .org-item .org-code { font-family:monospace;font-size:0.8rem;color:var(--gray-500) }
        #org-suggestions .org-item .org-type { font-size:0.7rem;padding:2px 6px;border-radius:3px;text-transform:uppercase;font-weight:600 }
        #org-suggestions .org-item .org-type.org-tag { background:#DBEAFE;color:#1E40AF }
        #org-suggestions .org-item .org-type.site-tag { background:#D1FAE5;color:#065F46 }
        .cfg-tab.active { color:#1a4797 !important;border-bottom-color:#1a4797 !important }
        .cfg-panel { display:none } .cfg-panel.active { display:block }
        .cfg-input { padding:0.35rem 0.5rem;border:1px solid var(--gray-200);border-radius:0.375rem;font-size:0.8rem;outline:none;background:white }
        .cfg-input:focus { border-color:#3B82F6;box-shadow:0 0 0 2px rgba(59,130,246,0.1) }
        .btn-icon { background:none;border:none;cursor:pointer;font-size:1.2rem;color:var(--gray-500);padding:0 4px;line-height:1 }
        .btn-icon:hover { color:#EF4444 }
        input[type="range"] { height:6px;border-radius:3px }

        .chart-container canvas { width: 100% !important; height: 100% !important; }
        .charts-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem; }
        .alert-card { border-left: 4px solid; padding: 1rem 1.25rem; border-radius: 0.75rem; margin-bottom: 0.75rem; background: white; transition: all 0.3s ease; }
        .alert-card.resolving { opacity: 0; transform: translateX(30px); max-height: 0; padding: 0 1.25rem; margin-bottom: 0; overflow: hidden; }
        .alert-actions { margin-top: 0.5rem; display: flex; align-items: center; }
        .btn-resolve { padding: 0.35rem 0.85rem; border: 1px solid var(--drb-green); border-radius: 0.5rem; background: #ECFDF5; color: #059669; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.15s ease; }
        .btn-resolve:hover { background: var(--drb-green); color: white; }
        .no-alerts { text-align: center; padding: 3rem 1rem; color: var(--gray-400); font-size: 1rem; }
        .alert-card.critical { border-left-color: var(--drb-red); background: linear-gradient(135deg, #FEF2F2, #FFFFFF); }
        .alert-card.warning { border-left-color: var(--drb-orange); background: linear-gradient(135deg, #FFF7ED, #FFFFFF); }
        .alert-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .alert-title { font-weight: 600; color: var(--gray-800); }
        .alert-customer { color: var(--gray-600); font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; }
        .alert-message { color: var(--gray-500); font-size: 0.85rem; }
        .benchmark-card { background: white; border: 1px solid var(--gray-200); border-radius: 1rem; padding: 1.5rem; }
        .benchmark-card h3 { margin-bottom: 1rem; }
        .benchmark-row { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--gray-100); }
        .benchmark-row:last-child { border-bottom: none; }
        .benchmark-label { color: var(--gray-500); } .benchmark-value { font-weight: 600; color: var(--gray-800); }
        .benchmark-value.green { color: var(--drb-green); } .benchmark-value.red { color: var(--drb-red); }
        .footer { text-align: center; padding: 1.5rem; border-top: 1px solid var(--gray-100); color: var(--gray-400); font-size: 0.8rem; margin-top: 2rem; }

        /* Deep Dive Tab Styles */
        .dd-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .dd-tab { padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.15s ease; background: var(--gray-100); color: var(--gray-700); }
        .dd-tab:hover { background: var(--gray-200); }
        .dd-tab.active { background: var(--drb-orange); color: white; }
        .dd-panel { display: none; }
        .dd-panel.active { display: block; }
        .insight-box { background: linear-gradient(135deg, #FFF7ED, #FFFFFF); border: 1px solid #FDBA74; border-radius: 0.75rem; padding: 1rem 1.25rem; margin-bottom: 1.5rem; }
        .insight-box p { color: var(--gray-600); font-size: 0.875rem; line-height: 1.6; }
        .insight-box .insight-title { font-weight: 600; color: var(--drb-orange); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.35rem; }
        .section-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; margin-top: 1.5rem; }
        .section-header h2 { margin-bottom: 0; }
        .section-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .section-icon.orange { background: #FFF7ED; color: var(--drb-orange); }
        .section-icon.blue { background: #EFF6FF; color: var(--drb-blue); }
        .section-icon.green { background: #ECFDF5; color: var(--drb-green); }
        .section-icon.red { background: #FEF2F2; color: var(--drb-red); }
        .section-icon.purple { background: #F5F3FF; color: var(--drb-purple); }
        .cohort-table { font-size: 0.8rem; }
        .cohort-table th, .cohort-table td { padding: 0.5rem 0.65rem; text-align: center; }
        .cohort-table .cohort-header { background: var(--drb-navy); color: white; font-size: 0.75rem; }
        .cohort-cell { border-radius: 4px; }

        @media (max-width: 768px) { .sidebar { width: 100%; height: auto; position: relative; } .main-content { margin-left: 0; } .card-grid-4, .card-grid-5, .card-grid-6 { grid-template-columns: repeat(2, 1fr); } .charts-row { grid-template-columns: 1fr; } }
    </style>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo" style="display:flex;align-items:center;gap:10px;padding:0.5rem 0;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 84 74" style="height:44px;width:auto;flex-shrink:0">
  <g><path style="fill:#f04e23" d="M72,11.7v14.54h4V11.71c0-2.21-1.79-4-4-4H57.46v4H72Z"/>
  <g style="fill:#ffffff"><path d="M16.89,16.98H8v36.9h8.88c4.08,0,8.77-.76,8.77-6.66V23.64c0-5.91-4.68-6.66-8.77-6.66Zm-2.83,4.27h2.83c1.8,0,2.71.81,2.71,2.4v23.57c0,1.59-.91,2.4-2.71,2.4h-2.83V21.24Z"/><path d="M45.78,32.6V23.64c0-5.91-4.68-6.66-8.77-6.66H28.42v36.9h6.05V40.34h1.54l5.24,13.54h6.23l-5.55-14.23c2.61-1.04,3.83-3.3,3.83-7.05Zm-11.3-11.36h2.54c1.8,0,2.71.81,2.71,2.4v10.19c0,1.59-.91,2.4-2.71,2.4h-2.54V21.24Z"/><path d="M63.04,34.98c2.2-1.02,3.31-2.96,3.31-5.78V23.64c0-5.91-4.68-6.66-8.77-6.66H49v36.9h8.88c4.08,0,8.77-.76,8.77-6.66v-6.33c0-3-1.18-4.94-3.6-5.9Zm-2.75-4.55c0,1.59-.91,2.4-2.71,2.4h-2.54V21.24h2.54c1.8,0,2.71.81,2.71,2.4v6.79Zm-5.25,6.51h2.83c1.8,0,2.71.81,2.71,2.4v7.88c0,1.59-.91,2.4-2.71,2.4h-2.83V36.94Z"/></g></g>
</svg>
                <div style="display:flex;align-items:center;gap:0">
  <span style="font-family:'Orbitron',sans-serif;font-size:22px;font-weight:900;color:#f04e23;letter-spacing:4px">PULSE</span>
  <svg viewBox="0 0 200 30" style="height:22px;width:auto;margin-left:4px;overflow:visible">
    <defs>
      <clipPath id="pulse-reveal"><rect x="0" y="0" width="0" height="30">
        <animate attributeName="width" from="0" to="200" dur="4s" repeatCount="indefinite"/>
      </rect></clipPath>
    </defs>
    <g clip-path="url(#pulse-reveal)">
      <line x1="0" y1="15" x2="12" y2="15" stroke="#f04e23" stroke-width="2.5" stroke-linecap="round"/>
      <path d="M12,15 L16,3 L20,27 L24,15" fill="none" stroke="#f04e23" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="24" y1="15" x2="50" y2="15" stroke="#f04e23" stroke-width="2.5" stroke-linecap="round"/>
      <path d="M50,15 L54,3 L58,27 L62,15" fill="none" stroke="#f04e23" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="62" y1="15" x2="88" y2="15" stroke="#f04e23" stroke-width="2.5" stroke-linecap="round"/>
      <path d="M88,15 L92,3 L96,27 L100,15" fill="none" stroke="#f04e23" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="100" y1="15" x2="120" y2="15" stroke="#f04e23" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="120" y1="15" x2="200" y2="15" stroke="#f04e23" stroke-width="1.5" stroke-dasharray="2,4" opacity="0.25" stroke-linecap="round"/>
    </g>
  </svg>
</div>
            </div>
            <p class="nav-section-title">Dashboard</p>
            <nav>
                <button class="nav-item active" data-page="portfolio" onclick="switchPage('portfolio',this)">Portfolio Overview</button>
                <button class="nav-item" data-page="operational" onclick="switchPage('operational',this)">Operational Health</button>
                <button class="nav-item" data-page="alerts" onclick="switchPage('alerts',this)">Risk Alerts</button>
                <button class="nav-item" data-page="boap" onclick="switchPage('boap',this)">Business on a Page</button>
                <button class="nav-item" data-page="deepdive" onclick="switchPage('deepdive',this)">Deep Dive</button>
                <button class="nav-item" data-page="benchmarks" onclick="switchPage('benchmarks',this)">Industry Benchmarks</button>
                <button class="nav-item" data-page="roi" onclick="switchPage('roi',this)">ROI &amp; Solutions</button>
                <button class="nav-item" data-page="settings" onclick="switchPage('settings',this)">Configuration</button>
            </nav>
            <div class="sidebar-divider"></div>
            <div class="user-info">
                <div class="user-avatar">MJ</div>
                <div><div class="user-name">Mike Johnson</div><div class="user-role">Customer Success</div></div>
            </div>
        </aside>
        <main class="main-content">
            <!-- ==================== PORTFOLIO ==================== -->
            <div id="portfolio" class="page active">
                <h1>Portfolio Health</h1><p class="page-subtitle">Performance vs. industry benchmarks</p>
                <div class="card-grid card-grid-4">
                    <div class="status-card green"><div class="status-card-label">Outperforming</div><div class="status-card-value">2</div><div class="status-card-footer">33% of portfolio</div></div>
                    <div class="status-card blue"><div class="status-card-label">On Track</div><div class="status-card-value">1</div><div class="status-card-footer">17% of portfolio</div></div>
                    <div class="status-card yellow"><div class="status-card-label">Needs Attention</div><div class="status-card-value">2</div><div class="status-card-footer">33% of portfolio</div></div>
                    <div class="status-card red"><div class="status-card-label">Critical</div><div class="status-card-value">1</div><div class="status-card-footer">17% of portfolio</div></div>
                </div>
                <div class="card">
                    <h2>Customer Overview</h2>
                    <div class="table-container"><table><thead><tr><th>Customer</th><th>Org Code</th><th>Sites</th><th>Operational</th><th>Business</th><th>Overall</th><th>Capture %</th><th>Churn %</th><th>Traffic YoY</th><th>Revenue YoY</th><th>CSM</th></tr></thead>
                    <tbody>
                        <tr><td>Sparkle Clean Auto Spa</td><td style="font-family:monospace;font-size:0.8rem">SPA-042</td><td>12</td><td><span class="badge warning">1.8</span></td><td><span class="badge critical">0.8</span></td><td><span class="badge critical">1.2</span></td><td>31%</td><td>8.2%</td><td style="color:#EF4444">-18%</td><td style="color:#EF4444">-18%</td><td>Mike Johnson</td></tr>
                        <tr><td>Metro Express Wash</td><td style="font-family:monospace;font-size:0.8rem">MEW-008</td><td>8</td><td><span class="badge info">2.6</span></td><td><span class="badge warning">2.0</span></td><td><span class="badge warning">2.3</span></td><td>35%</td><td>6.5%</td><td style="color:#EF4444">-8%</td><td style="color:#EF4444">-10%</td><td>Sarah Chen</td></tr>
                        <tr><td>Shine Time Car Wash</td><td style="font-family:monospace;font-size:0.8rem">STC-005</td><td>5</td><td><span class="badge healthy">3.8</span></td><td><span class="badge healthy">3.5</span></td><td><span class="badge healthy">3.6</span></td><td>42%</td><td>4.2%</td><td style="color:#10B981">+5%</td><td style="color:#10B981">+6%</td><td>Mike Johnson</td></tr>
                        <tr><td>Quick Clean Express</td><td style="font-family:monospace;font-size:0.8rem">QCE-118</td><td>156</td><td><span class="badge healthy">3.8</span></td><td><span class="badge info">3.2</span></td><td><span class="badge healthy">3.5</span></td><td>33%</td><td>7.1%</td><td style="color:#EF4444">-12%</td><td style="color:#EF4444">-14%</td><td>Tom Wilson</td></tr>
                        <tr><td>Premier Auto Spa</td><td style="font-family:monospace;font-size:0.8rem">PAS-200</td><td>234</td><td><span class="badge healthy">4.5</span></td><td><span class="badge healthy">4.0</span></td><td><span class="badge healthy">4.2</span></td><td>48%</td><td>3.8%</td><td style="color:#10B981">+12%</td><td style="color:#10B981">+14%</td><td>Sarah Chen</td></tr>
                        <tr><td>Crystal Clear Wash</td><td style="font-family:monospace;font-size:0.8rem">CCW-045</td><td>45</td><td><span class="badge info">3.0</span></td><td><span class="badge info">2.5</span></td><td><span class="badge info">2.8</span></td><td>38%</td><td>5.9%</td><td style="color:#EF4444">-3%</td><td style="color:#EF4444">-2%</td><td>Tom Wilson</td></tr>
                    </tbody></table></div>
                </div>
            </div>

            <!-- ==================== OPERATIONAL HEALTH ==================== -->
            <div id="operational" class="page">
                <h1>Operational Health</h1><p class="page-subtitle">System performance and support metrics</p>
                <div class="form-row">
                    <div class="form-group" style="flex:2;position:relative">
                        <label>Org Code / Site Code</label>
                        <input type="text" id="org-search" placeholder="Search by org or site code..." autocomplete="off" style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--gray-200);border-radius:0.5rem;font-size:0.875rem;outline:none" onfocus="showOrgSuggestions()" oninput="filterOrgSuggestions()">
                        <input type="hidden" id="customer-select" value="bmw">
                        <div id="org-suggestions" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:1px solid var(--gray-200);border-radius:0 0 0.5rem 0.5rem;max-height:220px;overflow-y:auto;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.1)"></div>
                    </div>
                    <div class="form-group"><label>Start Date</label><input type="date" id="date-start" style="padding:0.5rem 0.75rem;border:1px solid var(--gray-200);border-radius:0.5rem;font-size:0.875rem"></div>
                    <div class="form-group"><label>End Date</label><input type="date" id="date-end" style="padding:0.5rem 0.75rem;border:1px solid var(--gray-200);border-radius:0.5rem;font-size:0.875rem"></div>
                </div>
                <div class="customer-header">
                    <div class="customer-info"><h2 id="op-customer-name">BMW Kar Wash LLC</h2><div class="customer-meta" id="op-customer-meta">BMW-001 &middot; 61 Sites &middot; MI &middot; CSM: Morgan Malone</div></div>
                    <div class="customer-stats">
                        <div class="customer-stat"><div class="customer-stat-label">Operational</div><div class="customer-stat-value" id="op-opHealth" style="font-size:1.1rem">3.40</div><div class="health-bar" id="op-opBar"></div></div>
                        <div class="customer-stat"><div class="customer-stat-label">Business</div><div class="customer-stat-value" id="op-bizHealth" style="font-size:1.1rem">2.20</div><div class="health-bar" id="op-bizBar"></div></div>
                        <div class="customer-stat" style="border-left:2px solid var(--gray-200);padding-left:1rem"><div class="customer-stat-label">Overall</div><div class="customer-stat-value" id="op-overallHealth" style="font-size:1.3rem;font-weight:800">2.80</div><div class="health-bar" id="op-overallBar"></div></div>
                    </div>
                </div>
                <h2>Summary Metrics</h2>
                <div class="card-grid card-grid-6">
                    <div class="card kpi-card"><div class="kpi-value" id="op-uptime">99.92%</div><div class="kpi-label">Uptime (30d)</div></div>
                    <div class="card kpi-card"><div class="kpi-value" id="op-total-cases">572</div><div class="kpi-label">Total Cases (30d)</div></div>
                    <div class="card kpi-card"><div class="kpi-value" id="op-open-cases">4</div><div class="kpi-label">Open Cases</div></div>
                    <div class="card kpi-card"><div class="kpi-value" id="op-avg-ttr">2.24</div><div class="kpi-label">Avg TTR (Days)</div></div>
                    <div class="card kpi-card"><div class="kpi-value" id="op-hw-swaps">3</div><div class="kpi-label">Hardware Swaps</div></div>
                    <div class="card kpi-card"><div class="kpi-value" id="op-escalations">1</div><div class="kpi-label">Escalations</div></div>
                </div>
                <div class="card" style="margin-bottom:1rem">
                    <h3>Health Score Over Time</h3>
                    <p style="font-size:0.8rem;color:var(--gray-500);margin-bottom:0.5rem">12-month trend &mdash; Operational, Business &amp; Overall health. Scale: 0 (Critical) to 5 (Excellent).</p>
                    <div class="chart-container tall"><canvas id="healthScoreChart"></canvas></div>
                </div>
                <div class="charts-row">
                    <div class="card"><h3>Case Volume by Product</h3><div class="chart-container"><canvas id="caseByProductChart"></canvas></div></div>
                    <div class="card"><h3>Monthly Case Volume</h3><div class="chart-container"><canvas id="monthlyCaseChart"></canvas></div></div>
                </div>
                <div class="charts-row">
                    <div class="card"><h3>Monthly Hardware Swaps</h3><div class="chart-container small"><canvas id="hardwareSwapsChart"></canvas></div></div>
                    <div class="card"><h3>Monthly Escalations</h3><div class="chart-container small"><canvas id="escalationsChart"></canvas></div></div>
                </div>
                <div class="card"><h2>Site-Level Details</h2>
                    <div class="table-container"><table><thead><tr><th>Site</th><th>City</th><th>Health</th><th>Uptime %</th><th>Cases (30d)</th><th>Open</th><th>HW Swaps</th><th>Escalations</th><th>CSAT</th><th>Platform</th></tr></thead><tbody id="sites-table-body"></tbody></table></div>
                </div>
            </div>

            <!-- ==================== RISK ALERTS ==================== -->
            <div id="alerts" class="page">
                <h1>Risk Alerts</h1><p class="page-subtitle">Daily task list &mdash; automated warning detection &amp; CSM assignment</p>
                <div class="card-grid card-grid-4">
                    <div class="metric-card critical"><div class="metric-label">Critical</div><div class="metric-value">4</div></div>
                    <div class="metric-card warning"><div class="metric-label">Warning</div><div class="metric-value">8</div></div>
                    <div class="metric-card info"><div class="metric-label">New (24h)</div><div class="metric-value">3</div></div>
                    <div class="metric-card success"><div class="metric-label">Resolved (7d)</div><div class="metric-value">6</div></div>
                </div>
                <div class="form-row" style="margin-bottom:1rem">
                    <div class="form-group"><label>Filter by CSM</label><select id="alert-csm-filter" onchange="filterAlerts()"><option value="all">All CSMs</option><option>Morgan Malone</option><option>Mike Johnson</option><option>Tom Wilson</option><option>Sarah Chen</option></select></div>
                    <div class="form-group"><label>Filter by Severity</label><select id="alert-sev-filter" onchange="filterAlerts()"><option value="all">All</option><option value="critical">Critical</option><option value="warning">Warning</option></select></div>
                </div>
                <div id="alerts-container">
                <div class="alert-card critical" data-csm="Mike Johnson"><div class="alert-header"><span class="alert-title">Traffic Decline</span><span class="badge critical">CRITICAL</span></div><div class="alert-customer">Sparkle Clean Auto Spa</div><div class="alert-meta" style="font-size:0.8rem;color:#64748B;margin:0.25rem 0">Assigned: <strong>Mike Johnson</strong> &middot; Detected: Feb 4, 2026</div><div class="alert-message">Traffic declined 18% YoY across all 12 sites</div><div class="alert-actions"><input type="text" placeholder="Add resolution note..." style="flex:1;padding:0.4rem 0.6rem;border:1px solid #E2E8F0;border-radius:0.375rem;font-size:0.8rem;margin-right:0.5rem" class="resolve-note"><button class="btn-resolve" onclick="resolveAlert(this)">&#10003; Resolve</button></div></div>
                <div class="alert-card critical" data-csm="Mike Johnson"><div class="alert-header"><span class="alert-title">Churn Spike</span><span class="badge critical">CRITICAL</span></div><div class="alert-customer">Sparkle Clean Auto Spa</div><div class="alert-meta" style="font-size:0.8rem;color:#64748B;margin:0.25rem 0">Assigned: <strong>Mike Johnson</strong> &middot; Detected: Feb 3, 2026</div><div class="alert-message">Voluntary churn spiked to 8.2%, up 2.7pts MoM</div><div class="alert-actions"><input type="text" placeholder="Add resolution note..." style="flex:1;padding:0.4rem 0.6rem;border:1px solid #E2E8F0;border-radius:0.375rem;font-size:0.8rem;margin-right:0.5rem" class="resolve-note"><button class="btn-resolve" onclick="resolveAlert(this)">&#10003; Resolve</button></div></div>
                <div class="alert-card warning" data-csm="Tom Wilson"><div class="alert-header"><span class="alert-title">Capture Rate Drop</span><span class="badge warning">WARNING</span></div><div class="alert-customer">Quick Clean Express</div><div class="alert-meta" style="font-size:0.8rem;color:#64748B;margin:0.25rem 0">Assigned: <strong>Tom Wilson</strong> &middot; Detected: Feb 3, 2026</div><div class="alert-message">Capture rate dropped from 41% to 35% at 3 sites</div><div class="alert-actions"><input type="text" placeholder="Add resolution note..." style="flex:1;padding:0.4rem 0.6rem;border:1px solid #E2E8F0;border-radius:0.375rem;font-size:0.8rem;margin-right:0.5rem" class="resolve-note"><button class="btn-resolve" onclick="resolveAlert(this)">&#10003; Resolve</button></div></div>
                <div class="alert-card warning" data-csm="Tom Wilson"><div class="alert-header"><span class="alert-title">Member Loss</span><span class="badge warning">WARNING</span></div><div class="alert-customer">Quick Clean Express</div><div class="alert-meta" style="font-size:0.8rem;color:#64748B;margin:0.25rem 0">Assigned: <strong>Tom Wilson</strong> &middot; Detected: Feb 2, 2026</div><div class="alert-message">Member count down 8% YoY (-340 members)</div><div class="alert-actions"><input type="text" placeholder="Add resolution note..." style="flex:1;padding:0.4rem 0.6rem;border:1px solid #E2E8F0;border-radius:0.375rem;font-size:0.8rem;margin-right:0.5rem" class="resolve-note"><button class="btn-resolve" onclick="resolveAlert(this)">&#10003; Resolve</button></div></div>
                <div class="alert-card critical" data-csm="Mike Johnson"><div class="alert-header"><span class="alert-title">Revenue Decline</span><span class="badge critical">CRITICAL</span></div><div class="alert-customer">Sparkle Clean Auto Spa</div><div class="alert-meta" style="font-size:0.8rem;color:#64748B;margin:0.25rem 0">Assigned: <strong>Mike Johnson</strong> &middot; Detected: Feb 1, 2026</div><div class="alert-message">Revenue declined 18% YoY (-$34K/month)</div><div class="alert-actions"><input type="text" placeholder="Add resolution note..." style="flex:1;padding:0.4rem 0.6rem;border:1px solid #E2E8F0;border-radius:0.375rem;font-size:0.8rem;margin-right:0.5rem" class="resolve-note"><button class="btn-resolve" onclick="resolveAlert(this)">&#10003; Resolve</button></div></div>
                <div class="alert-card critical" data-csm="Morgan Malone"><div class="alert-header"><span class="alert-title">Involuntary Churn Spike</span><span class="badge critical">CRITICAL</span></div><div class="alert-customer">BMW Kar Wash LLC</div><div class="alert-meta" style="font-size:0.8rem;color:#64748B;margin:0.25rem 0">Assigned: <strong>Morgan Malone</strong> &middot; Detected: Feb 1, 2026</div><div class="alert-message">Involuntary churn at 5.3% across 14 sites &mdash; possible payment processing issue</div><div class="alert-actions"><input type="text" placeholder="Add resolution note..." style="flex:1;padding:0.4rem 0.6rem;border:1px solid #E2E8F0;border-radius:0.375rem;font-size:0.8rem;margin-right:0.5rem" class="resolve-note"><button class="btn-resolve" onclick="resolveAlert(this)">&#10003; Resolve</button></div></div>
                </div>
                <!-- Resolved log -->
                <div style="margin-top:1.5rem">
                    <h2 style="font-size:1rem;color:#64748B">Recently Resolved</h2>
                    <div id="resolved-log" style="font-size:0.8rem;color:#94A3B8"></div>
                </div>
            </div>

            <!-- ==================== BUSINESS ON A PAGE ==================== -->
            <div id="boap" class="page">
                <h1>Business on a Page</h1><p class="page-subtitle">Customer performance summary</p>
                <div class="form-row"><div class="form-group"><label>Select Customer</label><select><option>Sparkle Clean Auto Spa</option><option>Metro Express Wash</option><option>Shine Time Car Wash</option></select></div></div>
                <div class="customer-header">
                    <div class="customer-info"><h2>Sparkle Clean Auto Spa</h2><div class="customer-meta">12 sites &middot; Southwest &middot; CSM: Mike Johnson</div></div>
                    <div class="customer-stats">
                        <div class="customer-stat"><div class="customer-stat-label">Health Score</div><div class="customer-stat-value red">28</div></div>
                        <div class="customer-stat"><div class="customer-stat-label">vs Industry</div><div class="customer-stat-value red">-24%</div></div>
                    </div>
                </div>

                <!-- KPI Row 1: Core Metrics -->
                <div class="card-grid card-grid-4" style="margin-bottom:0.5rem">
                    <div class="card kpi-card"><div class="kpi-value">31%</div><div class="kpi-label">Capture Rate</div><div class="kpi-sublabel" style="color:var(--drb-red)">Benchmark: 39%</div></div>
                    <div class="card kpi-card"><div class="kpi-value red">8.2%</div><div class="kpi-label">Vol Churn Rate</div><div class="kpi-sublabel" style="color:var(--drb-red)">Benchmark: 5.5%</div></div>
                    <div class="card kpi-card"><div class="kpi-value">4.1%</div><div class="kpi-label">Invol Churn Rate</div><div class="kpi-sublabel" style="color:var(--drb-red)">Benchmark: 2.5%</div></div>
                    <div class="card kpi-card"><div class="kpi-value red">-18%</div><div class="kpi-label">Traffic YoY</div></div>
                </div>

                <!-- KPI Row 2: Ticket Averages & Revenue -->
                <div class="card-grid card-grid-4" style="margin-bottom:1.5rem">
                    <div class="card kpi-card"><div class="kpi-value">$27.13</div><div class="kpi-label">Recharge Ticket Avg</div><div class="kpi-sublabel">Membership</div></div>
                    <div class="card kpi-card"><div class="kpi-value">$11.01</div><div class="kpi-label">Retail Ticket Avg</div><div class="kpi-sublabel">Single Wash</div></div>
                    <div class="card kpi-card"><div class="kpi-value">$10.02</div><div class="kpi-label">Overall Ticket Avg</div><div class="kpi-sublabel">All Transactions</div></div>
                    <div class="card kpi-card"><div class="kpi-value red">-18%</div><div class="kpi-label">Revenue YoY</div></div>
                </div>

                <!-- Charts Row 1: Revenue + Members -->
                <h2>24-Month Trends</h2>
                <div class="charts-row">
                    <div class="card"><h3>Monthly Revenue ($K)</h3><div class="chart-container"><canvas id="boapRevenueChart"></canvas></div></div>
                    <div class="card"><h3>Active Members</h3><div class="chart-container"><canvas id="boapMembersChart"></canvas></div></div>
                </div>

                <!-- Charts Row 2: Traffic Breakdown + New Members vs Churn -->
                <div class="charts-row">
                    <div class="card"><h3>Traffic Breakdown &mdash; Last 12 Months</h3><div class="chart-container"><canvas id="boapTrafficPieChart"></canvas></div></div>
                    <div class="card"><h3>New Members vs. Churn &mdash; 12-Month Trend</h3><div class="chart-container"><canvas id="boapJoinsChurnChart"></canvas></div></div>
                </div>

                <!-- Charts Row 3: Capture + Retail Ticket -->
                <div class="charts-row">
                    <div class="card"><h3>Capture Rate (%) &mdash; 24-Month Trend</h3><div class="chart-container"><canvas id="boapCaptureChart"></canvas></div></div>
                    <div class="card"><h3>Avg Retail Ticket ($) &mdash; 24-Month Trend</h3><div class="chart-container"><canvas id="boapRetailTicketChart"></canvas></div></div>
                </div>
            </div>

            <!-- ==================== ADVISORY DEEP DIVE ==================== -->
            <div id="deepdive" class="page">
                <h1>Deep Dive</h1><p class="page-subtitle">Detailed analytics by category</p>

                <div class="dd-tabs">
                    <button class="dd-tab active" data-ddtab="dd-general">General KPIs</button>
                    <button class="dd-tab" data-ddtab="dd-membership">Membership</button>
                    <button class="dd-tab" data-ddtab="dd-retail">Retail</button>
                    <button class="dd-tab" data-ddtab="dd-marketing">Traffic Seasonality</button>
                    <button class="dd-tab" data-ddtab="dd-operations">Operations</button>
                    <button class="dd-tab" data-ddtab="dd-siteview">Site-by-Site</button>
                </div>

                <!-- ===== GENERAL KPIs TAB ===== -->
                <div id="dd-general" class="dd-panel active">
                    <div class="insight-box">
                        <div class="insight-title">Wash Performance</div>
                        <p>The bottom line is revenue and total cars washed. Total to account is the amount of revenue gained from your wash. Total car count is the number of cars washed including retail traffic, membership redemptions, rewashes, and prepaid redemptions.</p>
                    </div>
                    <div class="card-grid card-grid-4">
                        <div class="card kpi-card"><div class="kpi-value">$1.87M</div><div class="kpi-label">Total Revenue</div><div class="kpi-sublabel">Last 12 months</div></div>
                        <div class="card kpi-card"><div class="kpi-value">101K</div><div class="kpi-label">Total Cars</div><div class="kpi-sublabel">Last 12 months</div></div>
                        <div class="card kpi-card"><div class="kpi-value">$28.50</div><div class="kpi-label">Avg Ticket</div><div class="kpi-sublabel">All wash types</div></div>
                        <div class="card kpi-card"><div class="kpi-value">58%</div><div class="kpi-label">Member %</div><div class="kpi-sublabel">of total traffic</div></div>
                    </div>
                    <div class="charts-row">
                        <div class="card"><h3>Monthly Revenue ($K) &mdash; 24-Month Trend</h3><div class="chart-container"><canvas id="ddRevenueChart"></canvas></div></div>
                        <div class="card"><h3>Cars Washed &mdash; 24-Month Trend</h3><div class="chart-container"><canvas id="ddCarsChart"></canvas></div></div>
                    </div>
                    <div class="charts-row">
                        <div class="card"><h3>Traffic Breakdown (Member vs Retail vs Prepaid)</h3><div class="chart-container"><canvas id="ddTrafficBreakdownChart"></canvas></div></div>
                        <div class="card"><h3>Average Ticket &mdash; 24-Month Trend</h3><div class="chart-container"><canvas id="ddAvgTicketChart"></canvas></div></div>
                    </div>
                </div>

                <!-- ===== MEMBERSHIP TAB ===== -->
                <div id="dd-membership" class="dd-panel">
                    <div class="insight-box">
                        <div class="insight-title">Membership Overview</div>
                        <p>Membership customers (unlimited/ARM members) represent brand loyalty. These customers pay monthly for the ability to wash as many times as they need. Members join, recharge, or churn out each month. Tracking the movement of customers and how much they are paying gives insight for maintaining and continuing to grow membership.</p>
                    </div>

                    <div class="card-grid card-grid-5">
                        <div class="card kpi-card"><div class="kpi-value green">2,847</div><div class="kpi-label">Active Members</div><div class="kpi-sublabel">Current month</div></div>
                        <div class="card kpi-card"><div class="kpi-value blue">312</div><div class="kpi-label">New Joins</div><div class="kpi-sublabel">This month</div></div>
                        <div class="card kpi-card"><div class="kpi-value">2,418</div><div class="kpi-label">Recharges</div><div class="kpi-sublabel">This month</div></div>
                        <div class="card kpi-card"><div class="kpi-value red">187</div><div class="kpi-label">Total Churned</div><div class="kpi-sublabel">This month</div></div>
                        <div class="card kpi-card"><div class="kpi-value">$89.2K</div><div class="kpi-label">Member Revenue</div><div class="kpi-sublabel">This month</div></div>
                    </div>

                    <!-- Capture vs Churn Section -->
                    <div class="section-header"><div class="section-icon orange">&#8693;</div><h2>Capture vs. Churn</h2></div>
                    <div class="insight-box">
                        <div class="insight-title">What choices are your members making?</div>
                        <p>Capture rate is the percent of retail traffic that converted to membership. Voluntary churn occurs when a membership is actively ended by the customer. Involuntary churn occurs when a membership ends due to credit card decline or expiration. Comparing capture and churn rates provides insight into changes in overall member numbers.</p>
                    </div>
                    <div class="card-grid card-grid-4">
                        <div class="card kpi-card"><div class="kpi-value green">38.2%</div><div class="kpi-label">Capture Rate</div><div class="kpi-sublabel">Industry avg: 39%</div></div>
                        <div class="card kpi-card"><div class="kpi-value red">5.8%</div><div class="kpi-label">Voluntary Churn</div><div class="kpi-sublabel">Industry avg: 5.5%</div></div>
                        <div class="card kpi-card"><div class="kpi-value yellow">3.2%</div><div class="kpi-label">Involuntary Churn</div><div class="kpi-sublabel">Industry avg: 2.5%</div></div>
                        <div class="card kpi-card"><div class="kpi-value blue">+125</div><div class="kpi-label">Net Member Change</div><div class="kpi-sublabel">Joins minus churn</div></div>
                    </div>
                    <div class="charts-row">
                        <div class="card"><h3>Capture Rate vs. Churn Rate &mdash; 24-Month Trend</h3><div class="chart-container"><canvas id="ddCaptureChurnChart"></canvas></div></div>
                        <div class="card"><h3>Active Members &mdash; 24-Month Trend</h3><div class="chart-container"><canvas id="ddActiveMembersChart"></canvas></div></div>
                    </div>
                    <div class="charts-row">
                        <div class="card"><h3>New Joins vs. Total Churned &mdash; 24-Month Trend</h3><div class="chart-container"><canvas id="ddJoinsChurnChart"></canvas></div></div>
                        <div class="card"><h3>Member Revenue ($K) &mdash; 24-Month Trend</h3><div class="chart-container"><canvas id="ddMemberRevenueChart"></canvas></div></div>
                    </div>

                    <!-- Cohort Analysis Section -->
                    <div class="section-header"><div class="section-icon blue">&#9638;</div><h2>Cohort Analysis</h2></div>
                    <div class="insight-box">
                        <div class="insight-title">Follow the journey of each group of customers</div>
                        <p>A cohort analysis looks at groups of members that joined in each month and tracks their retention each following month. This gives insights into seasonal retention patterns and promotion effectiveness.</p>
                    </div>
                    <div class="card">
                        <h3>Monthly Cohort Retention (%)</h3>
                        <div class="table-container">
                            <table class="cohort-table" id="cohort-table">
                                <thead><tr class="cohort-header"><th>Join Month</th><th>Joined</th><th>M1</th><th>M2</th><th>M3</th><th>M4</th><th>M5</th><th>M6</th><th>M7</th><th>M8</th><th>M9</th><th>M10</th><th>M11</th><th>M12</th></tr></thead>
                                <tbody id="cohort-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tenure & Lifetime Value Section -->
                    <div class="section-header" style="margin-top:2rem"><div class="section-icon green">&#9733;</div><h2>Tenure &amp; Lifetime Value</h2></div>
                    <div class="insight-box">
                        <div class="insight-title">What is the value of an individual membership?</div>
                        <p>Average tenure is a direct indicator of brand loyalty. Lifetime value is the total amount paid by a member during their tenure. Average monthly redemptions gives usage numbers for each group &mdash; usage lower than 2 redemptions/month is an indicator of future churn.</p>
                    </div>
                    <div class="card-grid card-grid-4">
                        <div class="card kpi-card"><div class="kpi-value">8.4</div><div class="kpi-label">Avg Tenure (Months)</div><div class="kpi-sublabel">All active members</div></div>
                        <div class="card kpi-card"><div class="kpi-value green">$265</div><div class="kpi-label">Avg Lifetime Value</div><div class="kpi-sublabel">Per member</div></div>
                        <div class="card kpi-card"><div class="kpi-value">3.6</div><div class="kpi-label">Avg Redemptions/Mo</div><div class="kpi-sublabel">Healthy > 2.0</div></div>
                        <div class="card kpi-card"><div class="kpi-value">$31.50</div><div class="kpi-label">Avg Member Price</div><div class="kpi-sublabel">Monthly charge</div></div>
                    </div>
                    <div class="charts-row">
                        <div class="card"><h3>Avg Tenure by Plan (Months)</h3><div class="chart-container"><canvas id="ddTenureChart"></canvas></div></div>
                        <div class="card"><h3>Avg Lifetime Value by Plan ($)</h3><div class="chart-container"><canvas id="ddLtvChart"></canvas></div></div>
                    </div>
                </div>

                <!-- ===== RETAIL TAB ===== -->
                <div id="dd-retail" class="dd-panel">
                    <div class="insight-box">
                        <div class="insight-title">Retail Overview</div>
                        <p>Retail customers pay the most per wash, but as a group are volatile. They are most likely to be affected by seasonal patterns and bad weather, and are most sensitive to new competition or price changes. Retail customers are also the base from which new memberships can be sold as they become loyal to your brand.</p>
                    </div>

                    <div class="card-grid card-grid-5">
                        <div class="card kpi-card"><div class="kpi-value">42.4K</div><div class="kpi-label">Retail Cars</div><div class="kpi-sublabel">Last 12 months</div></div>
                        <div class="card kpi-card"><div class="kpi-value">$768K</div><div class="kpi-label">Retail Revenue</div><div class="kpi-sublabel">Last 12 months</div></div>
                        <div class="card kpi-card"><div class="kpi-value">$18.12</div><div class="kpi-label">Avg Retail Ticket</div><div class="kpi-sublabel">Per wash</div></div>
                        <div class="card kpi-card"><div class="kpi-value red">-6.2%</div><div class="kpi-label">Retail Traffic YoY</div><div class="kpi-sublabel">vs prior year</div></div>
                        <div class="card kpi-card"><div class="kpi-value yellow">-3.8%</div><div class="kpi-label">Retail Revenue YoY</div><div class="kpi-sublabel">vs prior year</div></div>
                    </div>

                    <!-- Package Distribution -->
                    <div class="section-header"><div class="section-icon orange">&#9632;</div><h2>Package Distribution</h2></div>
                    <div class="card-grid card-grid-4">
                        <div class="card kpi-card"><div class="kpi-value">18%</div><div class="kpi-label">Basic Wash</div><div class="kpi-sublabel">$8 avg ticket</div></div>
                        <div class="card kpi-card"><div class="kpi-value blue">35%</div><div class="kpi-label">Standard Wash</div><div class="kpi-sublabel">$14 avg ticket</div></div>
                        <div class="card kpi-card"><div class="kpi-value green">31%</div><div class="kpi-label">Premium Wash</div><div class="kpi-sublabel">$22 avg ticket</div></div>
                        <div class="card kpi-card"><div class="kpi-value purple">16%</div><div class="kpi-label">Ultimate Wash</div><div class="kpi-sublabel">$30 avg ticket</div></div>
                    </div>

                    <div class="charts-row">
                        <div class="card"><h3>Avg Retail Ticket &mdash; 24-Month Trend</h3><div class="chart-container"><canvas id="ddRetailTicketChart"></canvas></div></div>
                        <div class="card"><h3>Retail Car Count &mdash; 24-Month Trend</h3><div class="chart-container"><canvas id="ddRetailCarsChart"></canvas></div></div>
                    </div>
                    <div class="charts-row">
                        <div class="card"><h3>Retail Revenue ($K) &mdash; 24-Month Trend</h3><div class="chart-container"><canvas id="ddRetailRevenueChart"></canvas></div></div>
                        <div class="card" style="display:flex;flex-direction:column;align-items:center;justify-content:center">
                            <h3>Current Month Package Mix</h3>
                            <div class="chart-container"><canvas id="ddRetailPieChart"></canvas></div>
                        </div>
                    </div>

                    <!-- Pricing Health Check -->
                    <div class="section-header" style="margin-top:1.5rem"><div class="section-icon red">&#36;</div><h2>Pricing Health Check</h2></div>
                    <div class="insight-box">
                        <div class="insight-title">Is there opportunity for price optimization?</div>
                        <p>A pricing health check examines your posted prices alongside purchase distribution data to identify whether there is opportunity for pricing optimization. This is a chance to determine if Precision Pricing would be beneficial to your organization.</p>
                    </div>
                    <div class="card">
                        <h3>Current Menu Pricing vs. Industry Benchmarks</h3>
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Package</th><th>Your Price</th><th>Industry Avg</th><th>Top Quartile</th><th>Variance</th><th>Status</th></tr></thead>
                                <tbody>
                                    <tr><td>Basic Wash</td><td>$8.00</td><td>$9.50</td><td>$11.00</td><td style="color:#DC2626">-$1.50</td><td><span class="badge warning">Below Avg</span></td></tr>
                                    <tr><td>Standard Wash</td><td>$14.00</td><td>$14.50</td><td>$16.00</td><td style="color:#D97706">-$0.50</td><td><span class="badge info">On Track</span></td></tr>
                                    <tr><td>Premium Wash</td><td>$22.00</td><td>$21.00</td><td>$24.00</td><td style="color:#059669">+$1.00</td><td><span class="badge healthy">Above Avg</span></td></tr>
                                    <tr><td>Ultimate Wash</td><td>$30.00</td><td>$28.00</td><td>$32.00</td><td style="color:#059669">+$2.00</td><td><span class="badge healthy">Above Avg</span></td></tr>
                                    <tr><td>Basic Member</td><td>$19.99</td><td>$24.99</td><td>$29.99</td><td style="color:#DC2626">-$5.00</td><td><span class="badge critical">Well Below</span></td></tr>
                                    <tr><td>Premium Member</td><td>$34.99</td><td>$34.99</td><td>$39.99</td><td style="color:#64748B">$0.00</td><td><span class="badge info">At Avg</span></td></tr>
                                    <tr><td>Ultimate Member</td><td>$44.99</td><td>$44.99</td><td>$49.99</td><td style="color:#64748B">$0.00</td><td><span class="badge info">At Avg</span></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ===== MARKETING TAB ===== -->
                <div id="dd-marketing" class="dd-panel">
                    <div class="insight-box">
                        <div class="insight-title">Traffic Patterns &amp; Seasonality</div>
                        <p>Looking at when your customers are visiting your wash can help you plan for high or low volume periods. This also allows you to target certain time periods for focused promotions. Seasonality shows how carwash traffic is spread out over the year and which months have the most or least traffic.</p>
                    </div>

                    <div class="card-grid card-grid-4">
                        <div class="card kpi-card"><div class="kpi-value green">Jul</div><div class="kpi-label">Peak Traffic Month</div><div class="kpi-sublabel">12,340 cars</div></div>
                        <div class="card kpi-card"><div class="kpi-value red">Jan</div><div class="kpi-label">Lowest Traffic Month</div><div class="kpi-sublabel">5,820 cars</div></div>
                        <div class="card kpi-card"><div class="kpi-value blue">Sat</div><div class="kpi-label">Busiest Day</div><div class="kpi-sublabel">18.2% of weekly</div></div>
                        <div class="card kpi-card"><div class="kpi-value">10a-2p</div><div class="kpi-label">Peak Hours</div><div class="kpi-sublabel">42% of daily traffic</div></div>
                    </div>

                    <!-- Traffic Patterns -->
                    <div class="section-header"><div class="section-icon blue">&#9650;</div><h2>Traffic Patterns &mdash; Last 24 Months</h2></div>
                    <div class="charts-row">
                        <div class="card"><h3>Monthly Traffic Volume</h3><div class="chart-container"><canvas id="ddMktTrafficChart"></canvas></div></div>
                        <div class="card"><h3>Traffic by Day of Week (Avg)</h3><div class="chart-container"><canvas id="ddMktDayChart"></canvas></div></div>
                    </div>

                    <!-- Seasonality -->
                    <div class="section-header"><div class="section-icon green">&#9788;</div><h2>Seasonality Insights</h2></div>
                    <div class="insight-box">
                        <div class="insight-title">Climate Zone Impact</div>
                        <p>Seasonality is a look at how carwash traffic is spread out over the year. This can be helpful when planning promotions for the biggest impact. Climate zones affect seasonal patterns &mdash; pollen, dust, salt, and weather all drive traffic variability.</p>
                    </div>
                    <div class="card">
                        <h3>Seasonal Traffic Index (100 = Monthly Average)</h3>
                        <div class="chart-container tall"><canvas id="ddSeasonalChart"></canvas></div>
                    </div>

                </div>

                <!-- ===== OPERATIONS TAB ===== -->
                <div id="dd-operations" class="dd-panel">
                    <div class="insight-box">
                        <div class="insight-title">Site by Site Analysis</div>
                        <p>Individual site data is summarized to show monthly averages over the past year. Sites were evaluated to identify top performing and bottom performing sites. Differences in performance across sites could be due to demographic differences or operational differences at each site.</p>
                    </div>

                    <div class="card-grid card-grid-4">
                        <div class="card kpi-card"><div class="kpi-value">12</div><div class="kpi-label">Total Sites</div></div>
                        <div class="card kpi-card"><div class="kpi-value green">4</div><div class="kpi-label">Top Performers</div><div class="kpi-sublabel">> 110% of avg</div></div>
                        <div class="card kpi-card"><div class="kpi-value yellow">5</div><div class="kpi-label">Average</div><div class="kpi-sublabel">90-110% of avg</div></div>
                        <div class="card kpi-card"><div class="kpi-value red">3</div><div class="kpi-label">Below Average</div><div class="kpi-sublabel">&lt; 90% of avg</div></div>
                    </div>

                    <!-- Site Comparison -->
                    <div class="section-header"><div class="section-icon blue">&#9632;</div><h2>Site Performance Comparison</h2></div>
                    <div class="card">
                        <h3>Key Metrics by Site (Monthly Averages)</h3>
                        <div class="table-container">
                            <table id="site-comparison-table">
                                <thead><tr><th>Site</th><th>Avg Cars/Mo</th><th>Revenue/Mo</th><th>Avg Ticket</th><th>Capture %</th><th>Vol Churn</th><th>Member %</th><th>Rank</th><th>Status</th></tr></thead>
                                <tbody id="site-comparison-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="charts-row" style="margin-top:1.5rem">
                        <div class="card"><h3>Revenue by Site ($K/Mo)</h3><div class="chart-container"><canvas id="ddOpsSiteRevenueChart"></canvas></div></div>
                        <div class="card"><h3>Capture Rate by Site (%)</h3><div class="chart-container"><canvas id="ddOpsSiteCaptureChart"></canvas></div></div>
                    </div>

                    <!-- Site Cards -->
                    <div class="section-header" style="margin-top:2rem"><div class="section-icon orange">&#9776;</div><h2>Site Cards &mdash; Top &amp; Bottom Performers</h2></div>
                    <div class="card-grid" style="grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                        <div class="card" style="border-left: 4px solid var(--drb-green);">
                            <h3 style="color:var(--drb-green)">&#9650; Site 3 &mdash; Top Performer</h3>
                            <div class="card-grid card-grid-3" style="margin-top:0.75rem; margin-bottom:0.5rem;">
                                <div class="kpi-card" style="padding:0.5rem"><div class="kpi-value green" style="font-size:1.5rem">10,240</div><div class="kpi-label">Avg Cars/Mo</div></div>
                                <div class="kpi-card" style="padding:0.5rem"><div class="kpi-value green" style="font-size:1.5rem">$198K</div><div class="kpi-label">Revenue/Mo</div></div>
                                <div class="kpi-card" style="padding:0.5rem"><div class="kpi-value green" style="font-size:1.5rem">46%</div><div class="kpi-label">Capture Rate</div></div>
                            </div>
                            <p style="font-size:0.85rem;color:var(--gray-500)">Highest capture rate and revenue per car. Strong membership sales team and high-traffic location near major shopping center.</p>
                        </div>
                        <div class="card" style="border-left: 4px solid var(--drb-green);">
                            <h3 style="color:var(--drb-green)">&#9650; Site 7 &mdash; Top Performer</h3>
                            <div class="card-grid card-grid-3" style="margin-top:0.75rem; margin-bottom:0.5rem;">
                                <div class="kpi-card" style="padding:0.5rem"><div class="kpi-value green" style="font-size:1.5rem">9,850</div><div class="kpi-label">Avg Cars/Mo</div></div>
                                <div class="kpi-card" style="padding:0.5rem"><div class="kpi-value green" style="font-size:1.5rem">$185K</div><div class="kpi-label">Revenue/Mo</div></div>
                                <div class="kpi-card" style="padding:0.5rem"><div class="kpi-value green" style="font-size:1.5rem">44%</div><div class="kpi-label">Capture Rate</div></div>
                            </div>
                            <p style="font-size:0.85rem;color:var(--gray-500)">Consistently high performer. Lowest churn rate in portfolio (3.8%). Strong community presence and repeat customer base.</p>
                        </div>
                        <div class="card" style="border-left: 4px solid var(--drb-red);">
                            <h3 style="color:var(--drb-red)">&#9660; Site 9 &mdash; Needs Attention</h3>
                            <div class="card-grid card-grid-3" style="margin-top:0.75rem; margin-bottom:0.5rem;">
                                <div class="kpi-card" style="padding:0.5rem"><div class="kpi-value red" style="font-size:1.5rem">5,120</div><div class="kpi-label">Avg Cars/Mo</div></div>
                                <div class="kpi-card" style="padding:0.5rem"><div class="kpi-value red" style="font-size:1.5rem">$78K</div><div class="kpi-label">Revenue/Mo</div></div>
                                <div class="kpi-card" style="padding:0.5rem"><div class="kpi-value red" style="font-size:1.5rem">26%</div><div class="kpi-label">Capture Rate</div></div>
                            </div>
                            <p style="font-size:0.85rem;color:var(--gray-500)">Lowest capture rate. New competitor opened within 1 mile in Q2. Recommend targeted membership promotions and signage updates.</p>
                        </div>
                        <div class="card" style="border-left: 4px solid var(--drb-red);">
                            <h3 style="color:var(--drb-red)">&#9660; Site 11 &mdash; Needs Attention</h3>
                            <div class="card-grid card-grid-3" style="margin-top:0.75rem; margin-bottom:0.5rem;">
                                <div class="kpi-card" style="padding:0.5rem"><div class="kpi-value red" style="font-size:1.5rem">4,890</div><div class="kpi-label">Avg Cars/Mo</div></div>
                                <div class="kpi-card" style="padding:0.5rem"><div class="kpi-value red" style="font-size:1.5rem">$72K</div><div class="kpi-label">Revenue/Mo</div></div>
                                <div class="kpi-card" style="padding:0.5rem"><div class="kpi-value red" style="font-size:1.5rem">28%</div><div class="kpi-label">Capture Rate</div></div>
                            </div>
                            <p style="font-size:0.85rem;color:var(--gray-500)">High churn at 8.1%. Traffic declining 15% YoY. Equipment downtime issues reported &mdash; recommend operational audit and marketing push.</p>
                        </div>
                    </div>

                    <!-- Operational Metrics -->
                    <div class="section-header" style="margin-top:2rem"><div class="section-icon green">&#9881;</div><h2>Operational Metrics</h2></div>
                    <div class="charts-row">
                        <div class="card"><h3>Avg Cars per Day by Site</h3><div class="chart-container"><canvas id="ddOpsCarsPerDayChart"></canvas></div></div>
                        <div class="card"><h3>Churn Rate by Site (%)</h3><div class="chart-container"><canvas id="ddOpsChurnBySiteChart"></canvas></div></div>
                    </div>
                </div>

                <!-- ===== SITE-BY-SITE OVERVIEW TAB ===== -->
                <div id="dd-siteview" class="dd-panel">
                    <div class="insight-box">
                        <div class="insight-title">Site by Site Overview</div>
                        <p>Individual site data is summarized to show monthly averages over the past years. Sites were evaluated to identify top performing and bottom performing sites. Differences in performance across sites could be due to demographic differences or operational differences at each site.</p>
                    </div>

                    <!-- Selectors -->
                    <div class="form-row" style="margin-bottom:1rem">
                        <div class="form-group"><label>View</label>
                            <select id="sv-view" onchange="updateSiteView()">
                                <option value="overview">All Sites Overview</option>
                                <option value="card">Site Card Detail</option>
                            </select>
                        </div>
                        <div class="form-group" id="sv-site-selector" style="display:none"><label>Select Site</label>
                            <select id="sv-site" onchange="updateSiteCard()">
                                <option value="0">Ben Sawyer</option>
                                <option value="1">Cane Bay</option>
                                <option value="2">Catoosa</option>
                                <option value="3">Forest Drive</option>
                                <option value="4">Gervais Street</option>
                                <option value="5">Goose Creek</option>
                                <option value="6">Harbison Blvd</option>
                                <option value="7">Owasso</option>
                            </select>
                        </div>
                    </div>

                    <!-- All Sites Overview Table (color-coded like Suds) -->
                    <div id="sv-overview-panel">
                        <div class="card">
                            <h3>Site Performance &mdash; Monthly Averages by Year</h3>
                            <div class="table-container">
                                <table id="sv-overview-table" style="font-size:0.8rem">
                                    <thead>
                                        <tr>
                                            <th style="text-align:left;min-width:180px">Site Name</th>
                                            <th>Monthly Car Count</th>
                                            <th>Monthly Revenue</th>
                                            <th>Monthly ARM Sold</th>
                                            <th>Capture Rate</th>
                                            <th>Voluntary Churn Rate</th>
                                            <th>Involuntary Churn Rate</th>
                                            <th>Avg Active Members</th>
                                            <th>Membership Traffic %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sv-overview-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Site Card Detail (like Suds Site Card) -->
                    <div id="sv-card-panel" style="display:none">
                        <div style="background:var(--drb-navy);border-radius:1rem 1rem 0 0;padding:1.25rem 1.5rem;color:white">
                            <div style="font-size:1.25rem;font-weight:700" id="sv-card-title">Site Card: Ben Sawyer</div>
                            <div style="font-size:0.85rem;opacity:0.7">Use this site card to examine site successes, traffic patterns, and opportunities!</div>
                        </div>
                        <div class="card" style="border-radius:0 0 1rem 1rem;margin-bottom:1.5rem">
                            <h3>Recent 12 Month KPI Summary</h3>
                            <div class="table-container">
                                <table id="sv-card-kpi-table" style="font-size:0.85rem">
                                    <thead><tr><th style="text-align:left">KPI</th><th>This Site</th><th>Org Average per Site</th><th>Difference</th></tr></thead>
                                    <tbody id="sv-card-kpi-body"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="charts-row">
                            <div class="card"><h3>New Members vs. Churn &mdash; 12 Months</h3><div class="chart-container"><canvas id="svCardJoinsChurnChart"></canvas></div></div>
                            <div class="card"><h3>Traffic Breakdown</h3><div class="chart-container"><canvas id="svCardTrafficPie"></canvas></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="benchmarks" class="page">
                <h1>Industry Benchmarks</h1><p class="page-subtitle">Data-driven benchmarks with manual override capability</p>
                <div class="insight-box">
                    <div class="insight-title">Benchmark Configuration</div>
                    <p>Default benchmarks are based on 2,400+ car wash locations. You can override any value with a custom benchmark for your specific customer or region. Custom values will be used throughout the dashboard for color coding and gap analysis.</p>
                </div>
                <div class="card-grid" style="grid-template-columns:repeat(3,1fr)">
                    <div class="benchmark-card"><h3>Membership</h3>
                        <div class="benchmark-row"><span class="benchmark-label">Capture Rate</span><span class="benchmark-value">39%</span></div>
                        <div class="benchmark-row" style="font-size:0.75rem;color:#94A3B8;padding:0.15rem 0"><span>Override:</span><input type="number" class="bm-override" data-metric="captureRate" placeholder="39" style="width:60px;padding:0.2rem 0.4rem;border:1px solid #E2E8F0;border-radius:0.25rem;font-size:0.75rem;margin-left:0.5rem">%</div>
                        <div class="benchmark-row"><span class="benchmark-label">Top Quartile</span><span class="benchmark-value green">48%+</span></div>
                        <div class="benchmark-row"><span class="benchmark-label">Bottom Quartile</span><span class="benchmark-value red">&lt;28%</span></div>
                        <div class="benchmark-row"><span class="benchmark-label">Avg Recharge Ticket</span><span class="benchmark-value">$32.00</span></div>
                        <div class="benchmark-row" style="font-size:0.75rem;color:#94A3B8;padding:0.15rem 0"><span>Override:</span><input type="number" class="bm-override" data-metric="rechargeTicket" placeholder="32" style="width:60px;padding:0.2rem 0.4rem;border:1px solid #E2E8F0;border-radius:0.25rem;font-size:0.75rem;margin-left:0.5rem">$</div>
                    </div>
                    <div class="benchmark-card"><h3>Churn</h3>
                        <div class="benchmark-row"><span class="benchmark-label">Voluntary</span><span class="benchmark-value">5.5%</span></div>
                        <div class="benchmark-row" style="font-size:0.75rem;color:#94A3B8;padding:0.15rem 0"><span>Override:</span><input type="number" class="bm-override" data-metric="volChurn" placeholder="5.5" step="0.1" style="width:60px;padding:0.2rem 0.4rem;border:1px solid #E2E8F0;border-radius:0.25rem;font-size:0.75rem;margin-left:0.5rem">%</div>
                        <div class="benchmark-row"><span class="benchmark-label">Top Quartile</span><span class="benchmark-value green">&lt;4.0%</span></div>
                        <div class="benchmark-row"><span class="benchmark-label">Bottom Quartile</span><span class="benchmark-value red">7.5%+</span></div>
                        <div class="benchmark-row"><span class="benchmark-label">Involuntary</span><span class="benchmark-value">2.5%</span></div>
                        <div class="benchmark-row" style="font-size:0.75rem;color:#94A3B8;padding:0.15rem 0"><span>Override:</span><input type="number" class="bm-override" data-metric="involChurn" placeholder="2.5" step="0.1" style="width:60px;padding:0.2rem 0.4rem;border:1px solid #E2E8F0;border-radius:0.25rem;font-size:0.75rem;margin-left:0.5rem">%</div>
                    </div>
                    <div class="benchmark-card"><h3>Traffic</h3>
                        <div class="benchmark-row"><span class="benchmark-label">Growth YoY</span><span class="benchmark-value">+5%</span></div>
                        <div class="benchmark-row" style="font-size:0.75rem;color:#94A3B8;padding:0.15rem 0"><span>Override:</span><input type="number" class="bm-override" data-metric="trafficYoY" placeholder="5" style="width:60px;padding:0.2rem 0.4rem;border:1px solid #E2E8F0;border-radius:0.25rem;font-size:0.75rem;margin-left:0.5rem">%</div>
                        <div class="benchmark-row"><span class="benchmark-label">Top Quartile</span><span class="benchmark-value green">+12%+</span></div>
                        <div class="benchmark-row"><span class="benchmark-label">Bottom Quartile</span><span class="benchmark-value red">&lt;-2%</span></div>
                        <div class="benchmark-row"><span class="benchmark-label">Member %</span><span class="benchmark-value">62%</span></div>
                        <div class="benchmark-row" style="font-size:0.75rem;color:#94A3B8;padding:0.15rem 0"><span>Override:</span><input type="number" class="bm-override" data-metric="memberPct" placeholder="62" style="width:60px;padding:0.2rem 0.4rem;border:1px solid #E2E8F0;border-radius:0.25rem;font-size:0.75rem;margin-left:0.5rem">%</div>
                    </div>
                </div>
                <div style="margin-top:1rem;text-align:right"><button onclick="applyBenchmarkOverrides()" style="background:#f04e23;color:white;border:none;padding:0.5rem 1.25rem;border-radius:0.5rem;font-weight:600;cursor:pointer">Apply Custom Benchmarks</button><button onclick="resetBenchmarks()" style="background:#F1F5F9;color:#64748B;border:1px solid #E2E8F0;padding:0.5rem 1.25rem;border-radius:0.5rem;font-weight:600;cursor:pointer;margin-left:0.5rem">Reset to Defaults</button></div>
                <div id="bm-status" style="margin-top:0.75rem;font-size:0.85rem;color:#10B981;text-align:right"></div>
            </div>

            <!-- ==================== ROI & SOLUTIONS ==================== -->
            <div id="roi" class="page">
                <h1>ROI &amp; Solutions Engine</h1>
                <p class="page-subtitle">Connecting performance gaps to DRB solutions &amp; projected revenue impact</p>

                <!-- ===== HERO: Patheon Benchmark Lifts ===== -->
                <div style="background:linear-gradient(135deg,var(--drb-navy),#2A3F55);border-radius:1rem;padding:2rem 1.5rem;margin-bottom:2rem;color:white">
                    <div style="text-align:center;margin-bottom:0.25rem"><span style="font-size:1.35rem;font-weight:700;color:var(--drb-orange)">Driving Customer Growth with Patheon</span></div>
                    <div style="text-align:center;margin-bottom:1.5rem;opacity:0.7;font-size:0.8rem">Analysis of 18 organizations &middot; 156 sites &middot; SiteWatch to Patheon &middot; YoY comparison</div>
                    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:1rem;text-align:center">
                        <div style="background:rgba(255,255,255,0.08);border-radius:0.75rem;padding:1.25rem 0.5rem">
                            <div style="font-size:2.25rem;font-weight:800;color:#34D399">+10%</div>
                            <div style="font-size:0.7rem;text-transform:uppercase;letter-spacing:0.08em;opacity:0.8;margin-top:0.25rem">Membership<br>Growth</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.08);border-radius:0.75rem;padding:1.25rem 0.5rem">
                            <div style="font-size:2.25rem;font-weight:800;color:#34D399">+21%</div>
                            <div style="font-size:0.7rem;text-transform:uppercase;letter-spacing:0.08em;opacity:0.8;margin-top:0.25rem">Member<br>Revenue</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.08);border-radius:0.75rem;padding:1.25rem 0.5rem">
                            <div style="font-size:2.25rem;font-weight:800;color:#60A5FA">-5%</div>
                            <div style="font-size:0.7rem;text-transform:uppercase;letter-spacing:0.08em;opacity:0.8;margin-top:0.25rem">Reduced Vol.<br>Churn</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.08);border-radius:0.75rem;padding:1.25rem 0.5rem">
                            <div style="font-size:2.25rem;font-weight:800;color:#60A5FA">-13%</div>
                            <div style="font-size:0.7rem;text-transform:uppercase;letter-spacing:0.08em;opacity:0.8;margin-top:0.25rem">Reduced Invol.<br>Churn</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.08);border-radius:0.75rem;padding:1.25rem 0.5rem">
                            <div style="font-size:2.25rem;font-weight:800;color:var(--drb-orange)">+14%</div>
                            <div style="font-size:0.7rem;text-transform:uppercase;letter-spacing:0.08em;opacity:0.8;margin-top:0.25rem">Total<br>Revenue</div>
                        </div>
                    </div>
                </div>

                <!-- ===== CUSTOMER SELECTOR ===== -->
                <div class="form-row" style="margin-bottom:1.5rem">
                    <div class="form-group"><label>Select Customer</label>
                        <select id="roi-customer-select" onchange="updateROI()">
                            <option value="sparkle">Sparkle Clean Auto Spa (12 sites)</option>
                            <option value="metro">Metro Express Wash (8 sites)</option>
                            <option value="quick">Quick Clean Express (156 sites)</option>
                        </select>
                    </div>
                </div>

                <!-- ===== KPI GAP ANALYSIS ===== -->
                <div class="section-header"><div class="section-icon red">&#9888;</div><h2>KPI Gap Analysis &amp; Solution Mapping</h2></div>
                <div class="insight-box">
                    <div class="insight-title">How it works</div>
                    <p>Each KPI below is compared against industry benchmarks. Where gaps exist, we map specific Patheon and DRB platform capabilities that address the root cause &mdash; along with the projected revenue impact based on actual conversion data from 156 sites.</p>
                </div>

                <div id="roi-gap-cards"></div>

                <!-- ===== PROJECTED REVENUE IMPACT ===== -->
                <div class="section-header" style="margin-top:2rem"><div class="section-icon green">&#36;</div><h2>Projected Revenue Impact &mdash; Post Conversion</h2></div>

                <div class="card" style="margin-bottom:1.5rem">
                    <h3>Membership Revenue Growth</h3>
                    <div class="table-container">
                        <table id="roi-membership-table">
                            <thead><tr><th></th><th>Current (SiteWatch)</th><th>Projected (Patheon)</th><th style="color:var(--drb-green)">Improvement</th></tr></thead>
                            <tbody id="roi-membership-body"></tbody>
                        </table>
                    </div>
                    <div style="margin-top:0.75rem;padding:0.75rem 1rem;background:#ECFDF5;border-radius:0.5rem;font-size:0.85rem;color:#065F46">
                        <strong>Impact Drivers:</strong> Multi-vehicle plans, drip campaigns via Catalyst, personalized pricing, offsite membership sales portal, and targeted promotions through Patheon&rsquo;s EWA.
                    </div>
                </div>

                <div class="card" style="margin-bottom:1.5rem">
                    <h3>Retail Revenue Growth</h3>
                    <div class="table-container">
                        <table id="roi-retail-table">
                            <thead><tr><th></th><th>Current (SiteWatch)</th><th>Projected (Patheon)</th><th style="color:var(--drb-green)">Improvement</th></tr></thead>
                            <tbody id="roi-retail-body"></tbody>
                        </table>
                    </div>
                    <div style="margin-top:0.75rem;padding:0.75rem 1rem;background:#ECFDF5;border-radius:0.5rem;font-size:0.85rem;color:#065F46">
                        <strong>Impact Drivers:</strong> Pay-As-You-Go proxy member usage, targeted XPT promotions for upsell, Catalyst opt-in marketing campaigns, and pricing optimization with A/B testing.
                    </div>
                </div>

                <div class="card" style="margin-bottom:1.5rem">
                    <h3>Churn Reduction &amp; Member Retention</h3>
                    <div class="table-container">
                        <table id="roi-churn-table">
                            <thead><tr><th></th><th>Current</th><th>Projected (Patheon)</th><th style="color:var(--drb-green)">Improvement</th></tr></thead>
                            <tbody id="roi-churn-body"></tbody>
                        </table>
                    </div>
                    <div style="margin-top:0.75rem;padding:0.75rem 1rem;background:#ECFDF5;border-radius:0.5rem;font-size:0.85rem;color:#065F46">
                        <strong>Impact Drivers:</strong> Automated payment recovery, flexible plan management tools, membership milestone recognition, text &amp; email re-engagement campaigns, and seasonal plan options.
                    </div>
                </div>

                <!-- ===== TOTAL ROI SUMMARY ===== -->
                <div style="background:linear-gradient(135deg,#FFF7ED,#FFFFFF);border:2px solid var(--drb-orange);border-radius:1rem;padding:1.5rem;margin-bottom:2rem">
                    <div style="text-align:center;margin-bottom:1rem"><span style="font-size:1.1rem;font-weight:700;color:var(--drb-orange)">Total Projected Annual Revenue Lift</span></div>
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;text-align:center">
                        <div><div style="font-size:0.7rem;color:var(--gray-500);text-transform:uppercase;letter-spacing:0.05em">Membership Revenue</div><div id="roi-total-mem" style="font-size:1.75rem;font-weight:700;color:var(--drb-green)">+$0</div></div>
                        <div><div style="font-size:0.7rem;color:var(--gray-500);text-transform:uppercase;letter-spacing:0.05em">Retail Revenue</div><div id="roi-total-ret" style="font-size:1.75rem;font-weight:700;color:var(--drb-green)">+$0</div></div>
                        <div><div style="font-size:0.7rem;color:var(--gray-500);text-transform:uppercase;letter-spacing:0.05em">Retained Members Value</div><div id="roi-total-churn" style="font-size:1.75rem;font-weight:700;color:var(--drb-green)">+$0</div></div>
                        <div style="background:#f04e23;border-radius:0.75rem;padding:0.75rem"><div style="font-size:0.7rem;color:rgba(255,255,255,0.85);text-transform:uppercase;letter-spacing:0.05em">Combined Annual Lift</div><div id="roi-total-combined" style="font-size:1.75rem;font-weight:700;color:white">+$0</div></div>
                    </div>
                </div>

                <!-- ===== UNIFIED CUSTOMER ENGAGEMENT PLATFORM ===== -->
                <div class="section-header" style="margin-top:2rem"><div class="section-icon orange">&#9654;</div><h2>Unified Customer Engagement Platform</h2></div>
                <div class="insight-box">
                    <div class="insight-title">Strategies &amp; Tools to Enable Growth</div>
                    <p>The table below maps industry trends to actionable strategies and the specific Patheon &amp; DRB tools that enable each one. Items highlighted in <strong style="color:var(--drb-red)">red</strong> indicate areas where this customer is currently underperforming &mdash; making those tools the highest-priority recommendations.</p>
                </div>

                <div class="card" style="margin-bottom:1.5rem">
                    <table style="font-size:0.85rem" id="roi-platform-table">
                        <thead>
                            <tr>
                                <th style="width:18%;background:var(--drb-navy);color:white">Industry Trend</th>
                                <th style="width:32%;background:var(--drb-navy);color:white">Strategies</th>
                                <th style="width:4%;background:var(--drb-navy);color:white"></th>
                                <th style="width:46%;background:var(--drb-navy);color:white">Patheon &amp; DRB Tools</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="roi-row-retail">
                                <td style="font-weight:700;color:white;background:var(--drb-blue);border-radius:0.5rem 0 0 0.5rem;padding:1rem">Drive Retail<br>Revenue</td>
                                <td style="padding:1rem;line-height:1.7"><span style="font-weight:600">Increase retail ticket average</span><br><span style="font-weight:600">Increase retail traffic</span><br><span style="font-weight:600">Speed and efficiency</span><br><span style="font-weight:600">Increase repeat visits &amp; loyalty</span></td>
                                <td style="text-align:center;color:var(--drb-orange);font-size:1.5rem;font-weight:700">&rarr;</td>
                                <td style="padding:1rem;line-height:1.7">Targeted &amp; personalized promotions<br>Frictionless transactions via EWA/XPT<br>Pricing optimization &amp; A/B testing<br>Earn &amp; redeem Loyalty Points</td>
                            </tr>
                            <tr id="roi-row-membership">
                                <td style="font-weight:700;color:white;background:var(--drb-blue);border-radius:0.5rem 0 0 0.5rem;padding:1rem">Increase<br>Memberships</td>
                                <td style="padding:1rem;line-height:1.7"><span style="font-weight:600">Pricing and value</span><br><span style="font-weight:600">Drive higher conversion rates</span><br><span style="font-weight:600">Increase share of wallet</span><br><span style="font-weight:600">Marketing &amp; promotional campaigns</span></td>
                                <td style="text-align:center;color:var(--drb-orange);font-size:1.5rem;font-weight:700">&rarr;</td>
                                <td style="padding:1rem;line-height:1.7">Multi-vehicle pricing and tools<br>Drip text, email &amp; app notifications via Catalyst<br>Targeted &amp; personalized promotions<br>Offsite membership sales portal</td>
                            </tr>
                            <tr id="roi-row-churn">
                                <td style="font-weight:700;color:white;background:var(--drb-blue);border-radius:0.5rem 0 0 0.5rem;padding:1rem">Reduce<br>Churn</td>
                                <td style="padding:1rem;line-height:1.7"><span style="font-weight:600">Promotional best practices</span><br><span style="font-weight:600">Flexible &amp; seasonal options</span><br><span style="font-weight:600">Member loyalty &amp; usage promotion</span><br><span style="font-weight:600">Failed payment recapture</span></td>
                                <td style="text-align:center;color:var(--drb-orange);font-size:1.5rem;font-weight:700">&rarr;</td>
                                <td style="padding:1rem;line-height:1.7">Simple plan management tools<br>Text &amp; email communications<br>Recognize membership milestones<br>Automated payment recovery</td>
                            </tr>
                            <tr id="roi-row-scale">
                                <td style="font-weight:700;color:white;background:var(--drb-blue);border-radius:0.5rem 0 0 0.5rem;padding:1rem">Scale<br>Seamlessly</td>
                                <td style="padding:1rem;line-height:1.7"><span style="font-weight:600">Cloud solutions for agility</span><br><span style="font-weight:600">Install base consistency</span><br><span style="font-weight:600">Database simplification</span><br><span style="font-weight:600">Faster data availability &amp; analytics</span></td>
                                <td style="text-align:center;color:var(--drb-orange);font-size:1.5rem;font-weight:700">&rarr;</td>
                                <td style="padding:1rem;line-height:1.7">Intelligent Data Syncing<br>Enterprise-grade configuration<br>Data cleanup &amp; mapping on conversion<br>KPI dashboards in easy-to-understand UX</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ===== CAPTURE RATE STRATEGIES ===== -->
                <div class="section-header" style="margin-top:2rem"><div class="section-icon blue">&#9650;</div><h2>Capture Rate Growth Playbook</h2></div>
                <div class="insight-box">
                    <div class="insight-title">10%+ capture rate is considered healthy</div>
                    <p>Patheon&rsquo;s tools enable multiple strategies to drive membership conversion from retail traffic. Below are the proven tactics mapped to specific platform capabilities.</p>
                </div>

                <div class="card-grid" style="grid-template-columns:repeat(2,1fr);margin-bottom:2rem">
                    <div class="card" style="border-left:4px solid var(--drb-blue)">
                        <h3 style="color:var(--drb-blue)">&#9737; Clear, Tiered Pricing</h3>
                        <p style="font-size:0.85rem;color:var(--gray-600);margin-bottom:0.5rem">Highlight value gaps between single washes and memberships. Patheon&rsquo;s EWA and XPT support dynamic pricing displays and comparison charts on-screen.</p>
                        <span class="badge info">Patheon EWA &middot; XPT Kiosk</span>
                    </div>
                    <div class="card" style="border-left:4px solid var(--drb-blue)">
                        <h3 style="color:var(--drb-blue)">&#9733; Empowered Attendants</h3>
                        <p style="font-size:0.85rem;color:var(--gray-600);margin-bottom:0.5rem">Equip team with quick-pitch scripts, tablets, and training on objection handling. Track &amp; reward sales performance with dashboards and incentives.</p>
                        <span class="badge info">Sales Dashboards &middot; Incentive Tracking</span>
                    </div>
                    <div class="card" style="border-left:4px solid var(--drb-orange)">
                        <h3 style="color:var(--drb-orange)">&#9200; Limited-Time Promotions</h3>
                        <p style="font-size:0.85rem;color:var(--gray-600);margin-bottom:0.5rem">Create urgency with first-month discounts or free trials. Catalyst enables targeted campaign delivery via text, email, and app notifications.</p>
                        <span class="badge warning">Catalyst &middot; Promotions Engine</span>
                    </div>
                    <div class="card" style="border-left:4px solid var(--drb-orange)">
                        <h3 style="color:var(--drb-orange)">&#128663; License Plate Recognition</h3>
                        <p style="font-size:0.85rem;color:var(--gray-600);margin-bottom:0.5rem">Personalize offers to returning customers or frequent visitors. LPR integration identifies repeat retail customers for targeted membership offers.</p>
                        <span class="badge warning">LPR &middot; FastPass RFID</span>
                    </div>
                    <div class="card" style="border-left:4px solid var(--drb-green)">
                        <h3 style="color:var(--drb-green)">&#9998; Digital Offers at Kiosk</h3>
                        <p style="font-size:0.85rem;color:var(--gray-600);margin-bottom:0.5rem">Use attention-grabbing messaging and comparison charts on XPT screens. Show savings calculations in real-time during the purchase flow.</p>
                        <span class="badge healthy">XPT &middot; On-Screen Promotions</span>
                    </div>
                    <div class="card" style="border-left:4px solid var(--drb-green)">
                        <h3 style="color:var(--drb-green)">&#128200; Convenience &amp; Savings</h3>
                        <p style="font-size:0.85rem;color:var(--gray-600);margin-bottom:0.5rem">Reinforce benefits like unlimited washes, time savings, and automatic billing. Offsite membership portal lets customers sign up anytime, anywhere.</p>
                        <span class="badge healthy">Offsite Portal &middot; ARM Billing</span>
                    </div>
                </div>

                <!-- ===== ROI TIMELINE CHART ===== -->
                <div class="section-header" style="margin-top:2rem"><div class="section-icon orange">&#128200;</div><h2>Projected ROI Timeline</h2></div>
                <div class="card" style="margin-bottom:2rem">
                    <h3>Cumulative Revenue Lift vs. Investment &mdash; 12-Month Projection</h3>
                    <div class="chart-container tall"><canvas id="roiTimelineChart"></canvas></div>
                    <div style="margin-top:0.75rem;font-size:0.8rem;color:var(--gray-500);text-align:center">* Based on average conversion data from 18 organizations (156 sites) migrating SiteWatch to Patheon. Assumes phased rollout.</div>
                </div>
            </div>

            <!-- ==================== SETTINGS ==================== -->
            <div id="settings" class="page">
                <h1>Configuration</h1><p class="page-subtitle">Health scoring, alert thresholds, and export settings</p>

                <!-- Config Sub-tabs -->
                <div style="display:flex;gap:0;margin-bottom:1.5rem;border-bottom:2px solid var(--gray-200)">
                    <button class="cfg-tab active" data-cfgtab="health-config" onclick="switchCfgTab('health-config',this)" style="padding:0.6rem 1.25rem;font-size:0.875rem;font-weight:600;border:none;background:none;cursor:pointer;color:var(--gray-500);border-bottom:2px solid transparent;margin-bottom:-2px">Health Score</button>
                    <button class="cfg-tab" data-cfgtab="alert-config" onclick="switchCfgTab('alert-config',this)" style="padding:0.6rem 1.25rem;font-size:0.875rem;font-weight:600;border:none;background:none;cursor:pointer;color:var(--gray-500);border-bottom:2px solid transparent;margin-bottom:-2px">Alert Thresholds</button>
                    <button class="cfg-tab" data-cfgtab="export-config" onclick="switchCfgTab('export-config',this)" style="padding:0.6rem 1.25rem;font-size:0.875rem;font-weight:600;border:none;background:none;cursor:pointer;color:var(--gray-500);border-bottom:2px solid transparent;margin-bottom:-2px">PDF Export</button>
                </div>

                <!-- ===== HEALTH SCORE CONFIG TAB ===== -->
                <div id="health-config" class="cfg-panel active">

                    <!-- Overall Health Weights -->
                    <div class="card" style="margin-bottom:1.5rem;border-left:4px solid #1a4797">
                        <h3 style="margin-bottom:0.25rem">Overall Health Score</h3>
                        <p style="font-size:0.8rem;color:var(--gray-500);margin-bottom:1rem">Define how Operational and Business scores combine into the Overall score.</p>
                        <div style="display:flex;gap:2rem;align-items:center;flex-wrap:wrap">
                            <div style="flex:1;min-width:200px">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
                                    <label style="font-size:0.85rem;font-weight:600;color:#3B82F6">Operational Weight</label>
                                    <span id="overall-op-weight-val" style="font-weight:700;font-size:1rem;color:#3B82F6">40%</span>
                                </div>
                                <input type="range" id="overall-op-weight" min="0" max="100" value="40" oninput="updateOverallWeights()" style="width:100%;accent-color:#3B82F6">
                            </div>
                            <div style="flex:1;min-width:200px">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
                                    <label style="font-size:0.85rem;font-weight:600;color:#f04e23">Business Weight</label>
                                    <span id="overall-biz-weight-val" style="font-weight:700;font-size:1rem;color:#f04e23">60%</span>
                                </div>
                                <input type="range" id="overall-biz-weight" min="0" max="100" value="60" oninput="updateOverallWeights()" style="width:100%;accent-color:#f04e23" disabled>
                            </div>
                            <div style="text-align:center;padding:0.75rem 1.5rem;background:#f8fafc;border-radius:0.5rem;border:1px solid var(--gray-200)">
                                <div style="font-size:0.7rem;color:var(--gray-500);text-transform:uppercase;letter-spacing:1px">Formula</div>
                                <div style="font-family:monospace;font-size:0.85rem;margin-top:4px"><span style="color:#3B82F6">Op</span> &times; <span id="formula-op">0.40</span> + <span style="color:#f04e23">Biz</span> &times; <span id="formula-biz">0.60</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Operational Health KPIs -->
                    <div class="card" style="margin-bottom:1.5rem;border-left:4px solid #3B82F6">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
                            <div>
                                <h3 style="margin-bottom:0.25rem;color:#3B82F6">Operational Health Score</h3>
                                <p style="font-size:0.8rem;color:var(--gray-500)">System reliability &amp; support effectiveness. Each KPI is weighted and scored against thresholds.</p>
                            </div>
                            <button class="btn btn-secondary" onclick="addKpiRow('op-kpi-table')" style="font-size:0.8rem;white-space:nowrap">+ Add KPI</button>
                        </div>
                        <div class="table-container" style="margin-top:0.75rem">
                            <table id="op-kpi-table">
                                <thead><tr>
                                    <th style="text-align:left;width:22%">KPI</th>
                                    <th style="width:10%">Weight</th>
                                    <th style="width:10%">Direction</th>
                                    <th style="width:14%">Healthy</th>
                                    <th style="width:14%">At Risk</th>
                                    <th style="width:14%">Critical</th>
                                    <th style="width:8%">Score</th>
                                    <th style="width:5%"></th>
                                </tr></thead>
                                <tbody>
                                    <tr><td><input type="text" value="Cases per Site" class="cfg-input" style="width:100%"></td><td><input type="number" value="25" class="cfg-input cfg-weight" min="0" max="100" style="width:60px">%</td><td><select class="cfg-input"><option value="lower">Lower &#9660;</option><option value="higher">Higher &#9650;</option></select></td><td><input type="text" value="< 5" class="cfg-input" style="width:100%"></td><td><input type="text" value="5 - 12" class="cfg-input" style="width:100%"></td><td><input type="text" value="> 12" class="cfg-input" style="width:100%"></td><td style="text-align:center"><span class="badge healthy" style="font-size:0.75rem">4.2</span></td><td><button class="btn-icon" onclick="this.closest('tr').remove()" title="Remove">&times;</button></td></tr>
                                    <tr><td><input type="text" value="XPT Reboots per Site" class="cfg-input" style="width:100%"></td><td><input type="number" value="15" class="cfg-input cfg-weight" min="0" max="100" style="width:60px">%</td><td><select class="cfg-input"><option value="lower">Lower &#9660;</option><option value="higher">Higher &#9650;</option></select></td><td><input type="text" value="< 2" class="cfg-input" style="width:100%"></td><td><input type="text" value="2 - 5" class="cfg-input" style="width:100%"></td><td><input type="text" value="> 5" class="cfg-input" style="width:100%"></td><td style="text-align:center"><span class="badge healthy" style="font-size:0.75rem">3.8</span></td><td><button class="btn-icon" onclick="this.closest('tr').remove()" title="Remove">&times;</button></td></tr>
                                    <tr><td><input type="text" value="Uptime %" class="cfg-input" style="width:100%"></td><td><input type="number" value="25" class="cfg-input cfg-weight" min="0" max="100" style="width:60px">%</td><td><select class="cfg-input"><option value="higher" selected>Higher &#9650;</option><option value="lower">Lower &#9660;</option></select></td><td><input type="text" value="> 99.5%" class="cfg-input" style="width:100%"></td><td><input type="text" value="98 - 99.5%" class="cfg-input" style="width:100%"></td><td><input type="text" value="< 98%" class="cfg-input" style="width:100%"></td><td style="text-align:center"><span class="badge healthy" style="font-size:0.75rem">4.5</span></td><td><button class="btn-icon" onclick="this.closest('tr').remove()" title="Remove">&times;</button></td></tr>
                                    <tr><td><input type="text" value="Avg Escalation Age (days)" class="cfg-input" style="width:100%"></td><td><input type="number" value="15" class="cfg-input cfg-weight" min="0" max="100" style="width:60px">%</td><td><select class="cfg-input"><option value="lower">Lower &#9660;</option><option value="higher">Higher &#9650;</option></select></td><td><input type="text" value="< 3" class="cfg-input" style="width:100%"></td><td><input type="text" value="3 - 7" class="cfg-input" style="width:100%"></td><td><input type="text" value="> 7" class="cfg-input" style="width:100%"></td><td style="text-align:center"><span class="badge info" style="font-size:0.75rem">3.0</span></td><td><button class="btn-icon" onclick="this.closest('tr').remove()" title="Remove">&times;</button></td></tr>
                                    <tr><td><input type="text" value="Open Field Defects" class="cfg-input" style="width:100%"></td><td><input type="number" value="10" class="cfg-input cfg-weight" min="0" max="100" style="width:60px">%</td><td><select class="cfg-input"><option value="lower">Lower &#9660;</option><option value="higher">Higher &#9650;</option></select></td><td><input type="text" value="0" class="cfg-input" style="width:100%"></td><td><input type="text" value="1 - 3" class="cfg-input" style="width:100%"></td><td><input type="text" value="> 3" class="cfg-input" style="width:100%"></td><td style="text-align:center"><span class="badge healthy" style="font-size:0.75rem">5.0</span></td><td><button class="btn-icon" onclick="this.closest('tr').remove()" title="Remove">&times;</button></td></tr>
                                    <tr><td><input type="text" value="Open Enhancement Requests" class="cfg-input" style="width:100%"></td><td><input type="number" value="10" class="cfg-input cfg-weight" min="0" max="100" style="width:60px">%</td><td><select class="cfg-input"><option value="lower">Lower &#9660;</option><option value="higher">Higher &#9650;</option></select></td><td><input type="text" value="0 - 2" class="cfg-input" style="width:100%"></td><td><input type="text" value="3 - 5" class="cfg-input" style="width:100%"></td><td><input type="text" value="> 5" class="cfg-input" style="width:100%"></td><td style="text-align:center"><span class="badge info" style="font-size:0.75rem">3.5</span></td><td><button class="btn-icon" onclick="this.closest('tr').remove()" title="Remove">&times;</button></td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.75rem;padding:0.5rem 0.75rem;background:#f0f7ff;border-radius:0.5rem">
                            <span style="font-size:0.8rem;color:#3B82F6;font-weight:600">Total Weight: <span id="op-total-weight">100</span>%</span>
                            <span id="op-weight-status" style="font-size:0.75rem">&#10003; Weights sum to 100%</span>
                        </div>
                    </div>

                    <!-- Business Health KPIs -->
                    <div class="card" style="margin-bottom:1.5rem;border-left:4px solid #f04e23">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
                            <div>
                                <h3 style="margin-bottom:0.25rem;color:#f04e23">Business Health Score</h3>
                                <p style="font-size:0.8rem;color:var(--gray-500)">Membership performance &amp; revenue growth metrics.</p>
                            </div>
                            <button class="btn btn-secondary" onclick="addKpiRow('biz-kpi-table')" style="font-size:0.8rem;white-space:nowrap">+ Add KPI</button>
                        </div>
                        <div class="table-container" style="margin-top:0.75rem">
                            <table id="biz-kpi-table">
                                <thead><tr>
                                    <th style="text-align:left;width:22%">KPI</th>
                                    <th style="width:10%">Weight</th>
                                    <th style="width:10%">Direction</th>
                                    <th style="width:14%">Healthy</th>
                                    <th style="width:14%">At Risk</th>
                                    <th style="width:14%">Critical</th>
                                    <th style="width:8%">Score</th>
                                    <th style="width:5%"></th>
                                </tr></thead>
                                <tbody>
                                    <tr><td><input type="text" value="Capture Rate %" class="cfg-input" style="width:100%"></td><td><input type="number" value="30" class="cfg-input cfg-weight" min="0" max="100" style="width:60px">%</td><td><select class="cfg-input"><option value="higher" selected>Higher &#9650;</option><option value="lower">Lower &#9660;</option></select></td><td><input type="text" value="> 40%" class="cfg-input" style="width:100%"></td><td><input type="text" value="30 - 40%" class="cfg-input" style="width:100%"></td><td><input type="text" value="< 30%" class="cfg-input" style="width:100%"></td><td style="text-align:center"><span class="badge info" style="font-size:0.75rem">3.2</span></td><td><button class="btn-icon" onclick="this.closest('tr').remove()" title="Remove">&times;</button></td></tr>
                                    <tr><td><input type="text" value="Voluntary Churn %" class="cfg-input" style="width:100%"></td><td><input type="number" value="30" class="cfg-input cfg-weight" min="0" max="100" style="width:60px">%</td><td><select class="cfg-input"><option value="lower">Lower &#9660;</option><option value="higher">Higher &#9650;</option></select></td><td><input type="text" value="< 4%" class="cfg-input" style="width:100%"></td><td><input type="text" value="4 - 7%" class="cfg-input" style="width:100%"></td><td><input type="text" value="> 7%" class="cfg-input" style="width:100%"></td><td style="text-align:center"><span class="badge warning" style="font-size:0.75rem">2.0</span></td><td><button class="btn-icon" onclick="this.closest('tr').remove()" title="Remove">&times;</button></td></tr>
                                    <tr><td><input type="text" value="Revenue YoY %" class="cfg-input" style="width:100%"></td><td><input type="number" value="25" class="cfg-input cfg-weight" min="0" max="100" style="width:60px">%</td><td><select class="cfg-input"><option value="higher" selected>Higher &#9650;</option><option value="lower">Lower &#9660;</option></select></td><td><input type="text" value="> 5%" class="cfg-input" style="width:100%"></td><td><input type="text" value="-5% to 5%" class="cfg-input" style="width:100%"></td><td><input type="text" value="< -5%" class="cfg-input" style="width:100%"></td><td style="text-align:center"><span class="badge info" style="font-size:0.75rem">3.0</span></td><td><button class="btn-icon" onclick="this.closest('tr').remove()" title="Remove">&times;</button></td></tr>
                                    <tr><td><input type="text" value="Traffic YoY %" class="cfg-input" style="width:100%"></td><td><input type="number" value="15" class="cfg-input cfg-weight" min="0" max="100" style="width:60px">%</td><td><select class="cfg-input"><option value="higher" selected>Higher &#9650;</option><option value="lower">Lower &#9660;</option></select></td><td><input type="text" value="> 3%" class="cfg-input" style="width:100%"></td><td><input type="text" value="-3% to 3%" class="cfg-input" style="width:100%"></td><td><input type="text" value="< -3%" class="cfg-input" style="width:100%"></td><td style="text-align:center"><span class="badge warning" style="font-size:0.75rem">2.5</span></td><td><button class="btn-icon" onclick="this.closest('tr').remove()" title="Remove">&times;</button></td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.75rem;padding:0.5rem 0.75rem;background:#fff7ed;border-radius:0.5rem">
                            <span style="font-size:0.8rem;color:#f04e23;font-weight:600">Total Weight: <span id="biz-total-weight">100</span>%</span>
                            <span id="biz-weight-status" style="font-size:0.75rem">&#10003; Weights sum to 100%</span>
                        </div>
                    </div>

                    <!-- Score Scale Reference -->
                    <div class="card" style="margin-bottom:1.5rem">
                        <h3 style="margin-bottom:0.5rem">Score Scale Reference</h3>
                        <div style="display:flex;gap:0;border-radius:0.5rem;overflow:hidden;height:32px;margin-bottom:0.75rem">
                            <div style="flex:2;background:linear-gradient(90deg,#FEE2E2,#FEF3C7);display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:600;color:#991B1B">0 &mdash; 2.0 Critical</div>
                            <div style="flex:1.5;background:linear-gradient(90deg,#FEF3C7,#D1FAE5);display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:600;color:#92400E">2.0 &mdash; 3.5 At Risk</div>
                            <div style="flex:1.5;background:linear-gradient(90deg,#D1FAE5,#A7F3D0);display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:600;color:#065F46">3.5 &mdash; 5.0 Healthy</div>
                        </div>
                        <p style="font-size:0.8rem;color:var(--gray-500)">Each KPI is scored 0&ndash;5 based on where the actual value falls relative to the thresholds above. The weighted average of all KPIs produces the sub-score. Overall Health = (Op &times; Op Weight) + (Biz &times; Biz Weight).</p>
                    </div>

                    <div style="display:flex;gap:0.75rem">
                        <button class="btn btn-primary" onclick="saveHealthConfig()" style="background:#1a4797">Save Health Configuration</button>
                        <button class="btn btn-secondary" onclick="resetHealthConfig()">Reset to Defaults</button>
                    </div>
                </div>

                <!-- ===== ALERT THRESHOLDS TAB ===== -->
                <div id="alert-config" class="cfg-panel" style="display:none">
                    <h2 style="margin-top:0">Alert Thresholds</h2><p class="page-subtitle" style="margin-bottom:1rem">Set custom thresholds to trigger alerts on the Risk Alerts page.</p>
                    <div class="card-grid" style="grid-template-columns:repeat(2,1fr)">
                        <div class="card"><h3>Capture Rate</h3><div class="form-row"><div class="form-group"><label>Warning (Below)</label><input type="number" value="35"></div><div class="form-group"><label>Critical (Below)</label><input type="number" value="28"></div></div></div>
                        <div class="card"><h3>Voluntary Churn</h3><div class="form-row"><div class="form-group"><label>Warning (Above)</label><input type="number" value="6.0"></div><div class="form-group"><label>Critical (Above)</label><input type="number" value="7.5"></div></div></div>
                        <div class="card"><h3>Traffic YoY</h3><div class="form-row"><div class="form-group"><label>Warning (Below)</label><input type="number" value="-5"></div><div class="form-group"><label>Critical (Below)</label><input type="number" value="-15"></div></div></div>
                        <div class="card"><h3>Revenue YoY</h3><div class="form-row"><div class="form-group"><label>Warning (Below)</label><input type="number" value="-5"></div><div class="form-group"><label>Critical (Below)</label><input type="number" value="-12"></div></div></div>
                        <div class="card"><h3>Health Score</h3><div class="form-row"><div class="form-group"><label>Warning (Below)</label><input type="number" value="2.5"></div><div class="form-group"><label>Critical (Below)</label><input type="number" value="1.5"></div></div></div>
                        <div class="card"><h3>Average Ticket</h3><div class="form-row"><div class="form-group"><label>Warning (Below)</label><input type="number" value="28"></div><div class="form-group"><label>Critical (Below)</label><input type="number" value="24"></div></div></div>
                    </div>
                    <div style="margin-top:1.5rem"><button class="btn btn-primary" style="background:#1a4797">Save Thresholds</button><button class="btn btn-secondary" style="margin-left:0.5rem">Reset to Defaults</button></div>
                </div>

                <!-- ===== PDF EXPORT TAB ===== -->
                <div id="export-config" class="cfg-panel" style="display:none">
                    <div class="card" style="border-left:4px solid var(--drb-orange)">
                        <h3 style="color:var(--drb-orange)">Export DRB Pulse PDF</h3>
                        <p style="font-size:0.85rem;color:#64748B;margin-bottom:0.75rem">Generate a professionally styled PDF report matching the SUDS/DRB Pulse presentation template. Select a customer and click generate.</p>
                        <div class="form-row">
                            <div class="form-group"><label>Customer</label>
                                <select id="pdf-customer">
                                    <option value="bmw">BMW Kar Wash LLC</option>
                                    <option value="sparkle">Sparkle Clean Auto Spa</option>
                                    <option value="quick">Quick Clean Express</option>
                                    <option value="premier">Premier Auto Spa</option>
                                    <option value="tts">Time To Shine Car Wash</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Report Date</label>
                                <input type="month" id="pdf-date" value="2026-02">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="generatePdfExport()" style="background:#f04e23">Generate PDF Report</button>
                        <div id="pdf-status" style="margin-top:0.5rem;font-size:0.8rem;color:#64748B"></div>
                    </div>
                </div>
            </div>

            <div class="footer">Data as of: <span id="current-date"></span> &middot; DRB Pulse</div>
        </main>
    </div>

    <script>window.__DRB_DATA__ = null;</script>
<script>
window.onerror = function(msg, url, line, col, err) {
    var d = document.getElementById('debug-bar');
    if (!d) { d = document.createElement('div'); d.id='debug-bar'; d.style.cssText='position:fixed;bottom:0;left:0;right:0;background:#fee;color:#900;padding:8px 16px;font:12px monospace;z-index:99999;max-height:120px;overflow:auto'; document.body.appendChild(d); }
    d.innerHTML += 'JS Error: ' + msg + ' (line ' + line + ')<br>';
    return false;
};
function switchPage(pageId, btn) {
    var items = document.querySelectorAll('.nav-item');
    for (var i = 0; i < items.length; i++) items[i].className = 'nav-item';
    var pages = document.querySelectorAll('.page');
    for (var i = 0; i < pages.length; i++) pages[i].className = 'page';
    btn.className = 'nav-item active';
    var target = document.getElementById(pageId);
    if (target) target.className = 'page active';
    function tryInit(attempt) {
        try {
            if (pageId === 'operational') initOp();
            else if (pageId === 'boap') initBoap();
            else if (pageId === 'deepdive') initDD('dd-general');
            else if (pageId === 'roi') initROI();
        } catch(e) {
            console.error('Chart init attempt ' + attempt + ':', e);
            if (attempt < 3) setTimeout(function(){ tryInit(attempt+1); }, 300);
        }
    }
    setTimeout(function(){ tryInit(1); }, 150);
}
</script>

    <script>
    /* ============================================================
       LIVE DATA BRIDGE
       Injected by Python  window.__DRB_DATA__ contains all KPIs
       from Snowflake. When present, charts/tables use real data.
       When absent (demo mode), falls back to generated data.
       ============================================================ */
    var D = window.__DRB_DATA__ || null;
    var LIVE = !!D;

    /* Helper: use live data array or generate fallback */
    function ld(key, fallbackFn) {
        if (LIVE && D.trends && D.trends[key]) return D.trends[key];
        return fallbackFn();
    }
    function ldLabels() {
        if (LIVE && D.trends && D.trends.labels) return D.trends.labels;
        return ml(D && D.months ? D.months : 12);
    }

    /* ============================================================
       VANILLA CANVAS CHART ENGINE - Zero external dependencies
       ============================================================ */
    var SC = {
        c: { blue:'#3B82F6', orange:'#f04e23', green:'#10B981', red:'#EF4444', purple:'#8B5CF6', teal:'#14B8A6',
             bf:'rgba(59,130,246,0.1)', of:'rgba(242,101,34,0.1)',
             gf:'rgba(16,185,129,0.1)', rf:'rgba(239,68,68,0.1)',
             pf:'rgba(139,92,246,0.1)', tf:'rgba(20,184,166,0.1)',
             grid:'#F1F5F9', lbl:'#64748B' },

        ctx: function(id) {
            var cv = document.getElementById(id);
            if (!cv) { console.warn('Canvas not found:', id); return null; }
            var p = cv.parentElement;
            var dpr = window.devicePixelRatio || 1;
            var pw = p.offsetWidth, ph = p.offsetHeight;
            if (pw < 10 || ph < 10) { console.warn('Canvas parent too small:', id, pw, ph); return null; }
            cv.width = pw * dpr;
            cv.height = ph * dpr;
            cv.style.width = pw + 'px';
            cv.style.height = ph + 'px';
            var c = cv.getContext('2d');
            c.scale(dpr, dpr);
            c._w = pw;
            c._h = ph;
            return c;
        },

        bar: function(id, labels, data, color, horiz) {
            var c = this.ctx(id); if(!c) return;
            var w=c._w, h=c._h, mx=Math.max.apply(null,data)*1.15;
            var pad = horiz ? {t:15,r:20,b:30,l:85} : {t:15,r:15,b:50,l:50};
            var cw=w-pad.l-pad.r, ch=h-pad.t-pad.b;
            c.clearRect(0,0,w,h);
            c.font='11px -apple-system,sans-serif';
            c.textBaseline='middle';

            if(horiz) {
                var bh=(ch/data.length)*0.65, gap=(ch/data.length)*0.35;
                for(var g=0;g<=4;g++){var gx=pad.l+(cw*g/4);c.strokeStyle=this.c.grid;c.lineWidth=1;c.beginPath();c.moveTo(gx,pad.t);c.lineTo(gx,h-pad.b);c.stroke();c.fillStyle=this.c.lbl;c.textAlign='center';c.fillText(Math.round(mx*g/4),gx,h-pad.b+12);}
                for(var i=0;i<data.length;i++){var by=pad.t+(i*(bh+gap))+gap/2,bw=(data[i]/mx)*cw,r=Math.min(4,bh/2);c.fillStyle=color;c.beginPath();c.moveTo(pad.l,by);c.lineTo(pad.l+bw-r,by);c.arcTo(pad.l+bw,by,pad.l+bw,by+r,r);c.lineTo(pad.l+bw,by+bh-r);c.arcTo(pad.l+bw,by+bh,pad.l+bw-r,by+bh,r);c.lineTo(pad.l,by+bh);c.closePath();c.fill();c.fillStyle=this.c.lbl;c.textAlign='right';c.fillText(labels[i],pad.l-8,by+bh/2);}
            } else {
                var bW=(cw/data.length)*0.6, bG=(cw/data.length)*0.4;
                for(var g2=0;g2<=4;g2++){var gy=h-pad.b-(ch*g2/4);c.strokeStyle=this.c.grid;c.lineWidth=1;c.beginPath();c.moveTo(pad.l,gy);c.lineTo(w-pad.r,gy);c.stroke();c.fillStyle=this.c.lbl;c.textAlign='right';c.fillText(Math.round(mx*g2/4),pad.l-8,gy);}
                var step=data.length>15?3:data.length>8?2:1;
                for(var j=0;j<data.length;j++){var bx=pad.l+(j*(bW+bG))+bG/2,bHt=(data[j]/mx)*ch,baseY=h-pad.b,r2=Math.min(4,bW/2);c.fillStyle=color;c.beginPath();c.moveTo(bx,baseY);c.lineTo(bx,baseY-bHt+r2);c.arcTo(bx,baseY-bHt,bx+r2,baseY-bHt,r2);c.lineTo(bx+bW-r2,baseY-bHt);c.arcTo(bx+bW,baseY-bHt,bx+bW,baseY-bHt+r2,r2);c.lineTo(bx+bW,baseY);c.closePath();c.fill();if(j%step===0){c.fillStyle=this.c.lbl;c.textAlign='center';c.save();c.translate(bx+bW/2,baseY+10);c.rotate(-0.4);c.fillText(labels[j],0,0);c.restore();}}
            }
        },

        line: function(id, labels, data, lc, fc) {
            var c = this.ctx(id); if(!c) return;
            var w=c._w, h=c._h;
            var mx=Math.max.apply(null,data)*1.15, mn=Math.min(0,Math.min.apply(null,data)), rng=mx-mn;
            var pad={t:15,r:15,b:50,l:55}, cw=w-pad.l-pad.r, ch=h-pad.t-pad.b;
            c.clearRect(0,0,w,h);
            c.font='11px -apple-system,sans-serif';

            for(var g=0;g<=4;g++){var gy=h-pad.b-(ch*g/4),v=mn+(rng*g/4);c.strokeStyle=this.c.grid;c.lineWidth=1;c.beginPath();c.moveTo(pad.l,gy);c.lineTo(w-pad.r,gy);c.stroke();c.fillStyle=this.c.lbl;c.textAlign='right';c.textBaseline='middle';c.fillText(Math.round(v),pad.l-8,gy);}

            var pts=[];
            for(var i=0;i<data.length;i++){pts.push({x:pad.l+(i/(data.length-1))*cw,y:h-pad.b-((data[i]-mn)/rng)*ch});}

            c.beginPath();c.moveTo(pts[0].x,h-pad.b);
            for(var j=0;j<pts.length;j++){if(j===0)c.lineTo(pts[j].x,pts[j].y);else{var xc=(pts[j-1].x+pts[j].x)/2;c.bezierCurveTo(xc,pts[j-1].y,xc,pts[j].y,pts[j].x,pts[j].y);}}
            c.lineTo(pts[pts.length-1].x,h-pad.b);c.closePath();c.fillStyle=fc;c.fill();

            c.beginPath();
            for(var k=0;k<pts.length;k++){if(k===0)c.moveTo(pts[k].x,pts[k].y);else{var xc2=(pts[k-1].x+pts[k].x)/2;c.bezierCurveTo(xc2,pts[k-1].y,xc2,pts[k].y,pts[k].x,pts[k].y);}}
            c.strokeStyle=lc;c.lineWidth=2.5;c.stroke();

            for(var m=0;m<pts.length;m++){c.beginPath();c.arc(pts[m].x,pts[m].y,3,0,Math.PI*2);c.fillStyle=lc;c.fill();c.strokeStyle='white';c.lineWidth=1.5;c.stroke();}

            var step=data.length>15?3:data.length>8?2:1;
            for(var n=0;n<labels.length;n++){if(n%step===0){c.fillStyle=this.c.lbl;c.textAlign='center';c.textBaseline='top';c.save();c.translate(pts[n].x,h-pad.b+8);c.rotate(-0.4);c.fillText(labels[n],0,0);c.restore();}}
        },

        /* Multi-line chart for overlaying 2 datasets */
        multiLine: function(id, labels, datasets) {
            var c = this.ctx(id); if(!c) return;
            var w=c._w, h=c._h;
            var allData = [];
            for(var d=0;d<datasets.length;d++) allData = allData.concat(datasets[d].data);
            var mx=Math.max.apply(null,allData)*1.15, mn=Math.min(0,Math.min.apply(null,allData)), rng=mx-mn;
            var pad={t:25,r:15,b:50,l:55}, cw=w-pad.l-pad.r, ch=h-pad.t-pad.b;
            c.clearRect(0,0,w,h);
            c.font='11px -apple-system,sans-serif';

            for(var g=0;g<=4;g++){var gy=h-pad.b-(ch*g/4),v=mn+(rng*g/4);c.strokeStyle=this.c.grid;c.lineWidth=1;c.beginPath();c.moveTo(pad.l,gy);c.lineTo(w-pad.r,gy);c.stroke();c.fillStyle=this.c.lbl;c.textAlign='right';c.textBaseline='middle';c.fillText(Math.round(v*10)/10,pad.l-8,gy);}

            for(var ds=0;ds<datasets.length;ds++){
                var data=datasets[ds].data, lc=datasets[ds].color, fc=datasets[ds].fill;
                var pts=[];
                for(var i=0;i<data.length;i++){pts.push({x:pad.l+(i/(data.length-1))*cw,y:h-pad.b-((data[i]-mn)/rng)*ch});}
                c.beginPath();c.moveTo(pts[0].x,h-pad.b);
                for(var j=0;j<pts.length;j++){if(j===0)c.lineTo(pts[j].x,pts[j].y);else{var xc=(pts[j-1].x+pts[j].x)/2;c.bezierCurveTo(xc,pts[j-1].y,xc,pts[j].y,pts[j].x,pts[j].y);}}
                c.lineTo(pts[pts.length-1].x,h-pad.b);c.closePath();c.fillStyle=fc;c.fill();
                c.beginPath();
                for(var k=0;k<pts.length;k++){if(k===0)c.moveTo(pts[k].x,pts[k].y);else{var xc2=(pts[k-1].x+pts[k].x)/2;c.bezierCurveTo(xc2,pts[k-1].y,xc2,pts[k].y,pts[k].x,pts[k].y);}}
                c.strokeStyle=lc;c.lineWidth=2;c.stroke();
                for(var m=0;m<pts.length;m++){c.beginPath();c.arc(pts[m].x,pts[m].y,2.5,0,Math.PI*2);c.fillStyle=lc;c.fill();}
            }

            /* legend */
            var lx=pad.l+10;
            for(var lg=0;lg<datasets.length;lg++){
                c.fillStyle=datasets[lg].color;c.fillRect(lx,5,12,10);
                c.fillStyle=this.c.lbl;c.textAlign='left';c.textBaseline='top';c.fillText(datasets[lg].label,lx+16,4);
                lx+=c.measureText(datasets[lg].label).width+34;
            }

            var step=labels.length>15?3:labels.length>8?2:1;
            var pts0=[];for(var q=0;q<labels.length;q++){pts0.push({x:pad.l+(q/(labels.length-1))*cw});}
            for(var n=0;n<labels.length;n++){if(n%step===0){c.fillStyle=this.c.lbl;c.textAlign='center';c.textBaseline='top';c.save();c.translate(pts0[n].x,h-pad.b+8);c.rotate(-0.4);c.fillText(labels[n],0,0);c.restore();}}
        },

        /* Stacked area for traffic breakdown */
        stackedArea: function(id, labels, datasets) {
            var c = this.ctx(id); if(!c) return;
            var w=c._w, h=c._h;
            var pad={t:25,r:15,b:50,l:55}, cw=w-pad.l-pad.r, ch=h-pad.t-pad.b;
            /* compute stacked totals */
            var n = datasets[0].data.length;
            var stacked = [];
            for(var i=0;i<n;i++){var sum=0;for(var d=0;d<datasets.length;d++) sum+=datasets[d].data[i]; stacked.push(sum);}
            var mx = Math.max.apply(null,stacked)*1.15;
            c.clearRect(0,0,w,h);
            c.font='11px -apple-system,sans-serif';

            for(var g=0;g<=4;g++){var gy=h-pad.b-(ch*g/4);c.strokeStyle=this.c.grid;c.lineWidth=1;c.beginPath();c.moveTo(pad.l,gy);c.lineTo(w-pad.r,gy);c.stroke();c.fillStyle=this.c.lbl;c.textAlign='right';c.textBaseline='middle';c.fillText(Math.round(mx*g/4),pad.l-8,gy);}

            /* draw from top to bottom */
            for(var d2=datasets.length-1;d2>=0;d2--){
                var cumData=[];
                for(var i2=0;i2<n;i2++){var s=0;for(var dd=0;dd<=d2;dd++) s+=datasets[dd].data[i2]; cumData.push(s);}
                var pts=[];
                for(var j=0;j<n;j++){pts.push({x:pad.l+(j/(n-1))*cw,y:h-pad.b-(cumData[j]/mx)*ch});}
                c.beginPath();c.moveTo(pts[0].x,h-pad.b);
                for(var k=0;k<pts.length;k++){if(k===0)c.lineTo(pts[k].x,pts[k].y);else{var xc=(pts[k-1].x+pts[k].x)/2;c.bezierCurveTo(xc,pts[k-1].y,xc,pts[k].y,pts[k].x,pts[k].y);}}
                c.lineTo(pts[pts.length-1].x,h-pad.b);c.closePath();
                c.fillStyle=datasets[d2].color;c.globalAlpha=0.6;c.fill();c.globalAlpha=1;
            }
            /* legend */
            var lx=pad.l+10;
            for(var lg=0;lg<datasets.length;lg++){
                c.fillStyle=datasets[lg].color;c.globalAlpha=0.8;c.fillRect(lx,5,12,10);c.globalAlpha=1;
                c.fillStyle=this.c.lbl;c.textAlign='left';c.textBaseline='top';c.fillText(datasets[lg].label,lx+16,4);
                lx+=c.measureText(datasets[lg].label).width+34;
            }
            var step=labels.length>15?3:labels.length>8?2:1;
            for(var sn=0;sn<labels.length;sn++){if(sn%step===0){var sx=pad.l+(sn/(n-1))*cw;c.fillStyle=this.c.lbl;c.textAlign='center';c.textBaseline='top';c.save();c.translate(sx,h-pad.b+8);c.rotate(-0.4);c.fillText(labels[sn],0,0);c.restore();}}
        },

        /* Health Score Chart - fixed 0-5 Y-axis with colored zones */
        healthLine: function(id, labels, datasets) {
            var c = this.ctx(id); if(!c) return;
            var w=c._w, h=c._h;
            var pad={t:25,r:15,b:50,l:55}, cw=w-pad.l-pad.r, ch=h-pad.t-pad.b;
            var mn=0, mx=5, rng=5;
            c.clearRect(0,0,w,h);
            c.font='11px -apple-system,sans-serif';
            /* zone bands */
            var y0=function(v){return h-pad.b-((v-mn)/rng)*ch;};
            c.fillStyle='rgba(239,68,68,0.06)'; c.fillRect(pad.l,y0(2),cw,y0(0)-y0(2));
            c.fillStyle='rgba(245,158,11,0.06)'; c.fillRect(pad.l,y0(3.5),cw,y0(2)-y0(3.5));
            c.fillStyle='rgba(16,185,129,0.06)'; c.fillRect(pad.l,y0(5),cw,y0(3.5)-y0(5));
            /* zone labels */
            c.font='10px -apple-system,sans-serif'; c.textAlign='right';
            c.fillStyle='rgba(239,68,68,0.35)'; c.fillText('Critical',w-pad.r-4,y0(1));
            c.fillStyle='rgba(245,158,11,0.35)'; c.fillText('At Risk',w-pad.r-4,y0(2.75));
            c.fillStyle='rgba(16,185,129,0.35)'; c.fillText('Healthy',w-pad.r-4,y0(4.25));
            /* grid + Y axis: 0,1,2,3,4,5 */
            c.font='11px -apple-system,sans-serif';
            for(var g=0;g<=5;g++){
                var gy=y0(g);
                c.strokeStyle=this.c.grid;c.lineWidth=1;c.beginPath();c.moveTo(pad.l,gy);c.lineTo(w-pad.r,gy);c.stroke();
                c.fillStyle=this.c.lbl;c.textAlign='right';c.textBaseline='middle';c.fillText(g.toFixed(1),pad.l-8,gy);
            }
            /* zone boundary lines */
            c.setLineDash([4,4]);c.lineWidth=1;
            c.strokeStyle='rgba(239,68,68,0.25)';c.beginPath();c.moveTo(pad.l,y0(2));c.lineTo(w-pad.r,y0(2));c.stroke();
            c.strokeStyle='rgba(16,185,129,0.25)';c.beginPath();c.moveTo(pad.l,y0(3.5));c.lineTo(w-pad.r,y0(3.5));c.stroke();
            c.setLineDash([]);
            /* draw lines */
            for(var ds=0;ds<datasets.length;ds++){
                var data=datasets[ds].data, lc=datasets[ds].color, lw=datasets[ds].width||2;
                var pts=[];
                for(var i=0;i<data.length;i++){pts.push({x:pad.l+(i/(data.length-1))*cw,y:y0(data[i])});}
                c.beginPath();
                for(var k=0;k<pts.length;k++){if(k===0)c.moveTo(pts[k].x,pts[k].y);else{var xc=(pts[k-1].x+pts[k].x)/2;c.bezierCurveTo(xc,pts[k-1].y,xc,pts[k].y,pts[k].x,pts[k].y);}}
                if(datasets[ds].dashed) c.setLineDash(datasets[ds].dashed);
                c.strokeStyle=lc;c.lineWidth=lw;c.stroke();
                c.setLineDash([]);
                for(var m=0;m<pts.length;m++){c.beginPath();c.arc(pts[m].x,pts[m].y,lw>2?3.5:2.5,0,Math.PI*2);c.fillStyle=lc;c.fill();c.strokeStyle='white';c.lineWidth=1.5;c.stroke();}
            }
            /* legend */
            var lx=pad.l+10;
            c.font='11px -apple-system,sans-serif';
            for(var lg=0;lg<datasets.length;lg++){
                if(datasets[lg].dashed){c.setLineDash(datasets[lg].dashed);c.strokeStyle=datasets[lg].color;c.lineWidth=2;c.beginPath();c.moveTo(lx,10);c.lineTo(lx+14,10);c.stroke();c.setLineDash([]);}
                else{c.fillStyle=datasets[lg].color;c.fillRect(lx,5,14,10);}
                c.fillStyle=this.c.lbl;c.textAlign='left';c.textBaseline='top';c.fillText(datasets[lg].label,lx+18,4);
                lx+=c.measureText(datasets[lg].label).width+38;
            }
            /* X labels */
            var step=labels.length>15?3:labels.length>8?2:1;
            for(var n=0;n<labels.length;n++){if(n%step===0){var nx=pad.l+(n/(labels.length-1))*cw;c.fillStyle=this.c.lbl;c.textAlign='center';c.textBaseline='top';c.save();c.translate(nx,h-pad.b+8);c.rotate(-0.4);c.fillText(labels[n],0,0);c.restore();}}
        },

        pie: function(id, slices, donut) {
            var c = this.ctx(id); if(!c) return;
            var w=c._w, h=c._h;
            c.clearRect(0,0,w,h);
            var cx=w/2, cy=h/2-10;
            var r=Math.min(w,h)/2-35;
            var total=0; for(var i=0;i<slices.length;i++) total+=slices[i].value;
            var startAngle=-Math.PI/2;
            for(var j=0;j<slices.length;j++){
                var sliceAngle=(slices[j].value/total)*Math.PI*2;
                c.beginPath();c.moveTo(cx,cy);c.arc(cx,cy,r,startAngle,startAngle+sliceAngle);c.closePath();
                c.fillStyle=slices[j].color;c.fill();
                /* label */
                var midA=startAngle+sliceAngle/2;
                var lx=cx+Math.cos(midA)*(r*0.65);
                var ly=cy+Math.sin(midA)*(r*0.65);
                var pct=Math.round(slices[j].value/total*100);
                c.fillStyle='white';c.font='bold 13px -apple-system,sans-serif';c.textAlign='center';c.textBaseline='middle';
                if(pct>=10) c.fillText(pct+'%',lx,ly);
                startAngle+=sliceAngle;
            }
            if(donut){c.beginPath();c.arc(cx,cy,r*0.45,0,Math.PI*2);c.fillStyle='white';c.fill();}
            /* legend below */
            var lx2=w/2-((slices.length*80)/2);
            c.font='11px -apple-system,sans-serif';
            for(var k=0;k<slices.length;k++){
                c.fillStyle=slices[k].color;c.fillRect(lx2,h-22,12,10);
                c.fillStyle=this.c.lbl;c.textAlign='left';c.textBaseline='top';c.fillText(slices[k].label,lx2+15,h-23);
                lx2+=c.measureText(slices[k].label).width+30;
            }
        }
    };

    /* RESOLVE ALERTS */
    function resolveAlert(btn) {
        var card = btn.closest('.alert-card');
        var noteInput = card.querySelector('.resolve-note');
        var note = noteInput ? noteInput.value.trim() : '';
        var title = card.querySelector('.alert-title').textContent;
        var customer = card.querySelector('.alert-customer').textContent;
        card.classList.add('resolving');
        setTimeout(function() {
            card.remove();
            updateAlertCounts();
            /* Add to resolved log */
            var log = document.getElementById('resolved-log');
            if(log){
                var entry = document.createElement('div');
                entry.style.cssText = 'padding:0.5rem 0;border-bottom:1px solid #F1F5F9';
                var ts = new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
                entry.innerHTML = '<span style="color:#10B981">&#10003;</span> <strong>'+title+'</strong> &mdash; '+customer+(note?' &mdash; <em>"'+note+'"</em>':'')+' <span style="float:right;font-size:0.7rem">'+ts+'</span>';
                log.insertBefore(entry, log.firstChild);
            }
            var container = document.getElementById('alerts-container');
            if (container && container.querySelectorAll('.alert-card').length === 0) {
                container.innerHTML = '<div class="no-alerts">&#10003; All alerts resolved!</div>';
            }
        }, 350);
    }

    function filterAlerts(){
        var csm = document.getElementById('alert-csm-filter').value;
        var sev = document.getElementById('alert-sev-filter').value;
        var cards = document.querySelectorAll('#alerts-container .alert-card');
        cards.forEach(function(c){
            var csmMatch = csm==='all' || c.getAttribute('data-csm')===csm;
            var sevMatch = sev==='all' || c.classList.contains(sev);
            c.style.display = (csmMatch && sevMatch) ? '' : 'none';
        });
    }

    function updateAlertCounts() {
        var container = document.getElementById('alerts-container');
        if (!container) return;
        var critCount = container.querySelectorAll('.alert-card.critical').length;
        var warnCount = container.querySelectorAll('.alert-card.warning').length;
        var cards = document.querySelectorAll('#alerts .metric-card');
        if (cards[0]) cards[0].querySelector('.metric-value').textContent = critCount;
        if (cards[1]) cards[1].querySelector('.metric-value').textContent = warnCount;
        if (cards[3]) {
            var cur = parseInt(cards[3].querySelector('.metric-value').textContent) || 0;
            cards[3].querySelector('.metric-value').textContent = cur + 1;
        }
    }

    /* NAV handled via inline onclick */

    /* DEEP DIVE TAB NAV */
    document.querySelectorAll('.dd-tab').forEach(function(tab){
        tab.addEventListener('click',function(e){
            e.preventDefault();
            document.querySelectorAll('.dd-tab').forEach(function(t){t.classList.remove('active');});
            document.querySelectorAll('.dd-panel').forEach(function(p){p.classList.remove('active');});
            this.classList.add('active');
            var targetId = this.dataset.ddtab;
            var targetPanel = document.getElementById(targetId);
            if (targetPanel) targetPanel.classList.add('active');
            setTimeout(function(){ try { initDD(targetId); } catch(err) { console.error('DD init error:', err); } },50);
        });
    });

    document.getElementById('current-date').textContent=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});

    /* BENCHMARK OVERRIDES */
    var customBenchmarks = {};
    function applyBenchmarkOverrides(){
        var inputs = document.querySelectorAll('.bm-override');
        var count = 0;
        inputs.forEach(function(inp){
            var v = parseFloat(inp.value);
            if(!isNaN(v)){
                customBenchmarks[inp.getAttribute('data-metric')] = v;
                count++;
            }
        });
        var status = document.getElementById('bm-status');
        if(status) status.textContent = count > 0 ? ' Applied '+count+' custom benchmark'+(count>1?'s':'') : 'No custom values entered';
    }
    function resetBenchmarks(){
        customBenchmarks = {};
        document.querySelectorAll('.bm-override').forEach(function(inp){ inp.value=''; });
        var status = document.getElementById('bm-status');
        if(status) status.textContent = ' Reset to industry defaults';
    }

    /* ============================================================
       PDF EXPORT  PRINT-FRIENDLY VIEW
       Opens a new window with styled content matching PPTX template.
       User saves via File > Print > Save as PDF.
       ============================================================ */
    function generatePdfExport(){
        var sel = document.getElementById('pdf-customer');
        var custKey = sel.value;
        var custName = sel.options[sel.selectedIndex].text;
        var dateInput = document.getElementById('pdf-date');
        var reportDate = dateInput ? dateInput.value : '2026-02';
        var parts = reportDate.split('-');
        var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        var dateStr = months[parseInt(parts[1])-1] + ' ' + parts[0];

        var status = document.getElementById('pdf-status');
        if(status) status.innerHTML = '<span style="color:#F59E0B"> Generating print view...</span>';

        /* Get site data for the customer */
        var custSites = [];
        var custKpis = {};
        if(custKey === 'tts'){
            custSites = svSites;
            custKpis = {totalCars:'1,204,464',totalRev:'$15,681,845',activeMembers:'3,776',rechTicket:'$28.30',retTicket:'$15.07',overallTicket:'$13.02',captureRate:'15.18%',volChurn:'5.37%',involChurn:'5.52%',trafficYoY:'+8.4%',revenueYoY:'+12.1%',memberPct:'76.5%'};
        } else {
            var c = cust[custKey];
            custKpis = {totalCars:(c.sites*14200).toLocaleString(),totalRev:'$'+(c.sites*142000).toLocaleString(),activeMembers:(c.sites*220).toLocaleString(),rechTicket:'$29.50',retTicket:'$15.80',overallTicket:'$13.40',captureRate:'18.2%',volChurn:'4.8%',involChurn:'3.2%',trafficYoY:'+5.2%',revenueYoY:'+7.8%',memberPct:'68.5%'};
        }

        /* Build the heatmap HTML */
        var heatHtml = '';
        var sitesForTable = custSites.length > 0 ? custSites : [];
        for(var i=0;i<sitesForTable.length;i++){
            var s = sitesForTable[i];
            var sn = s.name.replace(/Time To Shine Car Wash - |Time to Shine Car Wash - /,'');
            heatHtml += '<tr style="background:#1a4797;color:white;font-weight:700"><td colspan="9" style="text-align:left;padding:6px 10px">'+sn+'</td></tr>';
            var yrs = Object.keys(s.years).sort();
            for(var y=0;y<yrs.length;y++){
                var d = s.years[yrs[y]];
                heatHtml += '<tr><td style="padding-left:20px;color:#94A3B8;font-size:10px">'+yrs[y]+'</td>';
                heatHtml += '<td>'+d.cars.toLocaleString()+'</td>';
                heatHtml += '<td>$'+d.rev.toLocaleString(undefined,{minimumFractionDigits:2})+'</td>';
                heatHtml += '<td>'+d.armSold+'</td>';
                heatHtml += heatCell(d.capture,12,8,true)+'%</td>';
                heatHtml += heatCell(d.volChurn,5,7,false)+'%</td>';
                heatHtml += heatCell(d.involChurn,3,6,false)+'%</td>';
                heatHtml += '<td>'+d.activeMembers.toLocaleString()+'</td>';
                heatHtml += heatCell(d.memPct,70,50,true)+'%</td></tr>';
            }
        }

        function heatCell(v,g,b,hb){
            var bg,fg;
            if(hb){bg=v>=g?'#D1FAE5':v>=b?'#FEF3C7':'#FEE2E2';fg=v>=g?'#065F46':v>=b?'#92400E':'#991B1B';}
            else{bg=v<=g?'#D1FAE5':v<=b?'#FEF3C7':'#FEE2E2';fg=v<=g?'#065F46':v<=b?'#92400E':'#991B1B';}
            return '<td style="background:'+bg+';color:'+fg+';font-weight:600">'+v.toFixed(2);
        }

        /* Open print window */
        var w = window.open('','_blank','width=1100,height=850');
        w.document.write('<!DOCTYPE html><html><head><title>'+custName+' DRB Pulse</title>');
        w.document.write('<style>');
        w.document.write('@page{size:landscape;margin:0.4in}');
        w.document.write('*{margin:0;padding:0;box-sizing:border-box}body{font-family:Helvetica,Arial,sans-serif;color:#333;-webkit-print-color-adjust:exact;print-color-adjust:exact}');
        w.document.write('.page{page-break-after:always;position:relative;width:100%;min-height:7.5in;padding:0}');
        w.document.write('.cover{background:#6B8DB9;min-height:5.4in;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white}');
        w.document.write('.cover h1{font-size:42px;font-weight:700;letter-spacing:1px}.cover h2{font-size:32px;font-weight:300;margin-top:8px}');
        w.document.write('.cover-sub{font-size:14px;color:#D4E1F0;margin-top:16px}');
        w.document.write('.cover-bottom{background:white;padding:20px 40px;text-align:right}');
        w.document.write('.logo-text{font-size:28px;font-weight:700;color:#1a4797;display:inline}.logo-sep{color:#94A3B8;margin:0 4px}.logo-suds{font-size:24px;font-weight:700;color:#f04e23}');
        w.document.write('.hdr{background:#2a5cad;padding:16px 32px;color:white}.hdr h1{font-size:22px;font-weight:700}.hdr p{font-size:11px;color:#B8CCE4;margin-top:2px}');
        w.document.write('.hdr-logo{float:right;margin-top:-32px}.hdr-logo .logo-text{color:white;font-size:20px}.hdr-logo .logo-suds{font-size:18px}');
        w.document.write('.divider{height:2px;background:#8FAAD0}');
        w.document.write('.content{padding:16px 32px}');
        w.document.write('.kpi-row{display:flex;gap:10px;margin:12px 0}.kpi-card{flex:1;background:#F8FAFC;border:1px solid #E2E8F0;border-radius:6px;padding:8px 12px;text-align:center}');
        w.document.write('.kpi-label{font-size:8px;color:#94A3B8;text-transform:uppercase}.kpi-value{font-size:22px;font-weight:700;color:#1a4797;margin:2px 0}.kpi-sub{font-size:7px;color:#64748B}');
        w.document.write('.section-div{background:#8FAAD0;min-height:5.4in;display:flex;flex-direction:column;justify-content:center;padding-left:100px}');
        w.document.write('.section-div h1{font-size:32px;color:#1a4797;font-weight:700}.section-div p{font-size:15px;color:#1a4797;margin-top:8px}');
        w.document.write('table.heat{width:100%;border-collapse:collapse;font-size:9px;margin-top:8px}');
        w.document.write('table.heat th{background:#2a5cad;color:white;padding:5px 8px;font-weight:600;text-align:center}');
        w.document.write('table.heat td{padding:4px 8px;text-align:center;border-bottom:1px solid #F1F5F9}');
        w.document.write('.footer{position:absolute;bottom:8px;left:32px;right:32px;border-top:1px solid #8FAAD0;padding-top:4px;font-size:7px;color:#94A3B8;display:flex;justify-content:space-between}');
        w.document.write('.toc-item{font-size:16px;color:#1a4797;margin:12px 0}.toc-num{font-weight:700;font-size:18px;margin-right:8px}');
        w.document.write('.action-num{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:#2a5cad;color:white;font-weight:700;font-size:13px;margin-right:10px}');
        w.document.write('.action-title{font-size:14px;font-weight:700;color:#1a4797}.action-desc{font-size:10px;color:#333;margin:4px 0 16px 38px}');
        w.document.write('@media print{.no-print{display:none!important}}');
        w.document.write('</style></head><body>');

        /* Print button */
        w.document.write('<div class="no-print" style="background:#1a4797;color:white;padding:10px 20px;text-align:center;font-size:14px">');
        w.document.write('<button onclick="window.print()" style="background:#f04e23;color:white;border:none;padding:8px 24px;border-radius:6px;font-weight:700;font-size:14px;cursor:pointer;margin-right:12px"> Print / Save as PDF</button>');
        w.document.write('Use <strong>File  Print  Save as PDF</strong> for best results (Landscape orientation)</div>');

        var pg = 0;
        function footer(){ return '<div class="footer"><span>DRB Pulse  '+custName+'</span><span>Page '+(++pg)+'</span></div>'; }

        /* Cover */
        w.document.write('<div class="page"><div class="cover"><h1>'+custName.toUpperCase()+'</h1><h2>DRB Pulse</h2><div class="cover-sub">Created '+dateStr+'</div><div class="cover-sub" style="font-size:12px">by SUDS Creative and DRB</div></div><div class="divider"></div><div class="cover-bottom"><span class="logo-text">DRB</span><span class="logo-sep">|</span><span class="logo-suds">suds.</span></div></div>');

        /* TOC */
        w.document.write('<div class="page"><div class="hdr"><h1>Overview</h1><p>Table of Contents</p><div class="hdr-logo"><span class="logo-text">DRB</span> <span class="logo-suds">suds.</span></div></div><div class="divider"></div><div class="content" style="padding-top:32px">');
        var tocItems = ['Key Performance Indicators  General','Key Performance Indicators  Membership','Site by Site Analysis','Action Items & Recommendations'];
        for(var t=0;t<tocItems.length;t++) w.document.write('<div class="toc-item"><span class="toc-num">'+(t+1)+'</span>  '+tocItems[t]+'</div>');
        w.document.write('</div>'+footer()+'</div>');

        /* Section: KPI General */
        w.document.write('<div class="page"><div class="section-div"><h1>Key Performance</h1><h1>Indicators: General</h1><p>Wash Performance</p><p>Traffic Breakdown</p></div><div class="divider"></div><div class="cover-bottom"><span class="logo-text">DRB</span><span class="logo-sep">|</span><span class="logo-suds">suds.</span></div></div>');

        /* Wash Performance */
        w.document.write('<div class="page"><div class="hdr"><h1>Wash Performance</h1><p>The bottom line is revenue and total cars washed.</p><div class="hdr-logo"><span class="logo-text">DRB</span> <span class="logo-suds">suds.</span></div></div><div class="divider"></div><div class="content">');
        w.document.write('<div class="kpi-row">');
        var wk = [['Total Cars (12mo)',custKpis.totalCars,custKpis.trafficYoY+' YoY'],['Total Revenue (12mo)',custKpis.totalRev,custKpis.revenueYoY+' YoY'],['Active Members',custKpis.activeMembers,'Monthly avg'],['Recharge Ticket',custKpis.rechTicket,'Benchmark: $32.00'],['Retail Ticket',custKpis.retTicket,'Benchmark: $18.00'],['Overall Ticket',custKpis.overallTicket,'']];
        for(var k=0;k<wk.length;k++) w.document.write('<div class="kpi-card"><div class="kpi-label">'+wk[k][0]+'</div><div class="kpi-value">'+wk[k][1]+'</div><div class="kpi-sub">'+wk[k][2]+'</div></div>');
        w.document.write('</div></div>'+footer()+'</div>');

        /* Section: Membership */
        w.document.write('<div class="page"><div class="section-div"><h1>Key Performance</h1><h1>Indicators: Membership</h1><p>Membership Overview</p><p>Capture vs. Churn</p></div><div class="divider"></div><div class="cover-bottom"><span class="logo-text">DRB</span><span class="logo-sep">|</span><span class="logo-suds">suds.</span></div></div>');

        /* Membership Overview */
        w.document.write('<div class="page"><div class="hdr"><h1>Membership Overview</h1><p>What are the trends in your membership quantities and value?</p><div class="hdr-logo"><span class="logo-text">DRB</span> <span class="logo-suds">suds.</span></div></div><div class="divider"></div><div class="content">');
        w.document.write('<div class="kpi-row">');
        var mk = [['Active Members',custKpis.activeMembers,''],['Capture Rate',custKpis.captureRate,'Benchmark: 39%'],['Vol. Churn',custKpis.volChurn,'Benchmark: 5.5%'],['Invol. Churn',custKpis.involChurn,'Benchmark: 2.5%'],['Recharge Ticket',custKpis.rechTicket,'Benchmark: $32.00'],['Membership %',custKpis.memberPct,'Benchmark: 62%']];
        for(var k=0;k<mk.length;k++) w.document.write('<div class="kpi-card"><div class="kpi-label">'+mk[k][0]+'</div><div class="kpi-value">'+mk[k][1]+'</div><div class="kpi-sub">'+mk[k][2]+'</div></div>');
        w.document.write('</div></div>'+footer()+'</div>');

        /* Site by Site Overview */
        if(heatHtml){
            w.document.write('<div class="page"><div class="hdr"><h1>Site by Site Overview</h1><p>Which sites have the highest or lowest performance across key metrics?</p><div class="hdr-logo"><span class="logo-text">DRB</span> <span class="logo-suds">suds.</span></div></div><div class="divider"></div><div class="content">');
            w.document.write('<table class="heat"><tr><th>Site Name</th><th>Car Count</th><th>Revenue</th><th>ARM Sold</th><th>Capture</th><th>Vol Churn</th><th>Invol Churn</th><th>Active Mbrs</th><th>Mem %</th></tr>');
            w.document.write(heatHtml);
            w.document.write('</table></div>'+footer()+'</div>');
        }

        /* Action Items */
        w.document.write('<div class="page"><div class="hdr"><h1>Action Items</h1><p>Strategic advice based on your data</p><div class="hdr-logo"><span class="logo-text">DRB</span> <span class="logo-suds">suds.</span></div></div><div class="divider"></div><div class="content" style="padding-top:24px">');
        var actions = [['Launch Membership Campaign','Recommended when data shows a large percentage of retail washers and low capture rates.'],['Launch Retail Traffic Campaigns','Recommended if data shows overall drops in traffic or a very large percentage of membership washes.'],['Conduct Pricing Analysis','Recommended if ticket averages are volatile or have shown recent change.'],['Create Seasonality-Based Marketing Strategy','Recommended to create a series of marketing approaches to maintain year-round support.']];
        for(var a=0;a<actions.length;a++) w.document.write('<div style="margin-bottom:16px"><span class="action-num">'+(a+1)+'</span><span class="action-title">'+actions[a][0]+'</span><div class="action-desc">'+actions[a][1]+'</div></div>');
        w.document.write('</div>'+footer()+'</div>');

        /* Back cover */
        w.document.write('<div class="page"><div style="background:#6B8DB9;min-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white"><h1 style="font-size:36px">Thank You</h1><p style="font-size:16px;color:#D4E1F0;margin-top:8px">'+custName+'  DRB Pulse</p><div style="margin-top:40px"><span class="logo-text" style="color:white;font-size:28px">DRB</span><span class="logo-sep" style="color:#D4E1F0">|</span><span class="logo-suds" style="font-size:24px">suds.</span></div></div></div>');

        w.document.write('</body></html>');
        w.document.close();

        if(status) status.innerHTML = '<span style="color:#10B981"> Print view opened  use Print  Save as PDF</span>';
    }

    /* DATA */
    var cust={
    bmw:{name:'BMW Kar Wash LLC',orgCode:'BMW-001',sites:61,region:'MI',csm:'Morgan Malone',
        opHealth:3.4,bizHealth:2.2,overall:2.80,
        opHistory:[2.8,2.9,3.0,2.9,3.1,3.0,3.2,3.1,3.3,3.2,3.4,3.4],
        bizHistory:[1.4,1.5,1.6,1.5,1.7,1.8,1.7,1.9,2.0,2.0,2.1,2.2],
        overallHistory:[2.1,2.0,2.2,2.3,2.1,2.4,2.5,2.3,2.6,2.7,2.6,2.8],
        uptime:'99.92%',totalCases:572,openCases:4,avgTtr:2.24,hwSwaps:3,escalations:1,
        captureRate:'36%',churnRate:'5.8%',trafficYoY:'+3%',revenueYoY:'+5%'},
    sparkle:{name:'Sparkle Clean Auto Spa',orgCode:'SPA-042',sites:12,region:'AZ',csm:'Mike Johnson',
        opHealth:1.8,bizHealth:0.8,overall:1.20,
        opHistory:[3.0,2.8,2.6,2.4,2.3,2.2,2.1,2.0,1.9,1.9,1.8,1.8],
        bizHistory:[2.2,2.0,1.8,1.6,1.4,1.2,1.1,1.0,0.9,0.9,0.8,0.8],
        overallHistory:[3.2,3.0,2.8,2.5,2.3,2.1,1.9,1.8,1.6,1.4,1.3,1.2],
        uptime:'97.45%',totalCases:89,openCases:8,avgTtr:4.5,hwSwaps:5,escalations:3,
        captureRate:'31%',churnRate:'8.2%',trafficYoY:'-18%',revenueYoY:'-18%'},
    quick:{name:'Quick Clean Express',orgCode:'QCE-118',sites:156,region:'TX',csm:'Tom Wilson',
        opHealth:3.8,bizHealth:3.2,overall:3.50,
        opHistory:[3.2,3.3,3.4,3.5,3.4,3.6,3.5,3.7,3.6,3.8,3.7,3.8],
        bizHistory:[2.6,2.7,2.8,2.8,2.9,2.9,3.0,3.0,3.1,3.1,3.2,3.2],
        overallHistory:[3.0,3.1,3.0,3.2,3.1,3.3,3.2,3.4,3.3,3.5,3.4,3.5],
        uptime:'99.78%',totalCases:1240,openCases:12,avgTtr:1.8,hwSwaps:8,escalations:2,
        captureRate:'33%',churnRate:'7.1%',trafficYoY:'-12%',revenueYoY:'-14%'},
    premier:{name:'Premier Auto Spa',orgCode:'PAS-200',sites:234,region:'CA',csm:'Sarah Chen',
        opHealth:4.5,bizHealth:4.0,overall:4.20,
        opHistory:[3.6,3.7,3.8,3.9,4.0,4.0,4.1,4.2,4.2,4.3,4.4,4.5],
        bizHistory:[3.0,3.1,3.2,3.3,3.4,3.5,3.5,3.6,3.7,3.8,3.9,4.0],
        overallHistory:[3.4,3.5,3.6,3.7,3.8,3.8,3.9,4.0,4.0,4.1,4.1,4.2],
        uptime:'99.95%',totalCases:1890,openCases:6,avgTtr:1.2,hwSwaps:4,escalations:0,
        captureRate:'48%',churnRate:'3.8%',trafficYoY:'+12%',revenueYoY:'+14%'}
    };
    var orgSiteLookup = [
        {code:'BMW-001',label:'BMW Kar Wash LLC (Org)',key:'bmw',type:'org'},
        {code:'BMW-001-S01',label:'BMW Location 1 - Detroit',key:'bmw',type:'site'},
        {code:'BMW-001-S02',label:'BMW Location 2 - Chicago',key:'bmw',type:'site'},
        {code:'SPA-042',label:'Sparkle Clean Auto Spa (Org)',key:'sparkle',type:'org'},
        {code:'SPA-042-S01',label:'Sparkle Location 1 - Phoenix',key:'sparkle',type:'site'},
        {code:'QCE-118',label:'Quick Clean Express (Org)',key:'quick',type:'org'},
        {code:'QCE-118-S01',label:'Quick Clean Location 1 - Dallas',key:'quick',type:'site'},
        {code:'QCE-118-S02',label:'Quick Clean Location 2 - Austin',key:'quick',type:'site'},
        {code:'PAS-200',label:'Premier Auto Spa (Org)',key:'premier',type:'org'},
        {code:'PAS-200-S01',label:'Premier Location 1 - LA',key:'premier',type:'site'},
        {code:'PAS-200-S02',label:'Premier Location 2 - SF',key:'premier',type:'site'}
    ]

    function genSites(n){var cities=['Detroit','Chicago','Milwaukee','Cleveland','Indianapolis'],plat=['SW & PATH','SW Only','PATH Only','XPT & SW'],s=[];for(var i=1;i<=Math.min(n,20);i++){var h=Math.random()>0.8?'warning':Math.random()>0.95?'critical':'healthy';s.push({name:'Location '+i,city:cities[Math.floor(Math.random()*cities.length)],health:h,uptime:(95+Math.random()*5).toFixed(2),cases:Math.floor(Math.random()*25),open:Math.floor(Math.random()*5),swaps:Math.floor(Math.random()*3),esc:Math.floor(Math.random()*2),csat:(85+Math.random()*15).toFixed(1),plat:plat[Math.floor(Math.random()*plat.length)]});}return s;}

    function updateOperationalData(){
        var s=document.getElementById('customer-select'),d=cust[s.value];
        if(!d) return;
        document.getElementById('op-customer-name').textContent=d.name;
        document.getElementById('op-customer-meta').textContent=d.orgCode+' \u00B7 '+d.sites+' Sites \u00B7 '+d.region+' \u00B7 CSM: '+d.csm;
        /* health scores */
        function hColor(v){return v>=3.5?'#10B981':v>=2?'#F59E0B':'#EF4444';}
        function hBarHtml(v){return '<div class="health-bar-fill" style="width:'+(v/5*100)+'%;background:'+hColor(v)+'"></div>';}
        document.getElementById('op-opHealth').textContent=d.opHealth.toFixed(2);
        document.getElementById('op-opHealth').style.color=hColor(d.opHealth);
        document.getElementById('op-opBar').innerHTML=hBarHtml(d.opHealth);
        document.getElementById('op-bizHealth').textContent=d.bizHealth.toFixed(2);
        document.getElementById('op-bizHealth').style.color=hColor(d.bizHealth);
        document.getElementById('op-bizBar').innerHTML=hBarHtml(d.bizHealth);
        document.getElementById('op-overallHealth').textContent=d.overall.toFixed(2);
        document.getElementById('op-overallHealth').style.color=hColor(d.overall);
        document.getElementById('op-overallBar').innerHTML=hBarHtml(d.overall);
        /* kpis */
        document.getElementById('op-uptime').textContent=d.uptime;
        document.getElementById('op-total-cases').textContent=d.totalCases;
        document.getElementById('op-open-cases').textContent=d.openCases;
        document.getElementById('op-avg-ttr').textContent=d.avgTtr;
        document.getElementById('op-hw-swaps').textContent=d.hwSwaps;
        document.getElementById('op-escalations').textContent=d.escalations;
        /* health chart */
        var m=ml(12);
        SC.healthLine('healthScoreChart',m,[
            {label:'Operational',data:d.opHistory,color:'#3B82F6',width:2,dashed:[6,3]},
            {label:'Business',data:d.bizHistory,color:'#f04e23',width:2,dashed:[6,3]},
            {label:'Overall',data:d.overallHistory,color:'#1a4797',width:3}
        ]);
        /* sites table */
        var sites=genSites(d.sites),tb=document.getElementById('sites-table-body');
        tb.innerHTML=sites.map(function(x){return'<tr><td>'+x.name+'</td><td>'+x.city+'</td><td><span class="badge '+x.health+'">'+x.health+'</span></td><td>'+x.uptime+'%</td><td>'+x.cases+'</td><td>'+x.open+'</td><td>'+x.swaps+'</td><td>'+x.esc+'</td><td>'+x.csat+'%</td><td>'+x.plat+'</td></tr>';}).join('');
    }

    function ml(n){var m=[],now=new Date();for(var i=n-1;i>=0;i--){var d=new Date(now.getFullYear(),now.getMonth()-i,1);m.push(d.toLocaleDateString('en-US',{month:'short',year:'2-digit'}));}return m;}

    function initOp(){
        var m=ml(12);var sel=document.getElementById('customer-select');var d=cust[sel.value];
        if(!d) return;
        SC.healthLine('healthScoreChart',m,[
            {label:'Operational',data:d.opHistory,color:'#3B82F6',width:2,dashed:[6,3]},
            {label:'Business',data:d.bizHistory,color:'#f04e23',width:2,dashed:[6,3]},
            {label:'Overall',data:d.overallHistory,color:'#1a4797',width:3}
        ]);
        SC.bar('caseByProductChart',['XPT/Kiosk','Cashier','Gate','TunnelWatch','Server','XCC','OTT','ARM'],[572,157,119,111,110,57,51,44],SC.c.blue,true);
        SC.line('monthlyCaseChart',m,[85,92,78,95,110,88,76,102,98,115,89,95],SC.c.blue,SC.c.bf);
        SC.line('hardwareSwapsChart',m,[2,1,3,2,4,1,2,3,1,2,3,2],SC.c.orange,SC.c.of);
        SC.line('escalationsChart',m,[1,0.5,2,1,1,2,0.5,1,2,1,0.5,1],SC.c.red,SC.c.rf);
        updateOperationalData();
    }

    function initBoap(){
        var m=ml(24),rv=[],mm=[],cap=[],rtk=[],joins=[],churns=[];
        for(var i=0;i<24;i++){
            rv.push(180-i*3+Math.random()*20);
            mm.push(2400-i*50+Math.random()*100);
            cap.push(28+Math.random()*8);
            rtk.push(10+Math.random()*2.5);
            joins.push(200+Math.random()*120);
            churns.push(140+Math.random()*100);
        }
        SC.bar('boapRevenueChart',m,rv,SC.c.orange,false);
        SC.line('boapMembersChart',m,mm,SC.c.green,SC.c.gf);
        SC.line('boapCaptureChart',m,cap,SC.c.blue,SC.c.bf);
        SC.line('boapRetailTicketChart',m,rtk,SC.c.green,SC.c.gf);
        /* Traffic Breakdown Donut */
        SC.pie('boapTrafficPieChart',[
            {label:'Membership Traffic',value:72,color:SC.c.blue},
            {label:'Single Wash Traffic',value:25,color:SC.c.orange},
            {label:'Prepaids Redeemed',value:3,color:SC.c.green}
        ], true);
        /* New Members vs Churn */
        SC.multiLine('boapJoinsChurnChart',m.slice(12),[
            {label:'ARM Sold',data:joins.slice(12),color:SC.c.green,fill:SC.c.gf},
            {label:'Total Churned',data:churns.slice(12),color:SC.c.red,fill:SC.c.rf}
        ]);
    }

    /* ============================================================
       DEEP DIVE INIT - All tabs
       ============================================================ */
    function initDD(tab){
        var m=ml(24);

        if(tab==='dd-general'){
            var m = ldLabels();
            var r = ld('totalRev', function(){ var a=[]; for(var i=0;i<m.length;i++) a.push(150+Math.random()*50); return a; });
            var ca = ld('carCount', function(){ var a=[]; for(var i=0;i<m.length;i++) a.push(8000+Math.random()*4000); return a; });
            var avgT = ld('retailTicketAvg', function(){ var a=[]; for(var i=0;i<m.length;i++) a.push(26+Math.random()*5); return a; });

            /* Convert revenue to $K for chart display */
            var rK = r.map(function(v){ return LIVE ? v/1000 : v; });

            /* Traffic breakdown */
            var memP = ld('memberTrafficPct', function(){ var a=[]; for(var i=0;i<m.length;i++){ var mp=55+Math.random()*8; a.push(mp*80); } return a; });
            var retP = ld('retailTrafficPct', function(){ var a=[]; for(var i=0;i<m.length;i++) a.push((100-55-3)*80); return a; });
            var ppP  = ld('prepaidTrafficPct', function(){ var a=[]; for(var i=0;i<m.length;i++) a.push(3*80); return a; });

            SC.bar('ddRevenueChart',m,rK,SC.c.orange,false);
            SC.bar('ddCarsChart',m,ca,SC.c.blue,false);
            SC.stackedArea('ddTrafficBreakdownChart',m,[
                {label:'Member',data:memP,color:SC.c.blue},
                {label:'Retail',data:retP,color:SC.c.orange},
                {label:'Prepaid',data:ppP,color:SC.c.green}
            ]);
            SC.line('ddAvgTicketChart',m,avgT,SC.c.green,SC.c.gf);

            /* Update KPI cards if live */
            if(LIVE && D.totals){
                var t = D.totals;
                var genKpis = document.querySelectorAll('#dd-general .kpi-value');
                if(genKpis.length>=4){
                    genKpis[0].textContent = '$'+(t.totalRev/1000000).toFixed(2)+'M';
                    genKpis[1].textContent = (t.carCount/1000).toFixed(0)+'K';
                    genKpis[2].textContent = '$'+t.overallTicketAvg.toFixed(2);
                    genKpis[3].textContent = Math.round(t.armRedeem/t.carCount*100)+'%';
                }
            }
        }

        if(tab==='dd-membership'){
            var m = ldLabels();
            /* Capture vs Churn */
            var cap = ld('captureRate', function(){ var a=[]; for(var i=0;i<m.length;i++) a.push(35+Math.random()*8); return a; });
            var vol = ld('volChurnRate', function(){ var a=[]; for(var i=0;i<m.length;i++) a.push(4.5+Math.random()*3); return a; });
            SC.multiLine('ddCaptureChurnChart',m,[
                {label:'Capture Rate %',data:cap,color:SC.c.green,fill:SC.c.gf},
                {label:'Vol Churn %',data:vol,color:SC.c.red,fill:SC.c.rf}
            ]);
            /* Active Members */
            var am = ld('activeMembers', function(){ var a=[],base=2200; for(var i=0;i<m.length;i++){base+=Math.floor(Math.random()*80-20);a.push(base);} return a; });
            SC.line('ddActiveMembersChart',m,am,SC.c.blue,SC.c.bf);
            /* Joins vs Churn */
            var joins = ld('armSold', function(){ var a=[]; for(var i=0;i<m.length;i++) a.push(250+Math.random()*150); return a; });
            var churns = ld('totalChurned', function(){ var a=[]; for(var i=0;i<m.length;i++) a.push(120+Math.random()*100); return a; });
            SC.multiLine('ddJoinsChurnChart',m,[
                {label:'New Joins',data:joins,color:SC.c.green,fill:SC.c.gf},
                {label:'Total Churned',data:churns,color:SC.c.red,fill:SC.c.rf}
            ]);
            /* Member Revenue */
            var mr = ld('memberRev', function(){ var a=[]; for(var i=0;i<m.length;i++) a.push(70+Math.random()*30); return a; });
            var mrK = mr.map(function(v){ return LIVE ? v/1000 : v; });
            SC.line('ddMemberRevenueChart',m,mrK,SC.c.orange,SC.c.of);

            /* Tenure by Plan - use live plan data if available */
            if(LIVE && D.plans && D.plans.names.length>0){
                SC.bar('ddTenureChart',D.plans.names,D.plans.tenures,SC.c.blue,true);
                SC.bar('ddLtvChart',D.plans.names,D.plans.ltvs,SC.c.green,true);
            } else {
                SC.bar('ddTenureChart',['Basic','Standard','Premium','Ultimate'],[6.2,8.1,10.4,12.8],SC.c.blue,true);
                SC.bar('ddLtvChart',['Basic','Standard','Premium','Ultimate'],[124,210,342,518],SC.c.green,true);
            }

            /* Tenure/LTV KPI cards */
            if(LIVE && D.tenure){
                var tenKpis = document.querySelectorAll('#dd-membership .section-header~.card-grid .kpi-value');
                /* These are in the Tenure & Lifetime Value section */
            }

            /* Cohort Table - use live data if available */
            if(LIVE && D.cohort && D.cohort.labels.length>0){
                buildCohortTableLive(D.cohort);
            } else {
                buildCohortTable();
            }
        }

        if(tab==='dd-retail'){
            var rc=[],rr=[],rt=[];
            for(var i6=0;i6<24;i6++){
                rc.push(3000+Math.random()*1500);
                rr.push(55+Math.random()*25);
                rt.push(16+Math.random()*5);
            }
            SC.bar('ddRetailCarsChart',m,rc,SC.c.blue,false);
            SC.line('ddRetailRevenueChart',m,rr,SC.c.orange,SC.c.of);
            SC.line('ddRetailTicketChart',m,rt,SC.c.green,SC.c.gf);
            /* Package Mix Pie Chart (current month) */
            SC.pie('ddRetailPieChart',[
                {label:'Basic',value:18,color:'#94A3B8'},
                {label:'Standard',value:35,color:SC.c.blue},
                {label:'Premium',value:31,color:SC.c.green},
                {label:'Ultimate',value:16,color:SC.c.purple}
            ]);
        }

        if(tab==='dd-marketing'){
            var mt=[];
            for(var i7=0;i7<24;i7++){mt.push(7000+Math.random()*5000+Math.sin(i7/2)*2000);}
            SC.line('ddMktTrafficChart',m,mt,SC.c.blue,SC.c.bf);
            SC.bar('ddMktDayChart',['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],[1180,1250,1320,1280,1450,1680,1140],SC.c.blue,false);
            /* Seasonal Index */
            SC.bar('ddSeasonalChart',['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],[72,78,95,105,112,118,132,125,110,120,88,75],SC.c.orange,false);
        }

        if(tab==='dd-operations'){
            buildSiteComparison();
            SC.bar('ddOpsSiteRevenueChart',['Site 1','Site 2','Site 3','Site 4','Site 5','Site 6','Site 7','Site 8','Site 9','Site 10','Site 11','Site 12'],[142,128,198,115,135,108,185,122,78,96,72,110],SC.c.orange,false);
            SC.bar('ddOpsSiteCaptureChart',['Site 1','Site 2','Site 3','Site 4','Site 5','Site 6','Site 7','Site 8','Site 9','Site 10','Site 11','Site 12'],[40,36,46,34,42,38,44,35,26,32,28,37],SC.c.blue,false);
            SC.bar('ddOpsCarsPerDayChart',['Site 1','Site 2','Site 3','Site 4','Site 5','Site 6','Site 7','Site 8','Site 9','Site 10','Site 11','Site 12'],[285,248,341,220,268,205,328,234,171,195,163,218],SC.c.green,false);
            SC.bar('ddOpsChurnBySiteChart',['Site 1','Site 2','Site 3','Site 4','Site 5','Site 6','Site 7','Site 8','Site 9','Site 10','Site 11','Site 12'],[5.2,5.8,4.1,6.2,4.8,5.5,3.8,6.0,7.4,6.8,8.1,5.6],SC.c.red,false);
        }

        if(tab==='dd-siteview'){
            buildSiteOverviewTable();
        }
    }

    /* ============================================================
       SITE-BY-SITE OVERVIEW ENGINE
       ============================================================ */
    /* Demo site data modeled after Suds screenshots */
    var svSites = [
        {name:'Time To Shine Car Wash - Ben Sawyer', years:{
            2022:{cars:6877,rev:73376.93,armSold:171,capture:7.51,volChurn:2.60,involChurn:1.26,activeMembers:1453,memPct:63.9},
            2023:{cars:8322,rev:98640.42,armSold:131,capture:5.55,volChurn:3.17,involChurn:2.19,activeMembers:2102,memPct:70.3},
            2024:{cars:10014,rev:119014.24,armSold:286,capture:11.96,volChurn:3.71,involChurn:3.00,activeMembers:2906,memPct:77.0},
            2025:{cars:12840,rev:166418.30,armSold:407,capture:15.18,volChurn:6.08,involChurn:2.37,activeMembers:4250,memPct:81.1}
        },kpis12:{cars:147615,rev:1932030.15,activeMembers:4142,rechTicket:29.07,retTicket:15.55,capture:15.02,volChurn:5.83,involChurn:2.65}},
        {name:'Time To Shine Car Wash - Cane Bay', years:{
            2023:{cars:3098,rev:47062.71,armSold:389,capture:31.16,volChurn:2.81,involChurn:2.35,activeMembers:466,memPct:55.3},
            2024:{cars:8192,rev:92485.85,armSold:309,capture:12.79,volChurn:5.91,involChurn:6.57,activeMembers:1792,memPct:70.8},
            2025:{cars:11580,rev:147938.33,armSold:538,capture:21.62,volChurn:7.97,involChurn:4.40,activeMembers:3488,memPct:80.4}
        },kpis12:{cars:138960,rev:1775259.96,activeMembers:3488,rechTicket:30.12,retTicket:14.80,capture:21.62,volChurn:7.97,involChurn:4.40}},
        {name:'Time To Shine Car Wash - Catoosa', years:{
            2022:{cars:8180,rev:89761.56,armSold:131,capture:4.62,volChurn:3.60,involChurn:2.57,activeMembers:1684,memPct:66.1},
            2023:{cars:8031,rev:89128.73,armSold:105,capture:4.29,volChurn:2.96,involChurn:2.65,activeMembers:1749,memPct:68.3},
            2024:{cars:7407,rev:85377.27,armSold:141,capture:6.43,volChurn:4.12,involChurn:2.53,activeMembers:1742,memPct:74.2},
            2025:{cars:7966,rev:88631.57,armSold:122,capture:4.04,volChurn:3.97,involChurn:2.50,activeMembers:1591,memPct:59.8}
        },kpis12:{cars:95592,rev:1063578.84,activeMembers:1591,rechTicket:28.40,retTicket:15.07,capture:4.04,volChurn:3.97,involChurn:2.50}},
        {name:'Time To Shine Car Wash - Forest Drive', years:{
            2022:{cars:10485,rev:134071.78,armSold:246,capture:5.25,volChurn:4.14,involChurn:5.62,activeMembers:2081,memPct:53.9},
            2023:{cars:10099,rev:131648.54,armSold:200,capture:4.88,volChurn:4.36,involChurn:5.44,activeMembers:2197,memPct:59.3},
            2024:{cars:10076,rev:118965.28,armSold:333,capture:9.65,volChurn:4.61,involChurn:9.93,activeMembers:2773,memPct:67.3},
            2025:{cars:12059,rev:149733.24,armSold:481,capture:15.55,volChurn:5.25,involChurn:6.21,activeMembers:4062,memPct:77.3}
        },kpis12:{cars:144708,rev:1796798.88,activeMembers:4062,rechTicket:28.30,retTicket:15.07,capture:15.55,volChurn:5.25,involChurn:6.21}},
        {name:'Time to Shine Car Wash - Gervais Street', years:{
            2024:{cars:4183,rev:36643.80,armSold:237,capture:17.56,volChurn:10.04,involChurn:12.18,activeMembers:807,memPct:63.4},
            2025:{cars:6698,rev:66335.00,armSold:319,capture:15.45,volChurn:7.91,involChurn:8.80,activeMembers:1652,memPct:69.7}
        },kpis12:{cars:80376,rev:796020.00,activeMembers:1652,rechTicket:27.50,retTicket:14.20,capture:15.45,volChurn:7.91,involChurn:8.80}},
        {name:'Time To Shine Car Wash - Goose Creek', years:{
            2022:{cars:21696,rev:262044.83,armSold:371,capture:6.61,volChurn:3.37,involChurn:3.81,activeMembers:5904,memPct:73.6},
            2023:{cars:17243,rev:237760.16,armSold:347,capture:8.06,volChurn:3.05,involChurn:3.34,activeMembers:5707,memPct:74.7},
            2024:{cars:15665,rev:218681.83,armSold:350,capture:11.27,volChurn:3.07,involChurn:5.90,activeMembers:5787,memPct:81.8},
            2025:{cars:17086,rev:237272.61,armSold:521,capture:17.92,volChurn:4.58,involChurn:4.13,activeMembers:6417,memPct:85.4}
        },kpis12:{cars:205032,rev:2847271.32,activeMembers:6417,rechTicket:28.30,retTicket:15.07,capture:17.92,volChurn:4.58,involChurn:4.13}},
        {name:'Time To Shine Car Wash - Harbison Blvd', years:{
            2023:{cars:3083,rev:34491.37,armSold:124,capture:6.93,volChurn:7.58,involChurn:6.43,activeMembers:342,memPct:28.3},
            2024:{cars:4826,rev:57685.85,armSold:234,capture:11.53,volChurn:7.49,involChurn:12.79,activeMembers:1126,memPct:57.2},
            2025:{cars:6830,rev:80608.43,armSold:324,capture:15.70,volChurn:7.32,involChurn:9.27,activeMembers:1952,memPct:69.9}
        },kpis12:{cars:81960,rev:967301.16,activeMembers:1952,rechTicket:26.80,retTicket:13.90,capture:15.70,volChurn:7.32,involChurn:9.27}},
        {name:'Time To Shine Car Wash - Owasso', years:{
            2022:{cars:21184,rev:217128.20,armSold:352,capture:6.64,volChurn:4.04,involChurn:1.62,activeMembers:4952,memPct:73.4},
            2023:{cars:20465,rev:215042.21,armSold:292,capture:7.21,volChurn:3.19,involChurn:2.12,activeMembers:5208,memPct:78.7},
            2024:{cars:20684,rev:233361.07,armSold:360,capture:10.05,volChurn:3.34,involChurn:2.87,activeMembers:5877,memPct:83.8},
            2025:{cars:22541,rev:269919.90,armSold:524,capture:15.18,volChurn:4.87,involChurn:1.71,activeMembers:6905,memPct:86.6}
        },kpis12:{cars:270492,rev:3239038.80,activeMembers:6905,rechTicket:28.30,retTicket:15.07,capture:15.18,volChurn:4.87,involChurn:1.71}}
    ];

    /* Org-wide averages for site card comparison */
    var svOrgAvg = {cars:184522,rev:2164565.86,activeMembers:2681,rechTicket:28.30,retTicket:15.07,capture:16.35,volChurn:5.37,involChurn:5.52};

    function buildSiteOverviewTable(){
        var tbody = document.getElementById('sv-overview-body');
        if(!tbody) return;
        var html = '';
        for(var i=0;i<svSites.length;i++){
            var s = svSites[i];
            var yrs = Object.keys(s.years).sort();
            /* Site header row */
            html += '<tr style="background:#1a4797;color:white;font-weight:700"><td colspan="9" style="text-align:left;padding:0.5rem 0.75rem">'+s.name+'</td></tr>';
            for(var y=0;y<yrs.length;y++){
                var d = s.years[yrs[y]];
                html += '<tr>';
                html += '<td style="text-align:left;padding-left:2rem;color:#64748B;font-size:0.75rem">'+yrs[y]+'</td>';
                html += '<td>'+d.cars.toLocaleString()+'</td>';
                html += '<td>$'+d.rev.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+'</td>';
                html += '<td>'+d.armSold+'</td>';
                html += svColorCell(d.capture, 12, 8, '%', true);
                html += svColorCell(d.volChurn, 5, 7, '%', false);
                html += svColorCell(d.involChurn, 3, 6, '%', false);
                html += '<td>'+d.activeMembers.toLocaleString()+'</td>';
                html += svColorCell(d.memPct, 70, 50, '%', true);
                html += '</tr>';
            }
        }
        tbody.innerHTML = html;
    }

    function svColorCell(val, goodThresh, badThresh, suffix, higherBetter){
        var bg, fg;
        if(higherBetter){
            if(val >= goodThresh){bg='#D1FAE5';fg='#065F46';}
            else if(val >= badThresh){bg='#FEF3C7';fg='#92400E';}
            else {bg='#FEE2E2';fg='#991B1B';}
        } else {
            if(val <= goodThresh){bg='#D1FAE5';fg='#065F46';}
            else if(val <= badThresh){bg='#FEF3C7';fg='#92400E';}
            else {bg='#FEE2E2';fg='#991B1B';}
        }
        return '<td style="background:'+bg+';color:'+fg+';font-weight:600">'+val.toFixed(2)+(suffix||'')+'</td>';
    }

    function updateSiteView(){
        var v = document.getElementById('sv-view').value;
        document.getElementById('sv-overview-panel').style.display = v==='overview'?'block':'none';
        document.getElementById('sv-card-panel').style.display = v==='card'?'block':'none';
        document.getElementById('sv-site-selector').style.display = v==='card'?'block':'none';
        if(v==='card') updateSiteCard();
    }

    function updateSiteCard(){
        var idx = parseInt(document.getElementById('sv-site').value);
        var s = svSites[idx];
        var k = s.kpis12;
        document.getElementById('sv-card-title').textContent = 'Site Card: ' + s.name.replace(/Time To Shine Car Wash - |Time to Shine Car Wash - /,'');

        /* KPI comparison table */
        var kpiRows = [
            {label:'Total Cars Washed',site:k.cars,org:svOrgAvg.cars,fmt:'num'},
            {label:'Total Revenue',site:k.rev,org:svOrgAvg.rev,fmt:'$'},
            {label:'Active Unlimited Members (Monthly Avg)',site:k.activeMembers,org:svOrgAvg.activeMembers,fmt:'num'},
            {label:'Recharge Ticket',site:k.rechTicket,org:svOrgAvg.rechTicket,fmt:'$2'},
            {label:'Retail Ticket',site:k.retTicket,org:svOrgAvg.retTicket,fmt:'$2'},
            {label:'Capture Rate',site:k.capture,org:svOrgAvg.capture,fmt:'%'},
            {label:'Voluntary Churn Rate',site:k.volChurn,org:svOrgAvg.volChurn,fmt:'%inv'},
            {label:'Involuntary Churn Rate',site:k.involChurn,org:svOrgAvg.involChurn,fmt:'%inv'}
        ];
        var tbody = document.getElementById('sv-card-kpi-body');
        var html = '';
        for(var i=0;i<kpiRows.length;i++){
            var r = kpiRows[i];
            var diff;
            if(r.org !== 0) diff = ((r.site - r.org)/r.org * 100);
            else diff = 0;
            var diffColor = '#64748B';
            /* For churn, lower is better (invert color) */
            if(r.fmt==='%inv'){
                diffColor = diff <= 0 ? '#059669' : '#DC2626';
            } else {
                diffColor = diff >= 0 ? '#059669' : '#DC2626';
            }
            var siteStr, orgStr;
            if(r.fmt==='$'){siteStr='$'+r.site.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});orgStr='$'+r.org.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}
            else if(r.fmt==='$2'){siteStr='$'+r.site.toFixed(2);orgStr='$'+r.org.toFixed(2);}
            else if(r.fmt==='%'||r.fmt==='%inv'){siteStr=r.site.toFixed(2)+'%';orgStr=r.org.toFixed(2)+'%';}
            else{siteStr=r.site.toLocaleString();orgStr=r.org.toLocaleString();}
            html += '<tr><td style="text-align:left;font-weight:600;background:#EFF6FF">'+r.label+'</td>';
            html += '<td style="background:#E0F2FE;font-weight:600">'+siteStr+'</td>';
            html += '<td>'+orgStr+'</td>';
            html += '<td style="color:'+diffColor+';font-weight:700;background:'+(diff>=0&&r.fmt!=='%inv'||diff<=0&&r.fmt==='%inv'?'#D1FAE5':'#FEE2E2')+'">'+((diff>=0?'+':'')+diff.toFixed(2)+'%')+'</td></tr>';
        }
        tbody.innerHTML = html;

        /* Site card charts */
        var yrs = Object.keys(s.years).sort();
        var lastYr = s.years[yrs[yrs.length-1]];
        var memPct = lastYr ? lastYr.memPct : 72;
        SC.pie('svCardTrafficPie',[
            {label:'Membership',value:memPct,color:SC.c.blue},
            {label:'Single Wash',value:100-memPct-2,color:SC.c.orange},
            {label:'Prepaid',value:2,color:SC.c.green}
        ], true);

        /* Joins vs Churn bar */
        var jLabels=[], jData=[], cData=[];
        for(var y2=0;y2<yrs.length;y2++){
            jLabels.push(yrs[y2]);
            jData.push(s.years[yrs[y2]].armSold);
            var vc = s.years[yrs[y2]].volChurn + s.years[yrs[y2]].involChurn;
            cData.push(Math.round(s.years[yrs[y2]].armSold * vc / 100));
        }
        SC.multiLine('svCardJoinsChurnChart',jLabels,[
            {label:'ARM Sold',data:jData,color:SC.c.green,fill:SC.c.gf},
            {label:'Churned',data:cData,color:SC.c.red,fill:SC.c.rf}
        ]);
    }

    /* ============================================================
       ROI & SOLUTIONS ENGINE
       ============================================================ */
    var roiCustomers = {};

    /* If live data is available, build ROI customer from Snowflake totals */
    if(LIVE && D.totals){
        var t = D.totals;
        roiCustomers['live'] = {
            name: D.client || 'Current Customer',
            sites: D.siteCount || 1,
            memberRevMonthly: t.monthlyMemberRev,
            retailRevMonthly: t.monthlyRetailRev,
            captureRate: t.captureRate,
            volChurn: t.volChurnRate,
            involChurn: t.involChurnRate,
            memberCount: D.tenure ? D.tenure.activeMemberCount : Math.round(t.netMember/12),
            retailCars: t.monthlySingleWash,
            avgMemberPrice: D.tenure ? D.tenure.avgMemberPrice : t.rechargeTicketAvg,
            retailTicket: t.retailTicketAvg,
            trafficYoY: 0, /* Would need 24-month query for YoY calc */
            revenueYoY: 0,
            tenure: D.tenure ? D.tenure.avgTenureMonths : 0,
            ltv: D.tenure ? D.tenure.avgLTV : 0,
            healthScore: 0
        };
        /* Update the ROI dropdown to show live customer */
        var roiSel = document.getElementById('roi-customer-select');
        if(roiSel){
            roiSel.innerHTML = '<option value="live">'+(D.client||'Customer')+' ('+D.siteCount+' sites)  LIVE DATA</option>';
        }
    }

    /* Fallback demo customers (used when no Snowflake connection) */
    if(!roiCustomers['live']){
        roiCustomers = {
            sparkle: {
                name: 'Sparkle Clean Auto Spa', sites: 12,
                memberRevMonthly: 89200, retailRevMonthly: 64500,
                captureRate: 31, volChurn: 8.2, involChurn: 4.1,
                memberCount: 2847, retailCars: 3534, avgMemberPrice: 31.50,
                retailTicket: 18.12, trafficYoY: -18, revenueYoY: -18,
                tenure: 8.4, ltv: 265, healthScore: 28
            },
            metro: {
                name: 'Metro Express Wash', sites: 8,
                memberRevMonthly: 72000, retailRevMonthly: 48000,
                captureRate: 35, volChurn: 6.5, involChurn: 3.8,
                memberCount: 1920, retailCars: 2800, avgMemberPrice: 29.99,
                retailTicket: 17.14, trafficYoY: -8, revenueYoY: -10,
                tenure: 9.1, ltv: 290, healthScore: 45
            },
            quick: {
                name: 'Quick Clean Express', sites: 156,
                memberRevMonthly: 1240000, retailRevMonthly: 890000,
                captureRate: 33, volChurn: 7.1, involChurn: 3.5,
                memberCount: 38400, retailCars: 52000, avgMemberPrice: 32.29,
                retailTicket: 17.12, trafficYoY: -12, revenueYoY: -14,
                tenure: 7.8, ltv: 242, healthScore: 38
            }
        };
    }

    var benchmarks = { captureRate: 39, volChurn: 5.5, involChurn: 2.5, retailTicket: 18.00, tenure: 10, ltv: 325 };
    /* Patheon lift factors based on 156-site conversion data */
    var patheonLifts = { memberRevPct: 0.21, retailRevPct: 0.035, volChurnReduction: 0.05, involChurnReduction: 0.13 };

    function fmt$(v){ return v>=1000000?'$'+( v/1000000).toFixed(2)+'M':v>=1000?'$'+(v/1000).toFixed(1)+'K':'$'+v.toFixed(0); }
    function fmtP(v){ return (v>=0?'+':'')+v.toFixed(1)+'%'; }

    function updateROI(){
        var sel = document.getElementById('roi-customer-select');
        var c = roiCustomers[sel.value];
        buildGapCards(c);
        buildRevenueTables(c);
        buildROIChart(c);
        highlightPlatformTable(c);
    }

    function buildGapCards(c){
        var container = document.getElementById('roi-gap-cards');
        var gaps = [];

        if(c.captureRate < benchmarks.captureRate){
            var capGap = benchmarks.captureRate - c.captureRate;
            var potentialNewMembers = Math.round(c.retailCars * (capGap/100));
            var potentialRev = potentialNewMembers * c.avgMemberPrice * 12;
            gaps.push({
                title: 'Low Capture Rate',
                severity: c.captureRate < 30 ? 'critical' : 'warning',
                kpi: c.captureRate+'%', bench: benchmarks.captureRate+'%', gap: capGap.toFixed(1)+' pts below benchmark',
                revenue: fmt$(potentialRev)+'/yr if gap closed',
                solutions: [
                    {tool:'Patheon EWA', desc:'Dynamic pricing displays highlight membership value at point of sale'},
                    {tool:'XPT Kiosk', desc:'On-screen comparison charts and limited-time offers drive impulse sign-ups'},
                    {tool:'Catalyst', desc:'Drip campaigns nurture retail visitors into members via text, email & app'},
                    {tool:'LPR / FastPass', desc:'Identify frequent retail visitors and serve personalized membership offers'}
                ],
                icon:'&#9888;'
            });
        }

        if(c.volChurn > benchmarks.volChurn){
            var churnGap = c.volChurn - benchmarks.volChurn;
            var savedMembers = Math.round(c.memberCount * (churnGap/100));
            var savedRev = savedMembers * c.avgMemberPrice * 12;
            gaps.push({
                title: 'High Voluntary Churn',
                severity: c.volChurn > 7 ? 'critical' : 'warning',
                kpi: c.volChurn+'%', bench: benchmarks.volChurn+'%', gap: churnGap.toFixed(1)+' pts above benchmark',
                revenue: fmt$(savedRev)+'/yr in retained revenue',
                solutions: [
                    {tool:'Plan Management', desc:'Flexible pause, downgrade & seasonal options reduce cancellations'},
                    {tool:'Milestone Recognition', desc:'Celebrate membership anniversaries & wash counts to build loyalty'},
                    {tool:'Catalyst Communications', desc:'Re-engagement campaigns target at-risk members before they cancel'},
                    {tool:'Multi-Vehicle Plans', desc:'Increase household share of wallet and raise switching costs'}
                ],
                icon:'&#9660;'
            });
        }

        if(c.involChurn > benchmarks.involChurn){
            var invGap = c.involChurn - benchmarks.involChurn;
            var invSaved = Math.round(c.memberCount * (invGap/100));
            var invSavedRev = invSaved * c.avgMemberPrice * 12;
            gaps.push({
                title: 'High Involuntary Churn',
                severity: c.involChurn > 3.5 ? 'critical' : 'warning',
                kpi: c.involChurn+'%', bench: benchmarks.involChurn+'%', gap: invGap.toFixed(1)+' pts above benchmark',
                revenue: fmt$(invSavedRev)+'/yr recoverable',
                solutions: [
                    {tool:'Automated Payment Recovery', desc:'Smart retry logic & card updater services recapture failed payments'},
                    {tool:'Text & Email Alerts', desc:'Notify members of expiring cards and payment issues before they churn'},
                    {tool:'Patheon ARM Billing', desc:'Advanced recurring billing engine with higher success rates than SiteWatch'}
                ],
                icon:'&#9888;'
            });
        }

        if(c.trafficYoY < -5){
            gaps.push({
                title: 'Declining Traffic',
                severity: c.trafficYoY < -12 ? 'critical' : 'warning',
                kpi: c.trafficYoY+'% YoY', bench: '+5% YoY', gap: Math.abs(c.trafficYoY - 5)+' pts below benchmark',
                revenue: 'Compounds all other revenue gaps',
                solutions: [
                    {tool:'Catalyst Marketing', desc:'Targeted promotions, seasonal campaigns & referral programs drive traffic'},
                    {tool:'Loyalty Points', desc:'Earn & redeem points system creates repeat visit incentives'},
                    {tool:'Pay As You Go', desc:'Proxy membership usage drives incremental retail visits via Patheon EWA'},
                    {tool:'Digital Marketing Integration', desc:'Opt-in collection for SMS/email campaigns to dormant customers'}
                ],
                icon:'&#9660;'
            });
        }

        var html = '';
        for(var i=0;i<gaps.length;i++){
            var g = gaps[i];
            html += '<div class="card" style="border-left:4px solid '+(g.severity==='critical'?'var(--drb-red)':'var(--drb-orange)')+';margin-bottom:1rem;padding:1.25rem">';
            html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:1rem">';
            html += '<div style="flex:1;min-width:280px">';
            html += '<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem"><span style="font-size:1.1rem">'+g.icon+'</span><span style="font-weight:700;font-size:1rem;color:var(--gray-800)">'+g.title+'</span><span class="badge '+g.severity+'">'+(g.severity==='critical'?'CRITICAL':'WARNING')+'</span></div>';
            html += '<div style="display:flex;gap:2rem;margin-bottom:0.75rem;flex-wrap:wrap">';
            html += '<div><span style="font-size:0.7rem;color:var(--gray-500);text-transform:uppercase">Current</span><div style="font-size:1.5rem;font-weight:700;color:'+(g.severity==='critical'?'var(--drb-red)':'var(--drb-orange)')+'">'+g.kpi+'</div></div>';
            html += '<div><span style="font-size:0.7rem;color:var(--gray-500);text-transform:uppercase">Benchmark</span><div style="font-size:1.5rem;font-weight:700;color:var(--drb-green)">'+g.bench+'</div></div>';
            html += '<div><span style="font-size:0.7rem;color:var(--gray-500);text-transform:uppercase">Gap</span><div style="font-size:1rem;font-weight:600;color:var(--gray-700);margin-top:0.35rem">'+g.gap+'</div></div>';
            html += '<div><span style="font-size:0.7rem;color:var(--gray-500);text-transform:uppercase">Revenue Impact</span><div style="font-size:1rem;font-weight:600;color:var(--drb-green);margin-top:0.35rem">'+g.revenue+'</div></div>';
            html += '</div></div>';
            html += '<div style="flex:1;min-width:320px;background:var(--gray-50);border-radius:0.75rem;padding:1rem">';
            html += '<div style="font-size:0.7rem;font-weight:600;color:var(--drb-orange);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem">Recommended Patheon &amp; DRB Solutions</div>';
            for(var j=0;j<g.solutions.length;j++){
                var s = g.solutions[j];
                html += '<div style="margin-bottom:0.4rem;font-size:0.85rem"><strong style="color:var(--drb-navy)">'+s.tool+':</strong> <span style="color:var(--gray-600)">'+s.desc+'</span></div>';
            }
            html += '</div></div></div>';
        }

        if(gaps.length===0){
            html = '<div class="card" style="border-left:4px solid var(--drb-green);padding:1.5rem;text-align:center"><span style="font-size:1.5rem;color:var(--drb-green)">&#10003;</span><br><strong>This customer is performing at or above benchmarks across all key metrics.</strong><br><span style="color:var(--gray-500)">Focus on scaling and optimization with Patheon&rsquo;s advanced tools.</span></div>';
        }

        container.innerHTML = html;
    }

    function buildRevenueTables(c){
        var memLift = c.memberRevMonthly * patheonLifts.memberRevPct;
        var memNew = c.memberRevMonthly + memLift;
        var retLift = c.retailRevMonthly * patheonLifts.retailRevPct;
        var retNew = c.retailRevMonthly + retLift;
        var volChurnNew = c.volChurn * (1 - patheonLifts.volChurnReduction);
        var involChurnNew = c.involChurn * (1 - patheonLifts.involChurnReduction);
        var savedVol = Math.round(c.memberCount * ((c.volChurn - volChurnNew)/100));
        var savedInvol = Math.round(c.memberCount * ((c.involChurn - involChurnNew)/100));
        var churnSavedRev = (savedVol + savedInvol) * c.avgMemberPrice * 12;

        document.getElementById('roi-membership-body').innerHTML =
            '<tr><td style="font-weight:600">Monthly Membership Revenue</td><td>'+fmt$(c.memberRevMonthly)+'</td><td style="font-weight:600">'+fmt$(memNew)+'</td><td style="color:var(--drb-green);font-weight:700">+'+fmt$(memLift)+'</td></tr>'+
            '<tr><td style="font-weight:600">Annual Membership Revenue</td><td>'+fmt$(c.memberRevMonthly*12)+'</td><td style="font-weight:600">'+fmt$(memNew*12)+'</td><td style="color:var(--drb-green);font-weight:700">+'+fmt$(memLift*12)+'</td></tr>';

        document.getElementById('roi-retail-body').innerHTML =
            '<tr><td style="font-weight:600">Monthly Retail Revenue</td><td>'+fmt$(c.retailRevMonthly)+'</td><td style="font-weight:600">'+fmt$(retNew)+'</td><td style="color:var(--drb-green);font-weight:700">+'+fmt$(retLift)+'</td></tr>'+
            '<tr><td style="font-weight:600">Annual Retail Revenue</td><td>'+fmt$(c.retailRevMonthly*12)+'</td><td style="font-weight:600">'+fmt$(retNew*12)+'</td><td style="color:var(--drb-green);font-weight:700">+'+fmt$(retLift*12)+'</td></tr>';

        document.getElementById('roi-churn-body').innerHTML =
            '<tr><td style="font-weight:600">Voluntary Churn Rate</td><td>'+c.volChurn+'%</td><td style="font-weight:600">'+volChurnNew.toFixed(1)+'%</td><td style="color:var(--drb-green);font-weight:700">-'+((c.volChurn-volChurnNew).toFixed(1))+' pts</td></tr>'+
            '<tr><td style="font-weight:600">Involuntary Churn Rate</td><td>'+c.involChurn+'%</td><td style="font-weight:600">'+involChurnNew.toFixed(1)+'%</td><td style="color:var(--drb-green);font-weight:700">-'+((c.involChurn-involChurnNew).toFixed(1))+' pts</td></tr>'+
            '<tr><td style="font-weight:600">Members Saved / Month</td><td>&mdash;</td><td style="font-weight:600">'+(savedVol+savedInvol)+' members</td><td style="color:var(--drb-green);font-weight:700">'+fmt$(churnSavedRev)+'/yr value</td></tr>';

        document.getElementById('roi-total-mem').textContent = '+'+fmt$(memLift*12);
        document.getElementById('roi-total-ret').textContent = '+'+fmt$(retLift*12);
        document.getElementById('roi-total-churn').textContent = '+'+fmt$(churnSavedRev);
        var combined = memLift*12 + retLift*12 + churnSavedRev;
        document.getElementById('roi-total-combined').textContent = '+'+fmt$(combined);
    }

    function highlightPlatformTable(c){
        var rows = {retail:'roi-row-retail', membership:'roi-row-membership', churn:'roi-row-churn'};
        /* reset */
        for(var k in rows){var el=document.getElementById(rows[k]);if(el)el.style.background='';}
        if(c.captureRate<benchmarks.captureRate || c.trafficYoY<-5)document.getElementById('roi-row-retail').style.background='#FEF2F2';
        if(c.captureRate<benchmarks.captureRate)document.getElementById('roi-row-membership').style.background='#FEF2F2';
        if(c.volChurn>benchmarks.volChurn||c.involChurn>benchmarks.involChurn)document.getElementById('roi-row-churn').style.background='#FEF2F2';
    }

    function buildROIChart(c){
        var memLiftMo = c.memberRevMonthly * patheonLifts.memberRevPct;
        var retLiftMo = c.retailRevMonthly * patheonLifts.retailRevPct;
        var volChurnNew = c.volChurn * (1 - patheonLifts.volChurnReduction);
        var involChurnNew = c.involChurn * (1 - patheonLifts.involChurnReduction);
        var savedMo = (Math.round(c.memberCount*((c.volChurn-volChurnNew)/100)) + Math.round(c.memberCount*((c.involChurn-involChurnNew)/100))) * c.avgMemberPrice;
        var totalLiftMo = memLiftMo + retLiftMo + savedMo;
        var investPerSite = 25000;
        var monthlyPerSite = 756;
        var totalInvest = c.sites * investPerSite;
        var sitesPerMonth = Math.max(2, Math.ceil(c.sites / 6));

        var labels=[], cumRev=[], cumCost=[], cumNet=[];
        var rSum=0, cSum=totalInvest*0.3; /* 30% upfront */
        for(var mo=1;mo<=12;mo++){
            labels.push('M'+mo);
            var liveSites = Math.min(c.sites, sitesPerMonth * mo);
            var pct = liveSites / c.sites;
            rSum += totalLiftMo * pct;
            cSum += (mo<=1 ? totalInvest*0.7/3 : mo<=3 ? totalInvest*0.7/3 : 0) + liveSites * monthlyPerSite;
            cumRev.push(rSum);
            cumCost.push(cSum);
            cumNet.push(rSum - cSum);
        }

        var cv = SC.ctx('roiTimelineChart'); if(!cv) return;
        var w=cv._w, h=cv._h;
        var allVals = cumRev.concat(cumCost).concat(cumNet);
        var mx=Math.max.apply(null,allVals)*1.15;
        var mn=Math.min.apply(null,allVals)*1.15;
        if(mn>0)mn=0;
        var rng=mx-mn;
        var pad={t:30,r:20,b:50,l:70},cw=w-pad.l-pad.r,ch=h-pad.t-pad.b;
        cv.clearRect(0,0,w,h);
        cv.font='11px -apple-system,sans-serif';

        for(var g=0;g<=4;g++){
            var gy=h-pad.b-(ch*g/4);
            var val=mn+(rng*g/4);
            cv.strokeStyle=SC.c.grid;cv.lineWidth=1;cv.beginPath();cv.moveTo(pad.l,gy);cv.lineTo(w-pad.r,gy);cv.stroke();
            cv.fillStyle=SC.c.lbl;cv.textAlign='right';cv.textBaseline='middle';
            cv.fillText(val>=1000000?(val/1000000).toFixed(1)+'M':val>=1000?(val/1000).toFixed(0)+'K':Math.round(val),pad.l-8,gy);
        }

        function drawL(data,color,dashed){
            var pts=[];
            for(var i=0;i<data.length;i++){pts.push({x:pad.l+(i/(data.length-1))*cw,y:h-pad.b-((data[i]-mn)/rng)*ch});}
            cv.beginPath();
            if(dashed)cv.setLineDash([6,4]);else cv.setLineDash([]);
            for(var k=0;k<pts.length;k++){if(k===0)cv.moveTo(pts[k].x,pts[k].y);else cv.lineTo(pts[k].x,pts[k].y);}
            cv.strokeStyle=color;cv.lineWidth=2.5;cv.stroke();cv.setLineDash([]);
            for(var m=0;m<pts.length;m++){cv.beginPath();cv.arc(pts[m].x,pts[m].y,3,0,Math.PI*2);cv.fillStyle=color;cv.fill();cv.strokeStyle='white';cv.lineWidth=1.5;cv.stroke();}
        }

        /* fill net area */
        var netPts=[];
        for(var i=0;i<cumNet.length;i++){netPts.push({x:pad.l+(i/(cumNet.length-1))*cw,y:h-pad.b-((cumNet[i]-mn)/rng)*ch});}
        var zeroY=h-pad.b-((0-mn)/rng)*ch;
        cv.beginPath();cv.moveTo(netPts[0].x,zeroY);
        for(var j=0;j<netPts.length;j++)cv.lineTo(netPts[j].x,netPts[j].y);
        cv.lineTo(netPts[netPts.length-1].x,zeroY);cv.closePath();
        cv.fillStyle='rgba(16,185,129,0.12)';cv.fill();

        /* zero line */
        cv.beginPath();cv.moveTo(pad.l,zeroY);cv.lineTo(w-pad.r,zeroY);cv.strokeStyle='#94A3B8';cv.lineWidth=1;cv.setLineDash([4,4]);cv.stroke();cv.setLineDash([]);

        drawL(cumRev, SC.c.green, false);
        drawL(cumCost, SC.c.red, true);
        drawL(cumNet, SC.c.blue, false);

        /* labels */
        for(var n=0;n<labels.length;n++){
            var lx=pad.l+(n/(labels.length-1))*cw;
            cv.fillStyle=SC.c.lbl;cv.textAlign='center';cv.textBaseline='top';cv.fillText(labels[n],lx,h-pad.b+8);
        }
        /* legend */
        var lx2=pad.l+10;
        var legs=[{l:'Cumulative Revenue Lift',c:SC.c.green},{l:'Cumulative Investment',c:SC.c.red},{l:'Net ROI',c:SC.c.blue}];
        for(var lg=0;lg<legs.length;lg++){
            cv.fillStyle=legs[lg].c;cv.fillRect(lx2,8,14,10);
            cv.fillStyle=SC.c.lbl;cv.textAlign='left';cv.textBaseline='top';cv.fillText(legs[lg].l,lx2+18,6);
            lx2+=cv.measureText(legs[lg].l).width+38;
        }
    }

    function initROI(){ updateROI(); }

    function buildCohortTableLive(cohort){
        var tbody=document.getElementById('cohort-body');
        if(!tbody) return;
        var rows='';
        for(var r=0;r<cohort.labels.length;r++){
            var label = cohort.labels[r];
            var joined = cohort.joined[r];
            rows+='<tr><td style="font-weight:600;text-align:left">'+label+'</td><td style="font-weight:600">'+joined+'</td>';
            for(var c=0;c<12;c++){
                var ret = cohort.retention[r] ? cohort.retention[r][c+1] : null;
                if(ret !== null && ret !== undefined){
                    var bg,fg;
                    if(ret>=80){bg='#D1FAE5';fg='#065F46';}
                    else if(ret>=60){bg='#DBEAFE';fg='#1E40AF';}
                    else if(ret>=40){bg='#FEF3C7';fg='#92400E';}
                    else{bg='#FEE2E2';fg='#991B1B';}
                    rows+='<td class="cohort-cell" style="background:'+bg+';color:'+fg+';font-weight:600;font-size:0.8rem">'+ret+'%</td>';
                } else {
                    rows+='<td style="color:#CBD5E1">-</td>';
                }
            }
            rows+='</tr>';
        }
        tbody.innerHTML=rows;
    }

    function buildCohortTable(){
        var tbody=document.getElementById('cohort-body');
        if(!tbody) return;
        var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var now=new Date();
        var rows='';
        for(var r=0;r<8;r++){
            var md=new Date(now.getFullYear(),now.getMonth()-11+r,1);
            var label=months[md.getMonth()]+' '+String(md.getFullYear()).slice(2);
            var joined=Math.floor(200+Math.random()*200);
            rows+='<tr><td style="font-weight:600;text-align:left">'+label+'</td><td style="font-weight:600">'+joined+'</td>';
            var maxCols=12-r;
            for(var c=0;c<12;c++){
                if(c<maxCols){
                    var ret=Math.max(15,Math.round(100-c*8-Math.random()*5));
                    var bg,fg;
                    if(ret>=80){bg='#D1FAE5';fg='#065F46';}
                    else if(ret>=60){bg='#DBEAFE';fg='#1E40AF';}
                    else if(ret>=40){bg='#FEF3C7';fg='#92400E';}
                    else{bg='#FEE2E2';fg='#991B1B';}
                    rows+='<td class="cohort-cell" style="background:'+bg+';color:'+fg+';font-weight:600;font-size:0.8rem">'+ret+'%</td>';
                } else {
                    rows+='<td style="color:#CBD5E1">-</td>';
                }
            }
            rows+='</tr>';
        }
        tbody.innerHTML=rows;
    }

    function buildSiteComparison(){
        var tbody=document.getElementById('site-comparison-body');
        if(!tbody) return;
        var sites=[
            {name:'Site 1',cars:8550,rev:'$142K',ticket:'$16.62',cap:'40%',churn:'5.2%',memPct:'62%',rank:3,status:'healthy'},
            {name:'Site 2',cars:7440,rev:'$128K',ticket:'$17.20',cap:'36%',churn:'5.8%',memPct:'55%',rank:5,status:'info'},
            {name:'Site 3',cars:10240,rev:'$198K',ticket:'$19.34',cap:'46%',churn:'4.1%',memPct:'68%',rank:1,status:'healthy'},
            {name:'Site 4',cars:6600,rev:'$115K',ticket:'$17.42',cap:'34%',churn:'6.2%',memPct:'52%',rank:8,status:'warning'},
            {name:'Site 5',cars:8040,rev:'$135K',ticket:'$16.79',cap:'42%',churn:'4.8%',memPct:'64%',rank:4,status:'healthy'},
            {name:'Site 6',cars:6480,rev:'$108K',ticket:'$16.67',cap:'38%',churn:'5.5%',memPct:'58%',rank:7,status:'info'},
            {name:'Site 7',cars:9850,rev:'$185K',ticket:'$18.78',cap:'44%',churn:'3.8%',memPct:'66%',rank:2,status:'healthy'},
            {name:'Site 8',cars:7320,rev:'$122K',ticket:'$16.67',cap:'35%',churn:'6.0%',memPct:'54%',rank:6,status:'info'},
            {name:'Site 9',cars:5120,rev:'$78K',ticket:'$15.23',cap:'26%',churn:'7.4%',memPct:'42%',rank:11,status:'critical'},
            {name:'Site 10',cars:5850,rev:'$96K',ticket:'$16.41',cap:'32%',churn:'6.8%',memPct:'48%',rank:9,status:'warning'},
            {name:'Site 11',cars:4890,rev:'$72K',ticket:'$14.72',cap:'28%',churn:'8.1%',memPct:'40%',rank:12,status:'critical'},
            {name:'Site 12',cars:6540,rev:'$110K',ticket:'$16.82',cap:'37%',churn:'5.6%',memPct:'57%',rank:10,status:'info'}
        ];
        tbody.innerHTML=sites.map(function(s){
            return '<tr><td style="font-weight:600">'+s.name+'</td><td>'+s.cars.toLocaleString()+'</td><td>'+s.rev+'</td><td>'+s.ticket+'</td><td>'+s.cap+'</td><td>'+s.churn+'</td><td>'+s.memPct+'</td><td>#'+s.rank+'</td><td><span class="badge '+s.status+'">'+(s.status==='critical'?'Below Avg':s.status==='warning'?'Watch':s.status==='healthy'?'Strong':'On Track')+'</span></td></tr>';
        }).join('');
    }
    /* CONFIG TAB SWITCHING */
    function switchCfgTab(tabId, btn) {
        var tabs = document.querySelectorAll('.cfg-tab');
        for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
        var panels = document.querySelectorAll('.cfg-panel');
        for (var i = 0; i < panels.length; i++) { panels[i].classList.remove('active'); panels[i].style.display = 'none'; }
        btn.classList.add('active');
        var target = document.getElementById(tabId);
        if (target) { target.classList.add('active'); target.style.display = 'block'; }
    }

    /* OVERALL WEIGHT SLIDER */
    function updateOverallWeights() {
        var opW = parseInt(document.getElementById('overall-op-weight').value);
        var bizW = 100 - opW;
        document.getElementById('overall-op-weight-val').textContent = opW + '%';
        document.getElementById('overall-biz-weight-val').textContent = bizW + '%';
        document.getElementById('overall-biz-weight').value = bizW;
        document.getElementById('formula-op').textContent = (opW / 100).toFixed(2);
        document.getElementById('formula-biz').textContent = (bizW / 100).toFixed(2);
    }

    /* ADD KPI ROW */
    function addKpiRow(tableId) {
        var tbody = document.getElementById(tableId).querySelector('tbody');
        var tr = document.createElement('tr');
        tr.innerHTML = '<td><input type="text" value="" placeholder="KPI Name" class="cfg-input" style="width:100%"></td>'
            + '<td><input type="number" value="0" class="cfg-input cfg-weight" min="0" max="100" style="width:60px">%</td>'
            + '<td><select class="cfg-input"><option value="lower">Lower &#9660;</option><option value="higher">Higher &#9650;</option></select></td>'
            + '<td><input type="text" value="" placeholder="e.g. < 5" class="cfg-input" style="width:100%"></td>'
            + '<td><input type="text" value="" placeholder="e.g. 5 - 10" class="cfg-input" style="width:100%"></td>'
            + '<td><input type="text" value="" placeholder="e.g. > 10" class="cfg-input" style="width:100%"></td>'
            + '<td style="text-align:center"><span class="badge info" style="font-size:0.75rem">&mdash;</span></td>'
            + '<td><button class="btn-icon" onclick="this.closest(\'tr\').remove();updateWeightTotals()" title="Remove">&times;</button></td>';
        tbody.appendChild(tr);
        /* attach weight listener */
        tr.querySelector('.cfg-weight').addEventListener('input', updateWeightTotals);
        updateWeightTotals();
    }

    /* WEIGHT TOTAL TRACKING */
    function updateWeightTotals() {
        calcTableWeight('op-kpi-table', 'op-total-weight', 'op-weight-status');
        calcTableWeight('biz-kpi-table', 'biz-total-weight', 'biz-weight-status');
    }
    function calcTableWeight(tableId, totalId, statusId) {
        var tbl = document.getElementById(tableId);
        if (!tbl) return;
        var inputs = tbl.querySelectorAll('.cfg-weight');
        var sum = 0;
        for (var i = 0; i < inputs.length; i++) sum += parseInt(inputs[i].value) || 0;
        var el = document.getElementById(totalId);
        var st = document.getElementById(statusId);
        if (el) el.textContent = sum;
        if (st) {
            if (sum === 100) { st.innerHTML = '<span style="color:#10B981">&#10003; Weights sum to 100%</span>'; }
            else if (sum > 100) { st.innerHTML = '<span style="color:#EF4444">&#10007; Over by ' + (sum - 100) + '%</span>'; }
            else { st.innerHTML = '<span style="color:#F59E0B">&#9888; Under by ' + (100 - sum) + '%</span>'; }
        }
    }

    /* SAVE / RESET CONFIG */
    function saveHealthConfig() {
        var opW = parseInt(document.getElementById('overall-op-weight').value);
        var bizW = 100 - opW;
        /* Gather KPI definitions */
        var opKpis = gatherKpis('op-kpi-table');
        var bizKpis = gatherKpis('biz-kpi-table');
        var config = { opWeight: opW / 100, bizWeight: bizW / 100, opKpis: opKpis, bizKpis: bizKpis };
        window.__healthConfig = config;
        console.log('Health config saved:', JSON.stringify(config, null, 2));
        /* Visual confirmation */
        var btn = event.target;
        var orig = btn.textContent;
        btn.textContent = '\u2713 Configuration Saved';
        btn.style.background = '#10B981';
        setTimeout(function(){ btn.textContent = orig; btn.style.background = '#1a4797'; }, 2000);
    }
    function gatherKpis(tableId) {
        var rows = document.getElementById(tableId).querySelectorAll('tbody tr');
        var kpis = [];
        for (var i = 0; i < rows.length; i++) {
            var inputs = rows[i].querySelectorAll('input');
            var selects = rows[i].querySelectorAll('select');
            kpis.push({
                name: inputs[0] ? inputs[0].value : '',
                weight: inputs[1] ? (parseInt(inputs[1].value) || 0) : 0,
                direction: selects[0] ? selects[0].value : 'lower',
                healthy: inputs[2] ? inputs[2].value : '',
                atRisk: inputs[3] ? inputs[3].value : '',
                critical: inputs[4] ? inputs[4].value : ''
            });
        }
        return kpis;
    }
    function resetHealthConfig() {
        if (!confirm('Reset all health score configuration to defaults?')) return;
        location.reload();
    }

    /* Attach weight listeners to existing rows */
    document.querySelectorAll('.cfg-weight').forEach(function(inp){
        inp.addEventListener('input', updateWeightTotals);
    });
    /* Attach remove buttons */
    document.querySelectorAll('#op-kpi-table .btn-icon, #biz-kpi-table .btn-icon').forEach(function(btn){
        btn.addEventListener('click', function(){ setTimeout(updateWeightTotals, 50); });
    });

    /* ORG/SITE AUTOCOMPLETE */
    function showOrgSuggestions(){ filterOrgSuggestions(); document.getElementById('org-suggestions').style.display='block'; }
    function hideOrgSuggestions(){ setTimeout(function(){ document.getElementById('org-suggestions').style.display='none'; },200); }
    function filterOrgSuggestions(){
        var q=document.getElementById('org-search').value.toLowerCase();
        var box=document.getElementById('org-suggestions');
        var matches=orgSiteLookup.filter(function(o){ return o.code.toLowerCase().indexOf(q)>=0 || o.label.toLowerCase().indexOf(q)>=0; });
        box.innerHTML=matches.map(function(o){
            return '<div class="org-item" onclick="selectOrg(\''+o.key+'\',\''+o.code+'\',\''+o.label.replace(/'/g,"\\\\'")+'\')"><div><strong>'+o.label+'</strong></div><div style="display:flex;gap:8px;align-items:center"><span class="org-code">'+o.code+'</span><span class="org-type '+(o.type==='org'?'org-tag':'site-tag')+'">'+o.type+'</span></div></div>';
        }).join('');
        if(matches.length===0) box.innerHTML='<div style="padding:12px;color:var(--gray-500);font-size:0.85rem">No matching org or site codes</div>';
    }
    function selectOrg(key, code, label){
        document.getElementById('org-search').value=code+' - '+label.split('(')[0].trim();
        document.getElementById('customer-select').value=key;
        document.getElementById('org-suggestions').style.display='none';
        updateOperationalData();
        initOp();
    }
    document.getElementById('org-search').addEventListener('blur', hideOrgSuggestions);

    /* DATE PICKER DEFAULTS */
    (function(){
        var now=new Date();
        var end=now.toISOString().split('T')[0];
        var start=new Date(now.getFullYear(),now.getMonth()-1,now.getDate()).toISOString().split('T')[0];
        var ds=document.getElementById('date-start'), de=document.getElementById('date-end');
        if(ds) ds.value=start;
        if(de) de.value=end;
    })();

    /* Set default search field value */
    document.getElementById('org-search').value='BMW-001 - BMW Kar Wash LLC';

    /* SELF-TEST: confirm script executed */
    (function(){
        var t=document.getElementById('current-date');
        if(t) t.textContent=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
        console.log('DRB Pulse: All scripts loaded successfully. SC engine:', typeof SC, 'initOp:', typeof initOp);
    })();
    </script>
</body>
</html>
